Index: opt/gemeinschaft/htdocs/gui/mod/calls_missed.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/mod/calls_missed.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/mod/calls_missed.php	(working copy)
@@ -28,8 +28,9 @@
 
 defined('GS_VALID') or die('No direct access.');
 require_once( GS_DIR .'inc/util.php' );
+require_once( GS_DIR .'inc/gs-fns/gs_asterisks_reload.php' );
+require_once( GS_DIR .'inc/gs-fns/gs_user_watchedmissed.php' );
 
-
 echo '<h2>';
 if (@$MODULES[$SECTION]['icon'])
 	echo '<img alt=" " src="', GS_URL_PATH, str_replace('%s', '32', $MODULES[$SECTION]['icon']), '" /> ';
@@ -46,16 +47,16 @@
 $page = (int)@$_REQUEST['page'];
 $type = 'missed';
 
+$delete = (int)@$_REQUEST['delete'];
 
-if (@$_REQUEST['action'] === 'del') {
-	$del_type = @$_REQUEST['type'];
-	if ($del_type === $type) {
-		$del_number = @$_REQUEST['number'];
-		$DB->execute( 'DELETE FROM `dial_log` WHERE `user_id`='. ((int)@$_SESSION['sudo_user']['info']['id']) .' AND `type`=\''. $DB->escape($type) .'\' AND `number`=\''. $DB->escape($del_number) .'\'' );
-	}
+if ( $delete == 1 ) {
+	$DB->execute(
+'UPDATE `dial_log` 
+	SET `read` = 2
+	WHERE `type` = \'missed\' AND 
+	`user_id` = ' . (int)@$_SESSION['sudo_user']['info']['id'] );
 }
 
-
 $rs = $DB->execute(
 'SELECT SQL_CALC_FOUND_ROWS
 	MAX(`d`.`timestamp`) `ts`, `d`.`number`, `d`.`remote_name`,
@@ -64,6 +65,7 @@
 	`dial_log` `d` LEFT JOIN
 	`users` `u` ON (`u`.`id`=`d`.`remote_user_id`)
 WHERE
+	`d`.`read` < 2 AND
 	`d`.`user_id`='. (int)@$_SESSION['sudo_user']['info']['id'] .' AND
 	`d`.`type`=\''. $DB->escape($type) .'\' AND
 	`d`.`timestamp`>'. (time()-GS_PROV_DIAL_LOG_LIFE) .' AND
@@ -83,8 +85,8 @@
 <tr>
 	<th style="width:140px;"><?php echo __('Nummer'); ?></th>
 	<th style="width:210px;"><?php echo __('Name'); ?></th>
-	<th style="width:120px;"><span class="sort-col"><?php echo __('Datum'); ?></span></th>
-	<th style="width:100px;"><?php echo __('Seite'), ' ', ($page+1), ' / ', $num_pages; ?></th>
+	<th style="width:100px;"><span class="sort-col"><?php echo __('Datum'); ?></span></th>
+	<th style="width:120px;"><?php echo __('Seite'), ' ', ($page+1), ' / ', $num_pages; ?></th>
 </tr>
 </thead>
 <tbody>
@@ -112,6 +114,12 @@
 	'<img alt="', __('weiter'), '" src="', GS_URL_PATH, 'crystal-svg/32/act/forward-cust-dis.png" />', "\n";
 }
 
+if ( $num_total > 0 )
+	echo
+	'<a href="', gs_url($SECTION, $MODULE, null, 'delete=1&page='. $page), '" title="', __('l&ouml;schen'), '" id="arr-prev">',
+	'<img alt="', __('l&ouml;schen'), '" src="', GS_URL_PATH, 'crystal-svg/32/devices/trashcan_full.png" />',
+	'</a>', "\n";
+
 ?>
 	</td>
 </tr>
@@ -122,8 +130,10 @@
 	$i = 0;
 	while ($r = $rs->fetchRow()) {
 		echo '<tr class="'. ((++$i % 2 == 0) ? 'even':'odd') .'">';
-		echo '<td>', htmlEnt($r['number']), '</td>';
-		
+		if($r['number'] != '')
+			echo '<td>', htmlEnt($r['number']), '</td>';
+		else
+			echo '<td>', htmlEnt('Unbekannt'), '</td>';		
 		if (! $r['r_uid'])
 			$name = $r['remote_name'];
 		else {
@@ -150,7 +160,12 @@
 		echo '</tr>', "\n";
 	}
 }
+gs_user_watchedmissed($_SESSION['sudo_user']['info']['id'], 'user');
 
+if ( GS_BUTTONDAEMON_USE == true ) {
+	gs_buttondeamon_missedcalls( @$_SESSION['sudo_user']['info']['ext']);
+}
+
 ?>
 
 </tbody>
Index: opt/gemeinschaft/htdocs/gui/mod/keys_snom.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/mod/keys_snom.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/mod/keys_snom.php	(working copy)
@@ -1,286 +0,0 @@
-<?php
-/*******************************************************************\
-*            Gemeinschaft - asterisk cluster gemeinschaft
-* 
-* $Revision$
-* 
-* Copyright 2007, amooma GmbH, Bachstr. 126, 56566 Neuwied, Germany,
-* http://www.amooma.de/
-* Stefan Wintermeyer <stefan.wintermeyer@amooma.de>
-* Philipp Kempgen <philipp.kempgen@amooma.de>
-* Peter Kozak <peter.kozak@amooma.de>
-* 
-* This program is free software; you can redistribute it and/or
-* modify it under the terms of the GNU General Public License
-* as published by the Free Software Foundation; either version 2
-* of the License, or (at your option) any later version.
-* 
-* This program is distributed in the hope that it will be useful,
-* but WITHOUT ANY WARRANTY; without even the implied warranty of
-* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-* GNU General Public License for more details.
-* 
-* You should have received a copy of the GNU General Public License
-* along with this program; if not, write to the Free Software
-* Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
-* MA 02110-1301, USA.
-\*******************************************************************/
-
-defined('GS_VALID') or die('No direct access.');
-
-
-echo '<h2>';
-if (@$MODULES[$SECTION]['icon'])
-	echo '<img alt=" " src="', GS_URL_PATH, str_replace('%s', '32', $MODULES[$SECTION]['icon']), '" /> ';
-if (count( $MODULES[$SECTION]['sub'] ) > 1 )
-	echo $MODULES[$SECTION]['title'], ' - ';
-echo $MODULES[$SECTION]['sub'][$MODULE]['title'];
-echo '</h2>', "\n";
-
-
-
-
-
-if (@$_REQUEST['action']=='save') {
-	
-	$keys = gs_keys_snom_get( $_SESSION['sudo_user']['name'] );
-	if (isGsError($keys)) {
-		echo __('Fehler beim Abfragen.'), '<br />', $keys->getMsg();
-		die();
-	}
-	if (! is_array($keys)) {
-		echo __('Fehler beim Abfragen.');
-		die();
-	}
-	
-	foreach ($_REQUEST as $k => $v) {
-		if (subStr($k, 0, 4) != 'key-') continue;
-		$kname = subStr($k, 4);
-		if (! preg_match('/^f\d{1,2}$/S', $kname)) continue;
-		if (! array_key_exists($kname, $keys)) continue;
-		if (! @$keys[$kname]['rw']) continue;
-		$v = preg_replace('/[^\d*#]/S', '', $v);
-		if ($v === @$keys[$kname]['val']) continue;
-		//echo "set $kname = $v\n";
-		if ($v != '')
-			$DB->execute( 'REPLACE INTO `softkeys` (`user_id`, `phone`, `key`, `number`) VALUES ('. (int)@$_SESSION['sudo_user']['info']['id'] .', \'snom\', \''. $DB->escape($kname) .'\', \''. $DB->escape($v) .'\')' );
-		else
-			$DB->execute( 'DELETE FROM `softkeys` WHERE `user_id`='. (int)@$_SESSION['sudo_user']['info']['id'] .' AND `phone`=\'snom\' AND `key`=\''. $DB->escape($kname) .'\'' );
-	}
-	
-}
-
-
-
-
-
-$keys = gs_keys_snom_get( $_SESSION['sudo_user']['name'] );
-if (isGsError($keys)) {
-	echo __('Fehler beim Abfragen.'), '<br />', $keys->getMsg();
-	die();
-}
-if (! is_array($keys)) {
-	echo __('Fehler beim Abfragen.');
-	die();
-}
-
-
-?>
-
-
-<div class="fr">
-	<?php echo __('Ver&auml;nderungen werden erst dann aktiv, sobald Sie Ihr Telefon neu gestartet haben!'); ?>
-</div>
-<br style="clear:right;" />
-<br />
-
-
-<form method="post" action="<?php echo gs_url($SECTION, $MODULE); ?>">
-<input type="hidden" name="action" value="save" />
-
-<table cellspacing="1">
-<thead>
-<tr>
-	<th style="width:70px;" class="quickchars">&nbsp;</th>
-	<th style="width:340px;"><?php echo __('Tastenbelegung'); ?></th>
-	<th style="width:70px;" class="quickchars">&nbsp;</th>
-</tr>
-</thead>
-<tbody>
-
-<?php
-
-$left = 0;
-$right = 6;
-for ($i=0; $i<12; ++$i) {
-	echo '<tr class="', ($i%2 ? 'even':'odd'), '">', "\n";
-	
-	$knum = ($i%2 ? $left : $right);
-	
-	$keyv = 'P'. str_replace(' ', '&nbsp;', str_pad($knum+1, 2, ' ', STR_PAD_LEFT));
-	
-	echo '<td', ($i%2 ? '':' style="background:transparent;"'), '>';
-	if ($i % 2)
-		echo '<img alt=" " src="', GS_URL_PATH, 'img/snom_fkleft_off.gif" /> ', $keyv;
-	else
-		echo '&nbsp;';
-	echo '</td>', "\n";
-	
-	echo '<td class="', ($i%2 ? 'l':'r'), '">', "\n";
-	$keyinfo = @$keys['f'.$knum];
-	if (! is_array($keyinfo)) $keyinfo = array();
-	$val = @$keyinfo['val'];
-	/*
-	if (preg_match('/:([^@]*)@/', $val, $m)) {
-		# i.e. "dest <sip:*800001@192.168.1.130>"
-		$val = $m[1];
-	}
-	*/
-	if (preg_match('/^\\*8/', $val, $m)) {
-		$val = 'PickUp';
-	}
-	
-	if (@$keyinfo['rw'])
-		echo '<input type="text" name="key-f', $knum, '" value="', htmlEnt($val), '" size="25" class="', ($i%2 ? 'l':'r'), '" maxlength="22" style="width:150px;" tabindex="', 5+$knum, '" />';
-	else
-		echo '<input type="text" name="key-f', $knum, '" value="', htmlEnt($val), '" size="25" class="', ($i%2 ? 'l':'r'), '" maxlength="22" style="width:150px;" tabindex="', 5+$knum, '" disabled="disabled" readonly="readonly" />';
-	echo '</td>', "\n";
-	
-	echo '<td class="r"', ($i%2 ? ' style="background:transparent;"':''), '>';
-	if (!($i % 2))
-		echo $keyv, ' <img alt=" " src="', GS_URL_PATH, 'img/snom_fkright_off.gif" />';
-	else
-		echo '&nbsp;';
-	echo '</td>', "\n";
-	
-	echo '</tr>', "\n";
-	
-	if ($i % 2) ++$left;
-	else ++$right;
-}
-
-?>
-
-</tbody>
-</table>
-
-<button type="submit" class="fr">
-	<img alt=" " src="<?php echo GS_URL_PATH; ?>crystal-svg/16/act/filesave.png" />
-	<?php echo __('Speichern'); ?>
-</button>
-<br class="nofloat" />
-
-
-
-
-<div id="keys-snom-expansion-toggle" style="display:none; cursor:pointer; color:#00a;" href="" onclick="toggle_expansion();return false;">
-Expansion Module
-</div>
-
-<div id="keys-snom-expansion">
-<?php
-for ($row=0; $row<2; ++$row) {
-?>
-<br />
-<table cellspacing="1">
-<thead>
-<tr>
-	<th style="width:70px;" class="quickchars">&nbsp;</th>
-	<th style="width:340px;"><?php echo __('Tastenbelegung');
-	if     ($row==0) echo ' &nbsp; P 13 - 32';
-	elseif ($row==1) echo ' &nbsp; P 33 - 54';
-	?></th>
-	<th style="width:70px;" class="quickchars">&nbsp;</th>
-</tr>
-</thead>
-<tbody>
-
-<?php
-
-if     ($row==0) { $left = 12; $right = 23; }
-elseif ($row==1) { $left = 33; $right = 44; }
-
-for ($i=12; $i<33; ++$i) {
-	echo '<tr class="', ($i%2 ? 'even':'odd'), '">', "\n";
-	
-	$knum = ($i%2==0 ? $left : $right);
-	
-	$keyv = 'P'. str_replace(' ', '&nbsp;', str_pad($knum+1, 2, ' ', STR_PAD_LEFT));
-	
-	echo '<td', ($i%2==0 ? '':' style="background:transparent;"'), '>';
-	if ($i%2==0)
-		echo '<img alt=" " src="', GS_URL_PATH, 'img/snom_fkleft_off.gif" /> ', $keyv;
-	else
-		echo '&nbsp;';
-	echo '</td>', "\n";
-	
-	echo '<td class="', ($i%2==0 ? 'l':'r'), '">', "\n";
-	$keyinfo = @$keys['f'.$knum];
-	if (! is_array($keyinfo)) $keyinfo = array();
-	$val = @$keyinfo['val'];
-	/*
-	if (preg_match('/:([^@]*)@/', $val, $m)) {
-		# i.e. "dest <sip:*800001@192.168.1.130>"
-		$val = $m[1];
-	}
-	*/
-	if (@$keyinfo['rw'])
-		echo '<input type="text" name="key-f', $knum, '" value="', htmlEnt($val), '" size="25" class="', ($i%2==0 ? 'l':'r'), '" maxlength="22" style="width:150px;" tabindex="', 5+$knum, '" />';
-	else
-		echo '<input type="text" name="key-f', $knum, '" value="', htmlEnt($val), '" size="25" class="', ($i%2==0 ? 'l':'r'), '" maxlength="22" style="width:150px;" tabindex="', 5+$knum, '" disabled="disabled" readonly="readonly" />';
-	echo '</td>', "\n";
-	
-	echo '<td class="r"', ($i%2==0 ? ' style="background:transparent;"':''), '>';
-	if ($i%2)
-		echo $keyv, ' <img alt=" " src="', GS_URL_PATH, 'img/snom_fkright_off.gif" />';
-	else
-		echo '&nbsp;';
-	echo '</td>', "\n";
-	
-	echo '</tr>', "\n";
-	
-	if ($i%2==0) ++$left;
-	else ++$right;
-}
-
-?>
-
-</tbody>
-</table>
-
-<button type="submit" class="fr">
-	<img alt=" " src="<?php echo GS_URL_PATH; ?>crystal-svg/16/act/filesave.png" />
-	<?php echo __('Speichern'); ?>
-</button>
-<br class="nofloat" />
-
-<?php
-}
-?>
-</div>
-
-</form>
-
-
-
-<script type="text/javascript">
-
-window.onload = function()
-{
-	var el = document.getElementById('keys-snom-expansion');
-	el.style.display = 'none';
-	var el = document.getElementById('keys-snom-expansion-toggle');
-	el.style.display = 'block';
-};
-
-function toggle_expansion()
-{
-	var el = document.getElementById('keys-snom-expansion');
-	if (el.style.display == 'block') {
-		el.style.display = 'none';
-	} else {
-		el.style.display = 'block';
-	}
-}
-
-</script>
Index: opt/gemeinschaft/htdocs/gui/mod/admin_queues.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/mod/admin_queues.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/mod/admin_queues.php	(working copy)
@@ -384,7 +384,7 @@
 <table cellspacing="1">
 <thead>
 <tr>
-	<th style="width:75px;"><?php echo __('Queue'); ?> <small>&darr;</small></th>
+	<th style="width:100px;"><?php echo __('Warteschlange'); ?> <small>&darr;</small></th>
 	<th style="width:150px;"><?php echo __('Bezeichnung'); ?></th>
 	<th style="width:50px;"><?php echo __('L&auml;nge'); ?></th>
 	<th style="width:135px;"><?php echo __('Host'); ?></th>
Index: opt/gemeinschaft/htdocs/gui/mod/system_nodesmon.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/mod/system_nodesmon.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/mod/system_nodesmon.php	(working copy)
@@ -76,6 +76,7 @@
 		$nodes[$ip] = array();
 	}
 	$nodes[$ip]['host_id' ] = $host['id'];
+	$nodes[$ip]['hostname' ] = $host['hostname'];
 	$nodes[$ip]['comment' ] = $host['comment'];
 	$nodes[$ip]['active'  ] = true;
 	$nodes[$ip]['watchdog'] = false;
@@ -100,6 +101,7 @@
 <table cellspacing="1" class="phonebook">
 <thead>
 <tr>
+        <th style="width:100px;"><?php echo __('Hostname'); ?></th>
 	<th style="width:100px;"><?php echo __('IP (stat.)'); ?></th>
 	<th style="width:100px;"><?php echo __('IP (dyn.)'); ?> <sup>[1]</sup></th>
 	<th style="width:85px;"><?php echo __('Kommentar'); ?></th>
@@ -129,6 +131,7 @@
 	
 	foreach ($nodes as $ip => $node) {
 		echo '<tr class="', (++$i%2 ? 'odd':'even'), '">';
+		echo '<td>', htmlEnt( @$node['hostname'] ), '</td>';
 		echo '<td>', htmlEnt( @$node['static_ip'] ), '</td>';
 		echo '<td>', htmlEnt( $ip ), '</td>';
 		echo '<td>', htmlEnt( @$node['comment'] ), '</td>';
Index: opt/gemeinschaft/htdocs/gui/mod/forwards_forwards.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/mod/forwards_forwards.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/mod/forwards_forwards.php	(working copy)
@@ -27,15 +27,12 @@
 \*******************************************************************/
 
 defined('GS_VALID') or die('No direct access.');
-include_once( GS_DIR .'inc/gs-fns/gs_callforward_activate.php' );
+include_once( GS_DIR .'inc/gs-fns/gs_user_get.php' );
 include_once( GS_DIR .'inc/gs-fns/gs_callforward_get.php' );
 include_once( GS_DIR .'inc/gs-fns/gs_callforward_set.php' );
-include_once( GS_DIR .'inc/gs-fns/gs_user_email_address_get.php' );
-include_once( GS_DIR .'inc/gs-fns/gs_user_email_notify_get.php' );
-include_once( GS_DIR .'inc/gs-fns/gs_user_email_notify_set.php' );
-include_once( GS_DIR .'inc/gs-fns/gs_vm_activate.php' );
+include_once( GS_DIR .'inc/gs-fns/gs_callforward_activate.php' );
 include_once( GS_DIR .'inc/gs-fns/gs_vm_get.php' );
-include_once( GS_DIR .'inc/gs-fns/gs_user_external_numbers_get.php' );
+include_once( GS_DIR .'inc/gs-fns/gs_vm_activate.php' );
 
 echo '<h2>';
 if (@$MODULES[$SECTION]['icon'])
@@ -56,33 +53,33 @@
 $cases = array(
 	'always' => __('immer'),
 	'busy'   => __('besetzt'),
-	'unavail'=> __('keine Antw.'),
+	'unavail'=> __('keine Antwort'),
 	//'offline'=> __('offline/DND'),
-	'offline'=> __('abgemeldet')
+	'offline'=> __('offline')
 );
 $actives = array(
 	'no'  => '-',
 	'std' => __('Std.'),
-	'var' => __('Tmp.'),
-	'vml' => __('AB'  )
+	'var' => __('Tmp.')
 );
 
-$show_email_notification = ! @$_SESSION['sudo_user']['info']['host_is_foreign'];
 
 
 
 $warnings = array();
 
-if (@$_REQUEST['action']==='save') {
+if (@$_REQUEST['action']=='save') {
 	
 	$num_std = preg_replace('/[^\d]/', '', @$_REQUEST['num-std']);
 	$num_var = preg_replace('/[^\d]/', '', @$_REQUEST['num-var']);
-	//$num_vml = 'vm'. $_SESSION['sudo_user']['info']['ext'];
 	$timeout = abs((int)@$_REQUEST['timeout']);
+	$mailnotify = @$_REQUEST['mailnotify'];
+	if($mailnotify == 'on')gs_user_mailnotify_set( $_SESSION['sudo_user']['name'],1);
+	else gs_user_mailnotify_set( $_SESSION['sudo_user']['name'],0);
 	if ($timeout < 1) $timeout = 1;
 	
-	if ($num_std=='')
-		$warnings['std-empty'] = __('Sie sollten eine Std.-Umleitungsnummer angeben! Sie wird f&uuml;r die Nicht-St&ouml;ren-Funktion am Telefon ben&ouml;tigt.');
+	if ($num_std=='' && (GS_BUTTONDAEMON_USE == false))
+		$warnings['std-empty'] = __('Bitte tragen Sie eine Rufnummer als Zielrufnummer Standard (Std.) ein! Diese wird für die Nicht-St&ouml;ren-Funktion (DND) am Telefon ben&ouml;tigt');
 	
 	foreach ($sources as $src => $ignore) {
 		foreach ($cases as $case => $gnore2) {
@@ -94,17 +91,6 @@
 				$src, $case, 'var', $num_var, $timeout );
 			if (isGsError($ret))
 				$warnings['var'] = __('Fehler beim Setzen der Tempor&auml;ren Umleitungsnummer') .' ('. $ret->getMsg() .')';
-			
-			if (@$_REQUEST[$src.'-'.$case] === 'vmln') {
-				$num_vml = 'vm*'. $_SESSION['sudo_user']['info']['ext'];
-				$_REQUEST[$src.'-'.$case] = 'vml';
-			} else {
-				$num_vml = 'vm' . $_SESSION['sudo_user']['info']['ext'];
-			}
-			$ret = gs_callforward_set( $_SESSION['sudo_user']['name'],
-				$src, $case, 'vml', $num_vml, $timeout );
-			if (isGsError($ret))
-				$warnings['vml'] = __('Fehler beim Setzen der AB-Nummer') .' ('. $ret->getMsg() .')';
 			$ret = gs_callforward_activate( $_SESSION['sudo_user']['name'],
 				$src, $case, @$_REQUEST[$src.'-'.$case] );
 			if (isGsError($ret))
@@ -112,31 +98,13 @@
 		}
 	}
 	
-	/*
-	$vm_internal = (bool)@$_REQUEST['vm-internal'];
-	$vm_external = (bool)@$_REQUEST['vm-external'];
-	$ret = gs_vm_activate( $_SESSION['sudo_user']['name'], 'internal', $vm_internal );
-	if (isGsError($ret))
-		$warnings['vm_act_i'] = __('Fehler beim (De-)Aktivieren des Anrufbeantworters von intern') .' ('. $ret->getMsg() .')';
-	$ret = gs_vm_activate( $_SESSION['sudo_user']['name'], 'external', $vm_external );
-	if (isGsError($ret))
-		$warnings['vm_act_e'] = __('Fehler beim (De-)Aktivieren des Anrufbeantworters von extern') .' ('. $ret->getMsg() .')';
-	*/
-	
-	if ($show_email_notification) {
-		$email_address = gs_user_email_address_get( $_SESSION['sudo_user']['name'] );
-		$email_notify = @$_REQUEST['email_notify'];
-		if ($email_address == '') $email_notify = 'off';
-		switch ($email_notify) {
-			case 'on' : $email_notify = 1; break;
-			case 'off':
-			default   : $email_notify = 0;
-		}
-		$ret = gs_user_email_notify_set( $_SESSION['sudo_user']['name'], $email_notify );
-		if (isGsError($ret))
-			$warnings['vm_email_n'] = __('Fehler beim (De-)Aktivieren der E-Mail-Benachrichtigung') .' ('. $ret->getMsg() .')';
-	}
-	
+	$vm_internal = $_REQUEST['vm-internal'];
+	$vm_external = $_REQUEST['vm-external'];
+	gs_vm_activate( $_SESSION['sudo_user']['name'], 'internal', $vm_internal );
+	gs_vm_activate( $_SESSION['sudo_user']['name'], 'external', $vm_external );
+	if ( GS_BUTTONDAEMON_USE == true ) {
+		gs_buttondeamon_diversion_update( $_SESSION['sudo_user']['info']['ext']);
+	}	
 }
 
 
@@ -169,8 +137,8 @@
 		}
 	}
 }
-if ($number_std=='')
-	$warnings['std-empty'] = __('Sie sollten eine Std.-Umleitungsnummer angeben! Sie wird f&uuml;r die Nicht-St&ouml;ren-Funktion am Telefon ben&ouml;tigt.');
+if ($number_std=='' && (GS_BUTTONDAEMON_USE == false))
+	$warnings['std-empty'] = __('Bitte tragen Sie eine Rufnummer als Zielrufnummer Standard (Std.) ein! Diese wird für die Nicht-St&ouml;ren-Funktion (DND) am Telefon ben&ouml;tigt.');
 
 # find best match for var number
 #
@@ -192,25 +160,9 @@
 	}
 }
 
-# find best match for unavail timeout
-#
-if ( @$callforwards['internal']['unavail']['active'] != 'no'
-  && @$callforwards['external']['unavail']['active'] != 'no' )
-{
-	$timeout = ceil((
-		(int)@$callforwards['internal']['unavail']['timeout'] +
-		(int)@$callforwards['external']['unavail']['timeout']
-	)/2);
-} elseif (@$callforwards['internal']['unavail']['active'] != 'no') {
-	$timeout = (int)@$callforwards['internal']['unavail']['timeout'];
-} elseif (@$callforwards['external']['unavail']['active'] != 'no') {
-	$timeout = (int)@$callforwards['external']['unavail']['timeout'];
-} else {
-	$timeout = 15;
-}
 
+$timeout = (int)@$callforwards['external']['unavail']['timeout']; 
 
-/*
 # get vm states
 #
 $vm = gs_vm_get( $_SESSION['sudo_user']['name'] );
@@ -218,7 +170,6 @@
 	echo __('Fehler beim Abfragen.'), '<br />', $vm->getMsg();
 	return;  # return to parent file
 }
-*/
 
 
 
@@ -232,156 +183,94 @@
 </div>
 <?php
 }
-
-
-$e_numbers = gs_user_external_numbers_get( $_SESSION['sudo_user']['name'] );
-
 ?>
 
-<script type="text/javascript">
-//<![CDATA[
-function gs_num_sel( el )
-{
-try {
-	if (el.value == '') return;
-	switch (el.id) {
-		case 'sel-num-std': var text_el_id = 'ipt-num-std'; break;
-		case 'sel-num-var': var text_el_id = 'ipt-num-var'; break;
-		default: return;
-	}
-	document.getElementById(text_el_id).value = el.value;
-	//el.value = '';
-} catch(e){}
-}
-//]]>
-</script>
-
 <form method="post" action="<?php echo gs_url($SECTION, $MODULE); ?>">
 <input type="hidden" name="action" value="save" />
 
 <table cellspacing="1">
 <thead>
 <tr>
-	<th colspan="2"><?php echo __('Umleitungsnummern'); ?></th>
+	<th colspan="6"><?php echo __('Ziele f&uuml;r Anrufumleitung'); ?></th>
 </tr>
 </thead>
 <tbody>
 <tr class="even">
-	<td style="width:157px;"><?php echo __('Standardnummer'); ?></td>
-	<td style="width:392px;">
-		<input type="text" name="num-std" id="ipt-num-std" value="<?php echo htmlEnt($number_std); ?>" size="25" style="width:200px;" maxlength="25" />
-		<div id="ext-num-select-std" style="display:none;">
-		&larr;<select name="_ignore-1" id="sel-num-std" onchange="gs_num_sel(this);">
-<?php
-	if (! isGsError($e_numbers) && is_array($e_numbers)) {
-		echo '<option value="">', __('einf&uuml;gen &hellip;') ,'</option>' ,"\n";
-		foreach ($e_numbers as $e_number) {
-			echo '<option value="0', htmlEnt($e_number) ,'">0', htmlEnt($e_number) ,'</option>' ,"\n";
-		}
-	}
-?>
-		</select>
-		</div>
-		<?php /* <small>(<?php echo __('nicht leer!'); ?>)</small> */ ?>
+	<td  colspan="2"><?php echo __('Zielrufnummer Standard (Std.)'); ?></td>
+	<td  colspan="4">
+		<input type="text" name="num-std" value="<?php echo htmlEnt($number_std); ?>" size="30" style="width:220px;" maxlength="25" />
+		<small><?php 
+				if ($number_std=='' && (GS_BUTTONDAEMON_USE == false)){
+					echo '(';
+					echo __('Bitte Rufnummer eintragen!');
+					echo ')';
+				}
+				else{
+					echo '&nbsp;';
+				} 
+			
+			?>
+			
+		</small>
 	</td>
 </tr>
 <tr class="even">
-	<td><?php echo __('Tempor&auml;re Nummer'); ?></td>
-	<td>
-		<input type="text" name="num-var" id="ipt-num-var" value="<?php echo htmlEnt($number_var); ?>" size="25" style="width:200px;" maxlength="25" />
-		<div id="ext-num-select-var" style="display:none;">
-		&larr;<select name="_ignore-2" id="sel-num-var" onchange="gs_num_sel(this);">
-<?php
-	if (! isGsError($e_numbers) && is_array($e_numbers)) {
-		echo '<option value="">', __('einf&uuml;gen &hellip;') ,'</option>' ,"\n";
-		foreach ($e_numbers as $e_number) {
-			echo '<option value="0', htmlEnt($e_number) ,'">0', htmlEnt($e_number) ,'</option>' ,"\n";
-		}
-	}
-?>
-		</select>
-		</div>
+	<td colspan="2"><?php echo __('Zielrufnummer tempor&auml;r (Tmp.)'); ?></td>
+	<td colspan="4">
+		<input type="text" name="num-var" value="<?php echo htmlEnt($number_var); ?>" size="30" style="width:220px;" maxlength="25" />
 	</td>
 </tr>
-</tbody>
-</table>
 
-<script type="text/javascript">
-//<![CDATA[
-// show selectors if javascript is available
-try { document.getElementById('ext-num-select-std').style.display = 'inline'; } catch(e){}
-try { document.getElementById('ext-num-select-var').style.display = 'inline'; } catch(e){}
-//]]>
-</script>
-
 <br />
-
-<table cellspacing="1">
+<tr>
+	<td colspan="6" class="quickchars"><br />
+		</td>
+		</tr>
 <thead>
 <tr>
-	<th colspan="5"><?php echo __('Umleiten in folgenden F&auml;llen'); ?></th>
-<?php /* <th>&nbsp;</th> */ ?>
+	<th colspan="6"><?php echo __('Umleiten in folgenden F&auml;llen'); ?></th>
 </tr>
 </thead>
 <tbody>
 <tr class="even">
-	<td style="width:110px;">&nbsp;</td>
+	<td style="width:92px;">&nbsp;</td>
 <?php
-
 foreach ($cases as $case => $ctitle) {
 	echo '<td style="width:100px;">', $ctitle, '</td>', "\n";
 }
-//echo '<td style="width:80px;">', __('AB'), '</td>', "\n";
+echo '<td style="width:90px;">', __('Mailbox'), '</td>', "\n";
 
 ?>
 </tr>
 <?php
 foreach ($sources as $src => $srctitle) {
 	echo '<tr>';
-	echo '<td>', __('von'), ' ', $srctitle, '</td>';
+	echo '<td style="width:90px;">', __('von'), ' ', $srctitle, '</td>';
 	
 	foreach ($cases as $case => $ctitle) {
 		echo '<td>';
 		echo '<select name="', $src, '-', $case, '" />', "\n";
 		foreach ($actives as $active => $atitle) {
-			if ($active === 'vml') {
-				echo '<option value="', $active, '"';
-				if ($callforwards[$src][$case]['active'] === $active
-				&&  substr($callforwards[$src][$case]['number_vml'],0,3) !== 'vm*')
-					echo ' selected="selected"';
-				echo '>', $atitle, '</option>', "\n";
-				
-				echo '<option value="', 'vmln' , '"';
-				if ($callforwards[$src][$case]['active'] === $active
-				&&  substr($callforwards[$src][$case]['number_vml'],0,3) === 'vm*')
-					echo ' selected="selected"';
-				echo '>', __('Ansage') ,'</option>', "\n";
-			}
-			else {
-				echo '<option value="', $active, '"';
-				if ($callforwards[$src][$case]['active'] === $active)
-					echo ' selected="selected"';
-				echo '>', $atitle, '</option>', "\n";
-			}
+			$s = ($callforwards[$src][$case]['active'] == $active) ? ' selected="selected"' : '';
+			echo '<option value="', $active, '"', $s, '>', $atitle, '</option>', "\n";
 		}
 		echo '</select>';
 		echo '</td>', "\n";
 	}
 	
-	/*
 	echo '<td>';
 	echo '<select name="vm-', $src, '" />', "\n";
-	echo '<option value="1"', ( $vm[$src .'_active'] ? ' selected="selected"' : ''), '>', __('An'), '</option>', "\n";
-	echo '<option value="0"', (!$vm[$src .'_active'] ? ' selected="selected"' : ''), '>', __('Aus'), '</option>', "\n";
+	echo '<option value="1"', $s, ($vm[$src .'_active'] ? ' selected="selected"' : ''), '>', __('Immer an'), '</option>', "\n";
+	echo '<option value="2"', $s, ($vm[$src .'_active'] == 2 ? ' selected="selected"' : ''), ($src == 'internal' ? ' disabled' : ''), '>', __('Wenn keine Antwort'), '</option>', "\n";
+	echo '<option value="0"', $s, (!$vm[$src .'_active'] ? ' selected="selected"' : ''), '>', __('Immer aus'), '</option>', "\n";
 	echo '</select>';
 	echo '</td>', "\n";
-	*/
 	
 	echo '</tr>', "\n";
 }
-
-$email_notify = (int)gs_user_email_notify_get( $_SESSION['sudo_user']['name'] );
-$email_address = gs_user_email_address_get( $_SESSION['sudo_user']['name'] );
+$mailnotify = false;
+if((int)gs_user_mailnotify_get( $_SESSION['sudo_user']['name'] ) == 1)$mailnotify = true;
+$emailaddress = gs_user_emailaddress_get( $_SESSION['sudo_user']['name'] );
 ?>
 
 <tr>
@@ -390,64 +279,46 @@
 		<?php echo __('nach'); ?>
 		<input type="text" name="timeout" value="<?php echo $timeout; ?>" size="3" maxlength="3" class="r" />&nbsp;s
 	</td>
-	<td colspan="1">&nbsp;</td>
-<?php /* <td colspan="1">&nbsp;</td> */ ?>
+	<td colspan="2">&nbsp;</td>
 </tr>
 <tr>
-<?php /*
-	<td colspan="6" class="transp">
-		<small><?php echo __('Achtung: Ihr Anrufbeantworter wird nur dann aktiv, wenn Sie keine Weiterleitung eingestellt haben.'); ?></small>
+	<td colspan="6" class="quickchars">
+		<small><?php echo __('Achtung: Ihre Mailbox wird nur dann aktiv, wenn Sie keine Weiterleitung eingestellt haben.'); ?></small>
 	</td>
-*/ ?>
 </tr>
-</tbody>
-</table>
-
-<?php if ($show_email_notification) { ?>
-<br />
-<table cellspacing="1">
+<tr>
+	<td colspan="6" class="quickchars"><br />
+	</td>
+</tr>
 <thead>
 <tr>
-	<th colspan="6"><?php echo __('E-Mail-Benachrichtigung bei eingehenden Sprach-Nachrichten'); ?></th>
+	<th colspan="6"><?php echo __('Email-Benachrichtigung von eingehenden Voicemails'); ?></th>
 </tr>
 </thead>
 <tbody>
-<tr>
-	<td style="width:140px;"><?php echo __('E-Mail-Adresse'); ?></td>
-	<td style="width:409px;">
-		<input type="text" name="email_address" value="<?php echo htmlEnt($email_address); ?>" size="40" maxlength="50" disabled="disabled" />
+<tr class="odd">
+	<td><?php echo __('Email-Adresse'); ?></td>
+	<td   colspan="6" >
+		<input type="text" name="emailaddress"  value="<?php echo htmlEnt($emailaddress); ?>" size="30"  disabled />
 	</td>
 </tr>
-<tr>
-	<td><?php echo __('Benachrichtigung'); ?></td>
-	<td>
-<?php
-	$disabled = ($email_address == '');
-	if ($disabled) $email_notify = false;
+<tr class="odd">
+	<td><?php echo __('Status'); ?></td>
+	<td   colspan="6" >
+	<?php
 	
-	echo '<input type="radio" name="email_notify" value="on" id="ipt-email_notify-on"';
-	if ($email_notify) echo ' checked="checked"';
-	if ($disabled) echo ' disabled="disabled"';
-	echo ' />';
-	echo '<label for="ipt-email_notify-on">', __('an') ,'</label>' ,"\n";
+	if($emailaddress == '')echo '<select name="mailnotify" disabled/>', "\n";
+	else echo '<select name="mailnotify" />', "\n";
+	echo '<option value="on"', ($mailnotify ? ' selected="selected"' : ''), '>', __('An'), '</option>', "\n";
+	echo '<option value="off"',(!$mailnotify ? ' selected="selected"' : ''), '>', __('Aus'), '</option>', "\n";
+	echo '</select>';
+	?>
 	
-	echo '<input type="radio" name="email_notify" value="off" id="ipt-email_notify-off"';
-	if (! $email_notify) echo ' checked="checked"';
-	if ($disabled) echo ' disabled="disabled"';
-	echo ' />';
-	echo '<label for="ipt-email_notify-off">', __('aus') ,'</label>' ,"\n";
-?>
 	</td>
 </tr>
-</tbody>
-</table>
-<?php } ?>
-
-<br />
-<table cellspacing="1">
-<tbody>
 <tr>
-	<td style="width:562px;" class="transp r">
+	<td colspan="6" class="quickchars r">
+		<br />
 		<button type="submit">
 			<img alt=" " src="<?php echo GS_URL_PATH; ?>crystal-svg/16/act/filesave.png" />
 			<?php echo __('Speichern'); ?>
@@ -458,3 +329,4 @@
 </table>
 
 </form>
+
Index: opt/gemeinschaft/htdocs/gui/mod/monitor_queues.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/mod/monitor_queues.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/mod/monitor_queues.php	(working copy)
@@ -267,6 +267,9 @@
 			
 			if (strToUpper(subStr($interface,0,4))=='SIP/')
 				$interface = subStr($interface,4);
+			if(preg_match("/^Local\/([\d]+)[@]to-gguser$/", $interface, $treffer)){
+				$interface = $treffer[1];
+			}
 			echo '<td>', htmlEnt($interface), '</td>';
 			//$sudo_url = (@$_SESSION['sudo_user']['name'] == @$_SESSION['real_user']['name'])
 			//	? '' : ('&amp;sudo='. @$_SESSION['sudo_user']['name']);
Index: opt/gemeinschaft/htdocs/gui/mod/routing_gws-sip.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/mod/routing_gws-sip.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/mod/routing_gws-sip.php	(working copy)
@@ -102,7 +102,7 @@
 	`title` = \''. $DB->escape(trim(@$_REQUEST['gw-title'])) .'\',
 	`allow_out` = '. (@$_REQUEST['gw-allow_out'] ? 1 : 0) .',
 	`dialstr` = \''. $DB->escape( 'SIP/{number}@{gateway}' ) .'\',
-	`host` = \''. $DB->escape(preg_replace('/[^a-zA-Z0-9\-_.]/', '', @$_REQUEST['gw-host'])) .'\',
+	`host` = \''. $DB->escape(preg_replace('/[^a-zA-Z0-9\-_.:]/', '', @$_REQUEST['gw-host'])) .'\',
 	`user` = \''. $DB->escape(preg_replace('/[^a-zA-Z0-9\-_.@]/', '', @$_REQUEST['gw-user'])) .'\',
 	`pwd` = \''. $DB->escape(preg_replace('/[^a-zA-Z0-9\-_.#*]/', '', @$_REQUEST['gw-pwd'])) .'\'
 WHERE `id`='. (int)$gwid
Index: opt/gemeinschaft/htdocs/gui/mod/pb_common.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/mod/pb_common.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/mod/pb_common.php	(working copy)
@@ -58,6 +58,25 @@
 		array( '%', '_' ),
 		$number
 	) .'%';
+	if (GS_MASTER_SLAVE_MODE == true) {
+
+
+$rs = $DB->execute(
+'SELECT SQL_CALC_FOUND_ROWS
+	`u`.`firstname` `fn`, `u`.`lastname` `ln`, `u`.`user` `ext`
+FROM
+	`users` `u`
+WHERE
+	`u`.`invisible`=0 AND
+	`u`.`nobody_index` IS NULL AND (
+	`u`.`user` LIKE \''. $DB->escape($number_sql) .'\'
+	)
+ORDER BY `u`.`user`
+LIMIT '. ($page*(int)$per_page) .','. (int)$per_page
+	);
+	
+	}
+	else{
 	$rs = $DB->execute(
 'SELECT SQL_CALC_FOUND_ROWS
 	`u`.`firstname` `fn`, `u`.`lastname` `ln`, `s`.`name` `ext`
@@ -65,15 +84,18 @@
 	`users` `u` JOIN
 	`ast_sipfriends` `s` ON (`s`.`_user_id`=`u`.`id`)
 WHERE
+	`u`.`invisible`=0 AND
 	`u`.`nobody_index` IS NULL AND (
 	`s`.`name` LIKE \''. $DB->escape($number_sql) .'\'
 	)
 ORDER BY `s`.`name`
 LIMIT '. ($page*(int)$per_page) .','. (int)$per_page
 	);
+	}
 	$num_total = @$DB->numFoundRows();
 	$num_pages = ceil($num_total / $per_page);
 	
+	
 } else {
 	
 	# search by name
@@ -86,13 +108,32 @@
 		array( '%', '_' ),
 		$name
 	) .'%';
+	if (GS_MASTER_SLAVE_MODE == true) {
+
 	$rs = $DB->execute(
 'SELECT SQL_CALC_FOUND_ROWS
+	`u`.`firstname` `fn`, `u`.`lastname` `ln`, `u`.`user` `ext`
+FROM
+	`users` `u`
+WHERE
+	`u`.`invisible`=0 AND
+	`u`.`nobody_index` IS NULL AND (
+	`u`.`lastname` LIKE _utf8\''. $DB->escape($name_sql) .'\' COLLATE utf8_unicode_ci OR
+	`u`.`firstname` LIKE _utf8\''. $DB->escape($name_sql) .'\' COLLATE utf8_unicode_ci
+	)
+ORDER BY `u`.`lastname`, `u`.`firstname`
+LIMIT '. ($page*(int)$per_page) .','. (int)$per_page
+	);
+	}
+	else {
+	$rs = $DB->execute(
+'SELECT SQL_CALC_FOUND_ROWS
 	`u`.`firstname` `fn`, `u`.`lastname` `ln`, `s`.`name` `ext`
 FROM
 	`users` `u` JOIN
 	`ast_sipfriends` `s` ON (`s`.`_user_id`=`u`.`id`)
 WHERE
+	`u`.`invisible`=0 AND
 	`u`.`nobody_index` IS NULL AND (
 	`u`.`lastname` LIKE _utf8\''. $DB->escape($name_sql) .'\' COLLATE utf8_unicode_ci OR
 	`u`.`firstname` LIKE _utf8\''. $DB->escape($name_sql) .'\' COLLATE utf8_unicode_ci
@@ -100,6 +141,7 @@
 ORDER BY `u`.`lastname`, `u`.`firstname`
 LIMIT '. ($page*(int)$per_page) .','. (int)$per_page
 	);
+	}
 	$num_total = @$DB->numFoundRows();
 	$num_pages = ceil($num_total / $per_page);
 	
Index: opt/gemeinschaft/htdocs/gui/mod/forwards_queues.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/mod/forwards_queues.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/mod/forwards_queues.php	(working copy)
@@ -27,11 +27,23 @@
 \*******************************************************************/
 
 defined('GS_VALID') or die('No direct access.');
+<<<<<<< .working
 include_once( GS_DIR .'inc/gs-fns/gs_queue_callforward_activate.php' );
 include_once( GS_DIR .'inc/gs-fns/gs_queue_callforward_get.php' );
 include_once( GS_DIR .'inc/gs-fns/gs_queue_callforward_set.php' );
 include_once( GS_DIR .'inc/gs-fns/gs_queue_get.php' );
 include_once( GS_DIR .'inc/gs-fns/gs_queues_get.php' );
+=======
+function trim_value(&$value)
+{
+	$value = trim($value);
+}
+    
+$admins =  split(',',GS_GUI_SUDO_ADMINS);
+array_walk($admins, 'trim_value');
+if(!in_array($_SESSION[sudo_user][name], $admins)){
+	die(__('Nur Administratoren d&uuml;rfen hier &Auml;nderungen vornehmen!'));
+}
 
 echo '<h2>';
 if (@$MODULES[$SECTION]['icon'])
@@ -41,7 +53,7 @@
 	echo $MODULES[$SECTION]['title'], ' - ';
 echo $MODULES[$SECTION]['sub'][$MODULE]['title'];
 */
-echo __('Rufumleitung Warteschleifen');
+echo __('Rufumleitung Warteschlange');
 echo '</h2>', "\n";
 
 
@@ -52,7 +64,7 @@
 $cases = array(
 	'always' => __('immer'),
 	'full'   => __('voll'),
-	'timeout'=> __('keine Antw.'),
+	'timeout'=> __('keine Antwort'),
 	'empty'  => __('leer')
 );
 $actives = array(
@@ -65,10 +77,10 @@
 
 $queues = @gs_queues_get();
 if (isGsError($queues)) {
-	echo __('Fehler beim Abfragen der Queues.'), ' - ', $queues->getMsg();
+	echo __('Fehler beim Abfragen der Warteschlangen.'), ' - ', $queues->getMsg();
 	return;  # return to parent file
 } elseif (! is_array($queues)) {
-	echo __('Fehler beim Abfragen der Queues.');
+	echo __('Fehler beim Abfragen der Warteschlangen.');
 	return;  # return to parent file
 }
 
@@ -116,7 +128,7 @@
 ?>
 
 <form method="get" action="<?php echo GS_URL_PATH; ?>">
-<?php echo __('Queue'); ?>:
+<?php echo __('Warteschlange'); ?>:
 <?php echo gs_form_hidden($SECTION, $MODULE); ?>
 <?php
 
@@ -165,17 +177,17 @@
 		#
 		$callforwards = @gs_queue_callforward_get( $queue_ext );
 		if (isGsError($callforwards)) {
-			echo __('Fehler beim Abfragen der Rufumleitungen der Queue.') .' - '. $callforwards->getMsg();
+			echo __('Fehler beim Abfragen der Rufumleitungen der Warteschlange.') .' - '. $callforwards->getMsg();
 			return;  # return to parent file
 		} elseif (! is_array($callforwards)) {
-			echo __('Fehler beim Abfragen der Rufumleitungen der Queue.');
+			echo __('Fehler beim Abfragen der Rufumleitungen der Warteschlange.');
 			return;  # return to parent file
 		} else
 			$queue_exists = true;
 	}
 }
 if (! $queue_exists) {
-	echo __('Bitte w&auml;hlen Sie eine Warteschleife.');
+	echo __('Bitte w&auml;hlen Sie eine Warteschlange.');
 	return;  # return to parent file
 }
 
@@ -264,28 +276,27 @@
 <table cellspacing="1">
 <thead>
 <tr>
-	<th colspan="2"><?php echo __('Umleitungsnummern'); ?></th>
+	<th colspan="5"><?php echo __('Ziele für Anrufumleitung'); ?></th>
 </tr>
 </thead>
 <tbody>
 <tr class="even">
-	<td style="width:170px;"><?php echo __('Standardnummer'); ?></td>
-	<td style="width:299px;">
+	<td style="width:170px;" colspan="2"><?php echo __('Zielrufnummer Standard (Std.)'); ?></td>
+	<td colspan="3">
 		<input type="text" name="num-std" value="<?php echo htmlEnt($number_std); ?>" size="30" style="width:220px;" maxlength="25" />
 	</td>
 </tr>
 <tr class="even">
-	<td><?php echo __('Tempor&auml;re Nummer'); ?></td>
-	<td>
+	<td colspan="2"><?php echo __('Zielrufnummer tempor&auml;r (Tmp.)'); ?></td>
+	<td colspan="3">
 		<input type="text" name="num-var" value="<?php echo htmlEnt($number_var); ?>" size="30" style="width:220px;" maxlength="25" />
 	</td>
 </tr>
 </tbody>
-</table>
-
-<br />
-
-<table cellspacing="1">
+<tr>
+	<td colspan="5" class="quickchars"><br />
+	</td>
+</tr>
 <thead>
 <tr>
 	<th colspan="5"><?php echo __('Umleiten in folgenden F&auml;llen'); ?></th>
@@ -293,11 +304,11 @@
 </thead>
 <tbody>
 <tr class="even">
-	<td>&nbsp;</td>
+	<td style="width:92px;">&nbsp;</td>
 <?php
 
 foreach ($cases as $case => $ctitle) {
-	echo '<td style="width:85px;">', $ctitle, '</td>', "\n";
+	echo '<td style="width:92px;">', $ctitle, '</td>', "\n";
 }
 //echo '<td style="width:80px;">', __('AB'), '</td>', "\n";
 
Index: opt/gemeinschaft/htdocs/gui/mod/routing_gwgrps.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/mod/routing_gwgrps.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/mod/routing_gwgrps.php	(working copy)
@@ -70,7 +70,8 @@
 	`in_dest_search`,
 	`in_dest_replace`,
 	`out_cid_search`,
-	`out_cid_replace`
+	`out_cid_replace`,
+	`direct_prefix`
 FROM
 	`gate_grps`
 WHERE `id`='.$ggid
@@ -86,7 +87,8 @@
 			'in_dest_search'  => '',
 			'in_dest_replace' => '',
 			'out_cid_search'  => '',
-			'out_cid_replace' => ''
+			'out_cid_replace' => '',
+			'direct_prefix'	  => ''
 		);
 	}
 	
@@ -113,7 +115,32 @@
 		$out_cid_search  = $oldgg['out_cid_search' ];
 		$out_cid_replace = $oldgg['out_cid_replace'];
 	}
-	
+	$direct_prefix = trim(@$_REQUEST['gg-prefix']);
+	if($direct_prefix != ''){
+		if(!preg_match('/^[1-9]\d{0,4}$/',$direct_prefix)) {
+			if(preg_match('/^0\d*$/',$direct_prefix)) {
+				echo 'Trunk prefix starts with \'0\'. This is the default prefix. ',"\n";
+				echo 'Choose another one or leave this empty.<br />',"\n";
+			}
+			else if(strlen($direct_prefix) > 5){
+				echo 'Trunk prefix is too long. Only five digits are allowed.<br />',"\n";
+			}
+			else {
+				echo 'Trunk prefix is not a number. ',"\n";
+				echo 'Choose another valid one or leave this empty.<br />',"\n";
+			}
+			$direct_prefix = $oldgg['direct_prefix' ];
+		}
+		else {
+			$num = (int)$DB->executeGetOne( 'SELECT `id` FROM `gate_grps` WHERE `direct_prefix`=\''. $DB->escape($direct_prefix) .'\'' );
+			if($num != 0 && $num != $ggid){
+				echo 'This trunk prefix is already in use! ',"\n";
+				echo 'Choose another one or leave this empty.<br />',"\n";
+				$direct_prefix = $oldgg['direct_prefix' ];
+			}
+		}
+		 
+	}
 	if ($ggid > 0) {
 		$DB->execute(
 'UPDATE `gate_grps` SET
@@ -123,7 +150,8 @@
 	`in_dest_search`=\'' . $DB->escape($in_dest_search ) .'\',
 	`in_dest_replace`=\''. $DB->escape($in_dest_replace) .'\',
 	`out_cid_search`=\'' . $DB->escape($out_cid_search ) .'\',
-	`out_cid_replace`=\''. $DB->escape($out_cid_replace) .'\'
+	`out_cid_replace`=\''. $DB->escape($out_cid_replace) .'\',
+	`direct_prefix`=\''  . $DB->escape($direct_prefix  ) .'\'
 WHERE `id`='.$ggid
 		);
 		// separate query because there's a "unique" constraint on the name
@@ -145,7 +173,8 @@
 	`in_dest_search`,
 	`in_dest_replace`,
 	`out_cid_search`,
-	`out_cid_replace`
+	`out_cid_replace`,
+	`direct_prefix`
 ) VALUES (
 	NULL,
 	\''. $DB->escape($name           ) .'\',
@@ -155,7 +184,8 @@
 	\''. $DB->escape($in_dest_search ) .'\',
 	\''. $DB->escape($in_dest_replace) .'\',
 	\''. $DB->escape($out_cid_search ) .'\',
-	\''. $DB->escape($out_cid_replace) .'\'
+	\''. $DB->escape($out_cid_replace) .'\',
+	\''. $DB->escape($direct_prefix  ). '\'
 )'
 		);
 		$ggid = (int)$DB->getLastInsertId();
@@ -241,7 +271,8 @@
 	`in_dest_search`,
 	`in_dest_replace`,
 	`out_cid_search`,
-	`out_cid_replace`
+	`out_cid_replace`,
+	`direct_prefix`
 FROM
 	`gate_grps`
 WHERE `id`='.$ggid
@@ -258,7 +289,8 @@
 			'in_dest_search' => '',
 			'in_dest_replace'=> '',
 			'out_cid_search' => '^(.*)',
-			'out_cid_replace'=> '$1'
+			'out_cid_replace'=> '$1',
+			'direct_prefix'  => ''
 		);
 	}
 	
@@ -313,6 +345,11 @@
 	echo '</td>',"\n";
 	echo '</tr>',"\n";
 	
+	echo '<tr>',"\n";
+	echo '<th style="width:120px;">', __('Amtsholungs-Pr&auml;fix') ,':</th>',"\n";
+	echo '<td style="width:340px;"><input type="text" name="gg-prefix" value="', htmlEnt($gg['direct_prefix']) ,'" size="8" maxlength="5" style="font-family:monospace; width:97%;" /></td>',"\n";
+	echo '</tr>',"\n";
+	
 ?>
 
 </tbody>
Index: opt/gemeinschaft/htdocs/gui/mod/help_snom.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/mod/help_snom.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/mod/help_snom.php	(working copy)
@@ -47,15 +47,18 @@
 ?>
 
 <p style="max-width:550px; font-size:0.92em; line-height:1.2em;">
-<?php echo __('Das SIP-Telefon Snom 360 bietet neben den &uuml;blichen Zifferntasten eine ganze Reihe n&uuml;tzlicher Funktionstasten, die bis zu einem gewissen Grad konfigurierbar sind. Die wichtigsten Tasten und Funktionen werden an dieser Stelle kurz aufgef&uuml;hrt. Eine genaue Beschreibung der Tasten finden Sie in dem &uuml;ber 100 Seiten starken Handbuch zu ihrem Snom-Telefon.'), ' '; ?>
-(<a target="_blank" href="http://www.snom.com/wiki/index.php/Snom360"><?php echo __('Snom 360 Doku'); ?></a>)
+<?php echo __('snom-Telefone weisen abh&auml;ngig vom Ger&auml;te-Typ konfigurierbare Funktionstasten auf, deren Funktionen unten aufgef&uuml;hrt sind. Bitte entnehmen Sie eine ausf&uuml;hrliche Beschreibung der Tasten und Funktionen dem Handbuch zum snom-Telefon.'), ' '; ?>
+
+<br><a target="_blank" href="http://wiki.snom.com/Snom320/Documentation"><?php echo __('Dokumentation snom 320'); ?></a>
+/ <a target="_blank" href="http://wiki.snom.com/Snom360/Documentation"><?php echo __('Dokumentation snom 360'); ?></a>
+/ <a target="_blank" href="http://wiki.snom.com/Snom370/Documentation"><?php echo __('Dokumentation snom 370'); ?></a>
 </p>
 
 
 <table cellspacing="1">
 <thead>
 <tr>
-	<th colspan="2"><?php echo __('Snom 360 Tasten'); ?></th>
+	<th colspan="2"><?php echo __('Tastenbelegung snom-Telefon'); ?></th>
 </tr>
 </thead>
 <tbody>
Index: opt/gemeinschaft/htdocs/gui/mod/calls_in.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/mod/calls_in.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/mod/calls_in.php	(working copy)
@@ -122,7 +122,10 @@
 	$i = 0;
 	while ($r = $rs->fetchRow()) {
 		echo '<tr class="'. ((++$i % 2 == 0) ? 'even':'odd') .'">';
-		echo '<td>', htmlEnt($r['number']), '</td>';
+		if($r['number'] != '')
+			echo '<td>', htmlEnt($r['number']), '</td>';
+		else
+			echo '<td>', htmlEnt('Unbekannt'), '</td>';
 		
 		if (! $r['r_uid'])
 			$name = $r['remote_name'];
Index: opt/gemeinschaft/htdocs/gui/mod/ringtones_ringtones.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/mod/ringtones_ringtones.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/mod/ringtones_ringtones.php	(working copy)
@@ -1,263 +0,0 @@
-<?php
-/*******************************************************************\
-*            Gemeinschaft - asterisk cluster gemeinschaft
-* 
-* $Revision$
-* 
-* Copyright 2007, amooma GmbH, Bachstr. 126, 56566 Neuwied, Germany,
-* http://www.amooma.de/
-* Stefan Wintermeyer <stefan.wintermeyer@amooma.de>
-* Philipp Kempgen <philipp.kempgen@amooma.de>
-* Peter Kozak <peter.kozak@amooma.de>
-* 
-* This program is free software; you can redistribute it and/or
-* modify it under the terms of the GNU General Public License
-* as published by the Free Software Foundation; either version 2
-* of the License, or (at your option) any later version.
-* 
-* This program is distributed in the hope that it will be useful,
-* but WITHOUT ANY WARRANTY; without even the implied warranty of
-* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-* GNU General Public License for more details.
-* 
-* You should have received a copy of the GNU General Public License
-* along with this program; if not, write to the Free Software
-* Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
-* MA 02110-1301, USA.
-\*******************************************************************/
-
-defined('GS_VALID') or die('No direct access.');
-include_once( GS_DIR .'inc/gs-fns/gs_ringtones_get.php' );
-include_once( GS_DIR .'inc/gs-fns/gs_ringtone_set.php' );
-
-
-echo '<h2>';
-if (@$MODULES[$SECTION]['icon'])
-	echo '<img alt=" " src="', GS_URL_PATH, str_replace('%s', '32', $MODULES[$SECTION]['icon']), '" /> ';
-if (count( $MODULES[$SECTION]['sub'] ) > 1 )
-	echo $MODULES[$SECTION]['title'], ' - ';
-echo $MODULES[$SECTION]['sub'][$MODULE]['title'];
-echo '</h2>', "\n";
-
-
-$sources = array(
-	'internal' => __('intern'),
-	'external' => __('extern')
-);
-
-$audio_exts = array( 'aif', 'aiff', 'wav', 'au', 'al', 'alaw', 'la',
-                     'ul', 'ulaw', 'lu', 'gsm', 'cdr', 'mp3', 'ogg' );
-
-$errMsgs = array();
-
-if (@$_REQUEST['action']=='save') {
-	
-	/*
-	echo "<pre>";
-	print_r($_REQUEST);
-	print_r($_FILES);
-	echo "</pre>";
-	*/
-	
-	foreach ($sources as $src => $srcv) {
-		$bellcore = (int)@$_REQUEST[$src .'-bellcore'];
-		
-		if (@$_REQUEST[$src .'-file-change'] == 'new')
-			$change_file = true;
-		elseif (@$_REQUEST[$src .'-file-change'] == 'off')
-			$change_file = true;
-		else  # "keep"
-			$change_file = false;
-		
-		$ul_filename = '';
-		
-		if ($change_file && @$_REQUEST[$src .'-file-change'] == 'new') {
-			if (! isSet($_FILES[$src .'-file'])) {
-				$errMsgs[] = sprintf(__('Datei-Upload f&uuml;r %s fehlgeschlagen.'), $sources[$src]);
-				$change_file = false;
-			} else {
-				switch (@$_FILES[$src .'-file']['error']) {
-					case UPLOAD_ERR_OK:
-						/*
-						if (strToLower(subStr(@$_FILES[$src .'-file']['type'],0,6)) != 'audio/') {
-							$errMsgs[] = 'Datei f&uuml;r '. $sources[$src] .' keine Audio-Datei.';
-							$change_file = false;
-						} else {
-						*/
-						preg_match('/\.([a-z\d]+)$/', strToLower( @$_FILES[$src .'-file']['name'] ), $m);
-						$ext = @$m[1];
-						if (! in_array($ext, $audio_exts, true)) {
-							$errMsgs[] = sprintf(__('Datei f&uuml;r %s keine Audio-Datei'),  $sources[$src]) .' ('. $ext .').' .'<br />'. __('Erlaubte Formate') .': '. implode(', ', $audio_exts);
-							$change_file = false;
-						} elseif (! is_uploaded_file( @$_FILES[$src .'-file']['tmp_name'] )) {
-							$errMsgs[] = __('Zugriffsverletzung!');
-							$change_file = false;
-						} else {
-							$ul_filename = @$_FILES[$src .'-file']['tmp_name'] .'.'. $ext;
-							$ok = @rename( @$_FILES[$src .'-file']['tmp_name'], $ul_filename );
-							if (! $ok) {
-								$errMsgs[] = sprintf(__('Fehler beim Upload f&uuml;r %s.'), $sources[$src]);
-								$change_file = false;
-							} else {
-								@chmod($ul_filename, 0666);
-								# upload ok, leave $change_file == true
-							}
-						}
-						break;
-					case UPLOAD_ERR_INI_SIZE:
-					case UPLOAD_ERR_FORM_SIZE:
-						$errMsgs[] = sprintf(__('Datei f&uuml;r %s zu gro&szlig;.'), $sources[$src]);
-						$change_file = false;
-						break;
-					case UPLOAD_ERR_PARTIAL:
-					case UPLOAD_ERR_NO_FILE:
-					default:
-						$errMsgs[] = sprintf(__('Datei-Upload f&uuml;r %s fehlgeschlagen.'), $sources[$src]);
-						$change_file = false;
-						break;
-				}
-			}
-		}
-		$ok = gs_ringtone_set( $_SESSION['sudo_user']['name'], $src, $bellcore, $change_file, ($change_file ? $ul_filename : null) );
-		if (is_file($ul_filename))
-			@unlink($ul_filename);
-		if (isGsError($ok))
-			$errMsgs[] = $ok->getMsg();
-		elseif (! $ok)
-			$errMsgs[] = __('Fehler beim Setzen des eigenen Klingeltons.');
-		
-	}
-	
-}
-
-
-
-
-$ringtones = gs_ringtones_get( $_SESSION['sudo_user']['name'] );
-if (isGsError($ringtones)) {
-	echo __('Fehler beim Abfragen.'), '<br />', $ringtones->getMsg();
-	die();
-}
-
-//$cur_phone_type = $DB->executeGetOne( 'SELECT `type` FROM `phones` WHERE `user_id`='. (int)@$_SESSION['sudo_user']['info']['id'] );
-
-
-?>
-
-<div style="max-width:600px;">
-	<img alt=" " src="<?php echo GS_URL_PATH; ?>crystal-svg/16/act/info.png" class="fl" />
-	<p style="margin-left:22px;">
-		<?php echo __('Bitte beachten Sie, da&szlig; die unterst&uuml;tzten Klingelt&ouml;ne stark von dem Endger&auml;t abh&auml;ngig sind, auf dem Sie sich anmelden. Ggf. wird also ein anderer als der hier eingestellte Klingelton gespielt.'); ?>
-		<sup>[1]</sup>
-		<sup>[2]</sup>
-	</p>
-</div>
-
-
-<?php
-if (is_array($errMsgs) && count($errMsgs) > 0) {
-?>
-<div style="max-width:600px;">
-	<img alt=" " src="<?php echo GS_URL_PATH; ?>crystal-svg/16/app/important.png" class="fl" />
-	<p style="margin-left:22px;">
-		<?php echo implode('<br />', $errMsgs); ?>
-	</p>
-</div>
-<?php
-}
-?>
-
-<form method="post" action="<?php echo GS_URL_PATH; ?>" enctype="multipart/form-data">
-<?php echo gs_form_hidden($SECTION, $MODULE); ?>
-<input type="hidden" name="action" value="save" />
-
-<table cellspacing="1">
-<thead>
-<tr>
-	<th><?php echo __('Von'); ?></th>
-	<th>Bellcore</th>
-	<th><?php echo __('Audio-Datei'); ?></th>
-</tr>
-</thead>
-<tbody>
-<?php
-foreach ($sources as $source => $source_v) {
-?>
-<tr>
-	<td style="width:55px;"><?php echo $source_v; ?></td>
-	<td style="width:115px;">
-		<select name="<?php echo $source; ?>-bellcore">
-<?php
-for ($i=1; $i<=11; ++$i) {
-	if ($i <= 10) {
-		$dr_i = $i;
-		$dr_v = 'Bellcore '. $i;
-	} elseif ($i == 11) {
-		$dr_i = 0;
-		$dr_v = __('Lautlos');
-	} /*elseif ($i == 12) {
-		$dr_i = -1;
-		$dr_v = 'eigene Datei';
-	}*/
-	$sel = ($dr_i == @$ringtones[$source]['bellcore']) ? ' selected="selected"' : '';
-	echo '<option value="', $dr_i, '"', $sel, '>', $dr_v, '</option>', "\n";
-}
-?>
-		</select>
-	</td>
-	<td style="width:430px;">
-		<input type="radio" name="<?php echo $source; ?>-file-change" value="off" id="<?php echo $source; ?>-file-change-off" <?php if (! @$ringtones[$source]['file']) echo 'checked="checked" '; ?>/>
-			<label for="<?php echo $source; ?>-file-change-off"><?php echo __('keine'); ?></label><br />
-<?php
-if (@$ringtones[$source]['file']) {
-?>
-		<input type="radio" name="<?php echo $source; ?>-file-change" value="keep" id="<?php echo $source; ?>-file-change-keep" checked="checked" />
-			<label for="<?php echo $source; ?>-file-change-keep"><?php echo __('eigene beibehalten'); ?></label><br />
-<?php
-}
-?>
-		<input type="radio" name="<?php echo $source; ?>-file-change" value="new" id="<?php echo $source; ?>-file-change-new" />
-		<input type="file" name="<?php echo $source; ?>-file" size="45" style="font-size:10px;" accept="audio/*" onchange="var r=document.getElementById('<?php echo $source; ?>-file-change-new'); if(r)r.click(); return true;" />
-	</td>
-</tr>
-<?php
-}
-?>
-
-<tr>
-	<td colspan="3" class="quickchars r">
-		<br />
-		<br />
-		<button type="submit">
-			<img alt=" " src="<?php echo GS_URL_PATH; ?>crystal-svg/16/act/filesave.png" />
-			<?php echo __('Speichern'); ?>
-		</button>
-	</td>
-</tr>
-</tbody>
-</table>
-
-</form>
-
-
-<br />
-<?php
-
-//if (strToLower(subStr($cur_phone_type,0,4)) === 'snom') {
-?>
-<p class="small" style="max-width:48em;">
-	<sup>[1]</sup>
-	<?php echo __('Das Snom unterst&uuml;tzt Ringer 1-5 und lautlos.<br /> F&uuml;r das Snom kann nur entweder f&uuml;r interne oder f&uuml;r externe Anrufe eine eigene Klingeltondatei eingestellt sein, nicht f&uuml;r beides. Die L&auml;nge wird auf wenige Sekunden begrenzt.'); ?>
-</p>
-<?php
-//}
-//elseif (strToLower(subStr($cur_phone_type,0,7)) === 'siemens') {
-?>
-<p class="small" style="max-width:48em;">
-	<sup>[2]</sup>
-	<?php echo __('Das Siemens OpenStage kann in der derzeitigen Firmware noch nicht zwischen intern und extern unterscheiden. Es wird immer die Ruftonmelodie für intern verwendet!'); ?>
-</p>
-<?php
-//}
-
-?>
Index: opt/gemeinschaft/htdocs/gui/mod/login_login.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/mod/login_login.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/mod/login_login.php	(working copy)
@@ -84,24 +84,23 @@
 						}
 						
 						$msg = sPrintF(
-"Hallo %s
+"Sehr geehrte(r) %s,
 
-Sie (oder jemand, der sich als Sie ausgeben wollte) haben in der
-Web-Oberfl\xC3\xA4che von Gemeinschaft die Zusendung Ihres Pa\xC3\x9Fwortes
+Sie haben (oder jemand, der sich als Sie ausgeben wollte hat) in der
+Web-Oberfl\xC3\xA4che des TK-Systems die Zusendung Ihres Passwortes
 angefordert.
 
-Ihre PIN-Nummer lautet:  %s
+Ihr Passwort lautet:  %s
 
-Viele Gr\xC3\xBC\xC3\x9Fe,
- Gemeinschaft
--- 
-Dies ist eine automatisierte Nachricht. Bitte antworten Sie nicht.
-Gemeinschaft auf \"%s\"
+Sollte eine dritte Person diese Anfrage geschickt haben, oder sollten Sie
+sich in der Zwischenzeit wieder an Ihr Passwort erinnern, können Sie diese
+Nachricht einfach ignorieren.
+
+Dies ist eine automatisch generierte Mail. Bitte wenden Sie sich für Rückfragen an Ihren Systembetreuer.
 ",
 							(@$u['firstname'] != '' ? $u['firstname'] : '') .
 							(@$u['lastname'] != '' ? ' '.$u['lastname'] : ''),
-							@$u['pin'],
-							$hostname
+							@$u['pin']
 						);
 						
 						$GS_EMAIL_DELIVERY = gs_get_conf('GS_EMAIL_DELIVERY');
@@ -109,12 +108,12 @@
 						if ($GS_EMAIL_DELIVERY === 'sendmail') {
 							
 							$headers =
-								'From: "Gemeinschaft" <root>' ."\r\n".
+								'From: "TK-System" <root>' ."\r\n".
 								'Reply-To: "'. 'Nicht antworten' .'" <noreply@noreply.local>' ."\r\n".
 								'MIME-Version: 1.0' ."\r\n".
 								'Content-Type: text/plain; charset=utf-8';
 							
-							$ok = @mail( $u['email'], 'Gemeinschaft Passwort', $msg, $headers );
+							$ok = @mail( $u['email'], "TK-System Passwort", $msg, $headers );
 							if ($ok) {
 								gs_log( GS_LOG_NOTICE, 'Sent PIN number for user '. $login_user .' to "'. $u['email'] .'" via '. $GS_EMAIL_DELIVERY );
 							} else {
@@ -122,7 +121,7 @@
 							}
 							
 							$action_info = $ok
-								? sPrintF(__('Pa&szlig;wort wurde an <tt>%s</tt> gesendet'), htmlEnt($u['email']))
+								? sPrintF(__('Passwort wurde an <tt>%s</tt> gesendet'), htmlEnt($u['email']))
 								: sPrintF(__('Fehler beim Senden an <tt>%s</tt>'), htmlEnt($u['email']));
 							
 						}
@@ -136,14 +135,14 @@
 								GS_DIR .'lib/phpmailer/language/' );
 							$mail->Hostname = $hostname;
 							$mail->From = 'root@'.$hostname;
-							$mail->FromName = 'Gemeinschaft';
+							$mail->FromName = 'TK-System';
 							$mail->AddReplyTo( '', 'Nicht antworten' );
 							$mail->AddAddress(
 								$u['email'],
 								(@$u['firstname'] != '' ? $u['firstname'] : '') .
 								(@$u['lastname'] != '' ? ' '.$u['lastname'] : '')
 								);
-							$mail->Subject = "Gemeinschaft Pa\xC3\x9Fwort";
+							$mail->Subject = "TK-System Passwort";
 							$mail->Body = $msg;
 							$mail->IsSMTP();
 							//$mail->SMTPDebug = true;
@@ -184,7 +183,7 @@
 								}
 								
 								$action_info = $ok
-									? sPrintF(__('Pa&szlig;wort wurde an <tt>%s</tt> gesendet'), htmlEnt($u['email']))
+									? sPrintF(__('Passwort wurde an <tt>%s</tt> gesendet'), htmlEnt($u['email']))
 									: sPrintF(__('Fehler beim Senden an <tt>%s</tt>'), htmlEnt($u['email'])) .'<br />('. $mail->ErrorInfo .')';
 							}
 							
@@ -215,7 +214,7 @@
 
 <br />
 <div style="text-align:right;">
-	<input type="submit" value="<?php echo __('Pa&szlig;wort mailen'); ?>" />
+	<input type="submit" value="<?php echo __('Passwort mailen'); ?>" />
 </div>
 </form>
 </div>
@@ -285,7 +284,7 @@
 <script type="text/javascript">/*<![CDATA[*/ try{ document.getElementById('ipt-login_user').focus(); }catch(e){} /*]]>*/</script>
 <?php } ?>
 
-<label for="ipt-login_pwd"><?php echo __('Pa&szlig;wort'); ?>:</label><br />
+<label for="ipt-login_pwd"><?php echo __('Passwort'); ?>:</label><br />
 <input name="login_pwd" id="ipt-login_pwd" type="password" size="15" maxlength="20" value="" style="width:150px; font-size:1.2em;" /><br />
 
 <br />
@@ -295,7 +294,7 @@
 </form>
 
 </div>
-<a href="<?php echo gs_url($SECTION, $MODULE, null, 'login_action=forgotpwd'); ?>" style="font-size:0.95em;"><?php echo __('Pa&szlig;wort vergessen'); ?></a>
+<a href="<?php echo gs_url($SECTION, $MODULE, null, 'login_action=forgotpwd'); ?>" style="font-size:0.95em;"><?php echo __('Passwort vergessen'); ?></a>
 </div>
 <?php
 	
Index: opt/gemeinschaft/htdocs/gui/mod/pb_csvimport.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/mod/pb_csvimport.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/mod/pb_csvimport.php	(working copy)
@@ -336,7 +336,10 @@
 				@$_SESSION['sudo_user']['info']['ext']
 			),
 			'</p>', "\n";
+		echo '<p>', "\n";
+		echo '<input type="checkbox" name="erase">', __('bestehende Eintr&auml;ge des pers&ouml;nlichen Telefonbuches vor dem Import der neuen Daten unwiderruflich l&ouml;schen'),"</input><br />", "\n";
 		
+		echo '</p>', "\n";		
 		echo '<input type="submit" value="', __('Import') ,'" /><br />', "\n";	
 		echo '</form>', "\n";
 		echo '<br />', "\n";
@@ -351,8 +354,12 @@
 	if (! @is_array(@$records) || count($records)<1) {
 		echo 'Error.';
 	} else {
+		$user_id = (int)@$_SESSION['sudo_user']['info']['id'];
 		
-		$user_id = (int)@$_SESSION['sudo_user']['info']['id'];
+		if(isset($_REQUEST['erase'])){
+			gs_user_pb_del($user_id);	
+		}
+		
 		$query_start = 'INSERT INTO `pb_prv` (`user_id`, `firstname`, `lastname`, `number`) VALUES '."\n";
 		$sql_values = array();
 		gs_db_start_trans($DB);
Index: opt/gemeinschaft/htdocs/gui/mod/admin_pgroups.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/mod/admin_pgroups.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/mod/admin_pgroups.php	(working copy)
@@ -64,12 +64,21 @@
 
 if ($delete) {
 	$ret = gs_pickupgroup_del( $delete );
+	if ( GS_BUTTONDAEMON_USE == true ) {   
+		gs_buttondeamon_group_del( $delete );
+	}
 	if (isGsError( $ret )) echo $ret->getMsg();
 }
 
 if ($pudelete) {
 	$ret = gs_pickupgroup_user_del( $group, $pudelete );
 	if (isGsError( $ret )) echo $ret->getMsg();
+	$ret= gs_pickupgroup_user_set( $pudelete );
+	if (isGsError( $ret )) echo $ret->getMsg();
+	if ( GS_BUTTONDAEMON_USE == true ) {   
+	 	$userinfo = gs_user_get($pudelete);
+		gs_buttondeamon_group_update($userinfo['ext']);                   
+	}
 }
 
 if ($title && !$save) {
@@ -88,6 +97,13 @@
 if ($group && $user) {
 	$ret = gs_pickupgroup_user_add( $group, $user );
 	if (isGsError( $ret )) echo $ret->getMsg();
+	$ret= gs_pickupgroup_user_set( $user );
+	if (isGsError( $ret )) echo $ret->getMsg();
+	if ( GS_BUTTONDAEMON_USE == true ) {
+		$userinfo = gs_user_get($user);
+	 	gs_buttondeamon_group_update($userinfo['ext']);
+	         
+	}
 }
 
 
Index: opt/gemeinschaft/htdocs/gui/mod/admin_users.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/mod/admin_users.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/mod/admin_users.php	(working copy)
@@ -38,6 +38,8 @@
 include_once( GS_DIR .'inc/gs-fns/gs_callblocking_set.php' );
 require_once( GS_DIR .'inc/boi-soap/boi-api.php' );
 include_once( GS_DIR .'lib/utf8-normalize/gs_utf_normal.php' );
+include_once( GS_DIR .'inc/gs-fns/gs_astphonebuttons.php' );
+include_once( GS_DIR .'inc/gs-fns/gs_user_get.php' );
 
 echo '<h2>';
 if (@$MODULES[$SECTION]['icon'])
@@ -92,6 +94,12 @@
 $u_pgrps     =      @$_REQUEST['u_pgrps'  ] ;
 $u_pgrp_ed   =      @$_REQUEST['u_pgrp_ed'] ;
 
+$outnum      = trim(@$_REQUEST['outnum'   ]);
+$outnumdel   = trim(@$_REQUEST['outndel'  ]);
+
+$upgroups    =      @$_REQUEST['upgroup'  ] ;
+$upgrouped   =      @$_REQUEST['upgrouped'] ;
+
 $u_grp_ed    =      @$_REQUEST['u_grp_ed' ] ;
 $u_grp_id    = (int)@$_REQUEST['u_grp_id' ] ;
 
@@ -102,15 +110,24 @@
 $user_pin    = trim(@$_REQUEST['upin'     ]);
 $user_email  = trim(@$_REQUEST['uemail'   ]);
 $user_host   = trim(@$_REQUEST['uhost'    ]);
-
+$ggid        = trim(@$_REQUEST['ggid'     ]);
 $bp_add_h    = (int)@$_REQUEST['bp_add_h' ] ;
 $bp_del_h    = (int)@$_REQUEST['bp_del_h' ] ;
 
+if(isset($_REQUEST['invisible'])){
+	$user_invisible = 1;
+}
+else{
+	$user_invisible = 0;
+}
 
-
 if ($action === 'del') {
 	
 	if ($delete_user) {
+		if ( GS_BUTTONDAEMON_USE == true ) {
+				$userinfo = gs_user_get($delete_user);   
+				gs_buttondeamon_remove_peer($userinfo['ext']);                   
+		}
 		$ret = gs_user_del( $delete_user );
 		if (isGsError( $ret )) echo '<div class="errorbox">', $ret->getMsg() ,'</div>',"\n";
 	}
@@ -134,8 +151,6 @@
 	else {
 		$action = 'list';
 	}
-	
-}
 
 if ($action === 'edit') {
 	
@@ -219,13 +234,16 @@
 			}
 		}
 	}
+
+	if ( GS_BUTTONDAEMON_USE == true ) {
+		$user = gs_user_get($edit_user);
+	 	gs_buttondeamon_group_update($user['ext']);
+	         
+	}
 	
 	$action = 'list';
 }
 
-
-
-
 if ($action === 'list') {
 	
 	$use_ldap = false;
@@ -409,12 +427,13 @@
 			
 			echo '<tr class="', ((++$i % 2) ? 'odd':'even'), '">', "\n";
 			
-			echo '<td>', htmlEnt($r['usern']), '</td>' ,"\n";
+			if (GS_MASTER_SLAVE_MODE == true)
+				echo '<td>', $r['usern'], '</td>' ,"\n";
+			else
+				echo '<td>', $r['ext'], '</td>' ,"\n";
 			echo '<td>', htmlEnt($r['ln']);
 			if ($r['fn'] !='') echo ', ', htmlEnt($r['fn']);
 			echo '</td>' ,"\n";
-			//echo '<td>', htmlEnt($r['fn']) ,'</td>' ,"\n";
-			//echo '<td>', htmlEnt($r['hnr']) ,'</td>' ,"\n";
 			echo '<td>';
 			if ($r['hp_route_prefix'] != ''
 			&&  subStr($r['ext'],0,strLen($r['hp_route_prefix'])) === $r['hp_route_prefix'])
@@ -631,7 +650,6 @@
 	</tr>
 	</tbody>
 	</table>
-	
 	<br />
 	<?php if (gs_get_conf('GS_BOI_ENABLED')) { ?>
 	<p>
@@ -643,7 +661,7 @@
 <?php
 }
 else {
-	
+
 	$rs = $DB->execute(
 'SELECT
 	`u`.`firstname` `fn`, `u`.`lastname` `ln`, `u`.`host_id` `hid`, `u`.`honorific` `hnr`, `u`.`user` `usern`, `s`.`name` `ext` , `u`.`email` `email`, `u`.`pin` `pin`, `u`.`id` `uid`, `s`.`secret`, `u`.`group_id`,
@@ -666,7 +684,6 @@
 	
 	$boi_api = ($hid > 0) ? gs_host_get_api($hid) : '__fail_api';
 	
-	
 	$sql_query =
 'SELECT `p`.`id`, `p`.`title`, `u`.`host_id`
 FROM
@@ -677,7 +694,19 @@
 	`u`.`host_id` = '.$r['hid'].' OR
 	`u`.`host_id` IS NULL
 GROUP BY `p`.`id`';
-	
+
+	} else {
+
+		$sql_query =
+'SELECT `p`.`id`, `p`.`title`, `u`.`host_id`
+FROM
+	`pickupgroups` `p` LEFT JOIN
+	`pickupgroups_users` `pu` ON (`p`.`id`=`pu`.`group_id`) LEFT JOIN
+	`users` `u` ON (`u`.`id`=`pu`.`user_id`)
+GROUP BY `p`.`id`';
+
+	}
+
 	$rs = $DB->execute($sql_query);
 	$pgroups = array();
 	if (@$rs) {
@@ -692,7 +721,6 @@
 	`pickupgroups_users` `p` JOIN
 	`users` `u` ON (`p`.`user_id`=`u`.`id`)
 WHERE `u`.`user` = \''.$DB->escape($edit_user).'\'';
-	
 	$rs = $DB->execute($sql_query);
 	$pgroups_my = array();
 	if (@$rs) {
@@ -715,44 +743,42 @@
 		}
 	}
 	
-	$sql_query =
-'SELECT `number`
-FROM `users_external_numbers`
-WHERE `user_id`='. (int)$r['uid'] .'
-ORDER BY LENGTH(`number`) DESC';
-	
-	$rs = $DB->execute($sql_query);
-	$ext_nums = array();
-	if (@$rs) {
-		while ($r_en = $rs->fetchRow()) {
-			$ext_nums[] = $r_en['number'];
+		$sql_query =
+	'SELECT `number`
+	FROM `users_external_numbers`
+	WHERE `user_id`='. (int)$r['uid'] .'
+	ORDER BY LENGTH(`number`) DESC';
+
+		$rs = $DB->execute($sql_query);
+		$ext_nums = array();
+		if (@$rs) {
+			while ($r_en = $rs->fetchRow()) {
+				$ext_nums[] = $r_en['number'];
+			}
 		}
-	}
-	
-	if (gs_get_conf('GS_BOI_ENABLED')) {
-	$sql_query =
-		'SELECT '.
-			'`p`.`host_id`, `p`.`roles`, '.
-			'`h`.`comment`, `h`.`host` '.
-		'FROM '.
-			'`boi_perms` `p` JOIN '.
-			'`hosts` `h` ON (`h`.`id`=`p`.`host_id`) '.
-		'WHERE `p`.`user_id`='. (int)$r['uid'] .' '.
-		'ORDER BY `h`.`comment`';
-	
-	$rs = $DB->execute($sql_query);
-	$boi_perms = array();
-	if (@$rs) {
-		while ($r_bp = $rs->fetchRow()) {
-			$boi_perms[] = $r_bp;
+
+		if (gs_get_conf('GS_BOI_ENABLED')) {
+		$sql_query =
+			'SELECT '.
+				'`p`.`host_id`, `p`.`roles`, '.
+				'`h`.`comment`, `h`.`host` '.
+			'FROM '.
+				'`boi_perms` `p` JOIN '.
+				'`hosts` `h` ON (`h`.`id`=`p`.`host_id`) '.
+			'WHERE `p`.`user_id`='. (int)$r['uid'] .' '.
+			'ORDER BY `h`.`comment`';
+
+		$rs = $DB->execute($sql_query);
+		$boi_perms = array();
+		if (@$rs) {
+			while ($r_bp = $rs->fetchRow()) {
+				$boi_perms[] = $r_bp;
+			}
 		}
-	}
-	}
-	
-?>
+		}
 
+	?>
 
-
 <form method="post" action="<?php echo GS_URL_PATH; ?>">
 <?php
 echo gs_form_hidden($SECTION, $MODULE), "\n";
Index: opt/gemeinschaft/htdocs/gui/mod/features_features.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/mod/features_features.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/mod/features_features.php	(working copy)
@@ -58,13 +58,23 @@
 		if ($cw != $cw_old)
 			gs_callwaiting_activate( $_SESSION['sudo_user']['name'], $cw );
 	}
+	if(isset($_REQUEST['outnum'])){
+		$outbound_num =$_REQUEST['outnum'];
+		
+		$ok = gs_user_outbound_number_set( $_SESSION['sudo_user']['name'], $outbound_num );
+		if (isGsError( $ok )) echo $ok->getMsg();
+			
 	
+	}
+	
 }
 
 
 
 
 
+
+
 $clir = gs_clir_get( $_SESSION['sudo_user']['name'] );
 if (isGsError($clir)) {
 	echo __('Fehler beim Abfragen.'), '<br />', $clir->getMsg();
@@ -122,8 +132,32 @@
 	<td>
 		<small><?php echo __('Das Verhalten ist ggf. von Ihrem Endger&auml;t abh&auml;ngig.'); ?></small>
 	</td>
-</tr>
+	</tr>
 
+<?php
+if( GS_OUTBOUNDNUM_SELECTABLE ){
+	$numbers =  gs_user_outbound_numbers_get( $_SESSION['sudo_user']['name'] );
+	if (isGsError( $numbers )) echo $numbers->getMsg();
+	$sel = " selected";
+	foreach($numbers as $number){
+		if($number['selected'] == 1)$sel = "";
+	}                                                                                                 
+	
+	echo "<td>", __('Angezeigte Rufnummer') ,"</td>\n";
+	echo "<td>\n";
+		echo '<select name="outnum" size="1">', "\n";
+			echo '<option value= ""',$sel,'>' , __('Standardnummer'),"</option>\n";
+			foreach($numbers as $number){
+				$sel ="";
+				$num = $number['number'];
+				if($number['selected'] == 1)$sel =" selected";
+				echo '<option value="',$num,'" ',$sel ,">",$num,"</option>\n";
+			}
+		echo "</select>";
+	echo "</td>\n";
+	
+}
+?>
 
 <tr>
 	<td colspan="6" class="quickchars r">
Index: opt/gemeinschaft/htdocs/gui/mod/help_numbers.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/mod/help_numbers.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/mod/help_numbers.php	(working copy)
@@ -49,18 +49,35 @@
 <tr>
 	<td style="width:140px;"><code>*0 <i><?php echo __('Durchwahl'); ?></i></code></td>
 	<td style="width:420px;">
-		<?php echo __('Einloggen an einem Telefon. Dabei wird die Eingabe der PIN-Nummer verlangt.'); ?>
+		<?php echo __('Benutzer am Endger&auml;t einloggen. Hierzu wird die Eingabe der PIN-Nummer abgefragt'); ?>
 	</td>
 </tr>
 <tr>
 	<td><code>*0*</code></td>
 	<td>
-		<?php echo __('Ausloggen'); ?>
+		<?php echo __('Benutzer am Endger&auml;t ausloggen'); ?>
 	</td>
 </tr>
 </tbody>
 </table>
 
+<?php if ( PB_IMPORTED_ENABLED ) { ?>
+<table cellspacing="1" class="phonebook">
+<thead>
+<tr>
+	<th colspan="2"><?php echo __('Zentrale Kurzwahl'); ?></th>
+</tr>
+</thead>
+<tbody>
+<tr>
+	<td style="width:140px;"><code>*1 <i><?php echo __('Kurzwahlnummer'); ?></i></code></td>
+	<td style="width:420px;">
+		<?php echo __('Wahl der unter der Kurzwahlnummer gespeicherten externen Rufnummer'); ?>
+	</td>
+</tr>
+</tbody>
+</table>	
+<?php } ?>
 
 <table cellspacing="1" class="phonebook">
 <thead>
@@ -72,21 +89,60 @@
 <tr>
 	<td style="width:140px;"><code>*2</code></td>
 	<td style="width:420px;">
-		<?php echo __('Rufumleitung f&uuml;r Anrufe von intern und extern im Fall &quot;immer&quot; auf die Std.-Nummer aktivieren. (Dazu m&uuml;ssen Sie im Men&uuml;punkt &quot;Rufumleitung&quot; eine Std.-Nr. angegeben haben!)'); ?>
+		<?php echo __('Rufumleitung f&uuml;r Anrufe von intern und extern im Fall "immer" auf die Std.-Nummer aktivieren (zur Funktion muss im Men&uuml;punkt "Rufumleitung" eine Std.-Nr. angegeben werden!).'); ?>
 	</td>
 </tr>
 <tr>
-	<td><code>*2 <i><?php echo __('Nummer'); ?></i></code></td>
-	<td>
-		<?php echo __('Tempor&auml;re Rufumleitung f&uuml;r Anrufe von intern und extern im Fall &quot;immer&quot; auf die angegebene Nummer programmieren'); ?>
+	<td style="width:140px;"><code>*2 <i><?php echo __('Nummer'); ?></i></code></td>
+	<td style="width:420px;">
+		<?php echo __('Tempor&auml;re Rufumleitung f&uuml;r Anrufe von intern und extern im Fall "immer" auf die angegebene Nummer aktivieren'); ?>
 	</td>
 </tr>
 <tr>
-	<td><code>*2*</code></td>
-	<td>
+	<td style="width:140px;"><code>*2*</code></td>
+	<td style="width:420px;">
 		<?php echo __('Rufumleitung f&uuml;r Anrufe von intern und extern im Fall &quot;immer&quot; deaktivieren'); ?>
 	</td>
 </tr>
+
+<tr>
+	<td style="width:140px;"><code>*31</code></td>
+	<td style="width:420px;">
+		<?php echo __('Rufumleitung f&uuml;r Anrufe von intern im Fall "immer" auf die Std.-Nummer aktivieren (zur Funktion muss im Men&uuml;punkt "Rufumleitung" eine Std.-Nr. angegeben werden!).'); ?>
+	</td>
+</tr>
+<tr>
+	<td style="width:140px;"><code>*31 <i><?php echo __('Nummer'); ?></i></code></td>
+	<td style="width:420px;">
+		<?php echo __('Tempor&auml;re Rufumleitung f&uuml;r Anrufe von intern im Fall "immer" auf die angegebene Nummer aktivieren'); ?>
+	</td>
+</tr>
+<tr>
+	<td style="width:140px;"><code>*31*</code></td>
+	<td style="width:420px;">
+		<?php echo __('Rufumleitung f&uuml;r Anrufe von intern im Fall &quot;immer&quot; deaktivieren'); ?>
+	</td>
+</tr>
+
+<tr>
+	<td style="width:140px;"><code>*32</code></td>
+	<td style="width:420px;">
+		<?php echo __('Rufumleitung f&uuml;r Anrufe von extern im Fall "immer" auf die Std.-Nummer aktivieren (zur Funktion muss im Men&uuml;punkt "Rufumleitung" eine Std.-Nr. angegeben werden!).'); ?>
+	</td>
+</tr>
+<tr>
+	<td style="width:140px;"><code>*32 <i><?php echo __('Nummer'); ?></i></code></td>
+	<td style="width:420px;">
+		<?php echo __('Tempor&auml;re Rufumleitung f&uuml;r Anrufe von extern im Fall "immer" auf die angegebene Nummer aktivieren'); ?>
+	</td>
+</tr>
+<tr>
+	<td style="width:140px;"><code>*32*</code></td>
+	<td style="width:420px;">
+		<?php echo __('Rufumleitung f&uuml;r Anrufe von extern im Fall &quot;immer&quot; deaktivieren'); ?>
+	</td>
+</tr>
+
 </tbody>
 </table>
 
@@ -101,7 +157,7 @@
 <tr>
 	<td style="width:140px;"><code>80</code></td>
 	<td style="width:420px;">
-		<?php echo __('Eigenen Anrufbeantworter abfragen (Am Snom-Telefon kann daf&uuml;r auch die &quot;Retrieve&quot;-Taste gedr&uuml;ckt werden.)'); ?>
+		<?php echo __('Eigene Mailbox abfragen (an snom-Endger&auml;ten durch Bet&auml;tigen der "Retrieve"-Taste m&ouml;glich)'); ?>
 	</td>
 </tr>
 <tr>
@@ -164,13 +220,13 @@
 <tr>
 	<td style="width:140px;"><code>*5 <i><?php echo __('Durchwahl'); ?></i></code></td>
 	<td style="width:420px;">
-		<?php echo __('Einloggen in die Warteschlange mit der angegebenen Durchwahl'); ?>
+		<?php echo __('Einloggen in Warteschlange mit angegebener Durchwahl'); ?>
 	</td>
 </tr>
 <tr>
 	<td><code>*5 <i><?php echo __('Durchwahl'); ?></i> *</code></td>
 	<td>
-		<?php echo __('Ausloggen aus der Warteschlange mit der angegebenen Durchwahl'); ?>
+		<?php echo __('Ausloggen aus Warteschlange mit angegebener Durchwahl'); ?>
 	</td>
 </tr>
 <tr>
@@ -182,7 +238,30 @@
 </tbody>
 </table>
 
+<table cellspacing="1" class="phonebook">
+<thead>
+<tr>
+	<th colspan="2"><?php echo __('Pickup'); ?></th>
+</tr>
+</thead>
+<tbody>
+<tr>
+	<td style="width:140px;"><code>*8* <i><?php echo __('Nummer PickUp-Gruppe'); ?></i></code></td>
+	<td style="width:420px;">
+		<?php echo __('Pickup aus der Gruppe: mehrere Telefone k&ouml;nnen in einer Pick-Up-Gruppe zusammengefasst werden. Anrufe an einem Telefon der jeweiligen Gruppe k&ouml;nnen von anderen Telefonen der Gruppe herangeholt und beantwortet werden.'); ?>
+	</td>
+</tr>
+<tr>
+	<td style="width:140px;"><code>*81* <i><?php echo __('Nebenstelle'); ?></i></code></td>
+	<td style="width:420px;">
+		<?php echo __('Pickup gezielt: Anrufe an einem Telefon mit bekannter Nebenstellen-Nummer k&ouml;nnen herangeholt und beantwortet werden.'); ?>
+	</td>
+</tr>
 
+</tbody>
+</table>
+
+
 <table cellspacing="1" class="phonebook">
 <thead>
 <tr>
@@ -193,12 +272,12 @@
 <tr>
 	<td style="width:140px;"><code>88 <i><?php echo __('Konf.nr.'); ?></i></code></td>
 	<td style="width:420px;">
-		<?php echo __('Einen Konferenzraum (nach 88 eine 3- oder 4-stellige Nummer) betreten bzw. er&ouml;ffnen. Wenn die Konferenz leer ist, kann eine PIN-Nr. gesetzt werden (f&uuml;r keine PIN # dr&uuml;cken). Ansonsten muss eine ggf. f&uuml;r diesen Raum gesetzte PIN eingegeben werden.'); ?>
+		<?php echo __('Einen Konferenzraum betreten bzw. er&ouml;ffnen (dazu 88 und eine beliebige 3- oder 4-stellige Nummer w&auml;hlen). Ist der Konferenzraum leer, so kann eine PIN gesetzt werden (ohne PIN Taste # dr&uuml;cken). Ist eine PIN vergeben, so muss diese zum Betreten des Konferenzraumes eingegeben werden.'); ?>
 	</td>
 </tr>
 <tr>
-	<td><code>88000</code> <?php echo __('oder'); ?> <code>880000</code></td>
-	<td>
+	<td style="width:140px;"><code>88000</code> <?php echo __('oder'); ?> <code>880000</code></td>
+	<td style="width:420px;">
 		<?php echo __('Einen freien Konferenzraum finden. Die Nummer der Konferenz wird beim Betreten angesagt. (Die anderen Teilnehmer w&auml;hlen dann <code>88 <i>Konferenznr.</i></code>, s.o.)'); ?>
 	</td>
 </tr>
Index: opt/gemeinschaft/htdocs/gui/mod/blacklists_blacklist.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/mod/blacklists_blacklist.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/mod/blacklists_blacklist.php	(working copy)
@@ -26,6 +26,9 @@
 \*******************************************************************/
 
 defined('GS_VALID') or die('No direct access.');
+include_once( GS_DIR .'inc/gs-fns/gs_user_get.php' );
+include_once( GS_DIR .'inc/gs-fns/gs_blacklist_add.php' );
+include_once( GS_DIR .'inc/gs-fns/gs_blacklist_del.php' );
 
 echo '<h2>';
 if (@$MODULES[$SECTION]['icon'])
Index: opt/gemeinschaft/htdocs/gui/styles/gemeinschaft.css
===================================================================
--- opt/gemeinschaft/htdocs/gui/styles/gemeinschaft.css	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/styles/gemeinschaft.css	(working copy)
@@ -35,7 +35,7 @@
 }
 
 #headerboxes {
-	background: #00e url(../img/header.png);
+	background: #ffffff url(../img/header.png);
 	border-width: 1px;
 	border-style: solid;
 	border-color: #99f #004 #004 #66f;
@@ -121,3 +121,17 @@
 .quickchars a:hover {
 	color: #00e;
 }
+
+#boxtitle {
+        float: left;
+        margin: 1px 0 0 5px;
+}
+#boxtitle h1 {
+        color: #000000;
+        font-size: 20px;
+        font-weight: normal;
+        line-height: 1.6em;
+        display: inline;
+        margin: 0;
+        padding: 0 0 0 5px; 
+}
Index: opt/gemeinschaft/htdocs/gui/index.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/index.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/index.php	(working copy)
@@ -91,12 +91,10 @@
 	}
 }
 
-
 include_once( GS_DIR .'inc/gettext.php' );
 require_once( GS_DIR .'htdocs/gui/inc/session.php' );  # defines $DB
 require_once( GS_HTDOCS_DIR .'inc/modules.php' );
 
-
 # get section & module
 #
 if (array_key_exists('s', $_REQUEST)) {
@@ -358,7 +356,6 @@
 <title><?php
 	switch ($GS_INSTALLATION_TYPE) {
 		case 'gpbx': echo    'GPBX'                         ; break;
-		//default    : echo __('Gemeinschaft Telefon-Manager');
 		default    : echo    'Gemeinschaft';
 	}
 ?></title>
@@ -428,7 +425,6 @@
 			break;
 		default    :
 			echo '<img alt=" " src="', GS_URL_PATH ,'img/gemeinschaft-32.png" class="fl" />' ,"\n";
-			//echo '<h1>', __('Telefon-Manager') ,'</h1>' ,"\n";
 			echo '<h1>', 'Gemeinschaft' ,'</h1>' ,"\n";
 	}
 ?>
@@ -441,7 +437,7 @@
 		|| (@$_SESSION['sudo_user']['name'] != ''
 		&&  preg_match('/\\b'.(@$_SESSION['sudo_user']['name']).'\\b/', GS_GUI_SUDO_ADMINS)
 		)) {
-			if (! in_array($SECTION, array('logout'), true)) {
+			if (! in_array($SECTION, array('logout'), true) && $GS_INSTALLATION_TYPE == "gpbx" ) {
 				echo '<a href="', gs_url('system', 'shutdown') ,'" title="', __('Auschalten / Neustarten ...') ,'" class="fr" style="display:block; margin:1px 6px;"><img alt="', __('Ausschalten ...') ,'" src="', GS_URL_PATH ,'img/power.png" /></a>' ,"\n";
 			}
 		}
@@ -513,14 +509,14 @@
 			if (array_key_exists('inmenu', $modinfo) && ! $modinfo['inmenu']) {
 				continue;
 			}
+
+			if ( !( is_file( 'mod/' . $sectname . '_' . $modname . '.php' ) ) )
+				continue;
+
 			echo '<li class="leaf"><a href="', gs_url($sectname, $modname) ,'" class="';
 			if ($modname == $MODULE) echo 'active';
 			echo '"';
-			/*
-			if (array_key_exists('boi_url', $modinfo)) {
-				echo ' onclick="try{ return gs_boi_menu_sc(\'', htmlEnt($modinfo['boi_url']) ,'\'); }catch(e){}"';
-			}
-			*/
+
 			echo '><img alt=" " src="', GS_URL_PATH ,'img/tree.gif" />', $modinfo['title'] ,'</a></li>', "\n";
 		}
 		echo '</ul>', "\n";
@@ -576,14 +572,6 @@
 			
 		} else {
 			
-			/*
-			$db_slave = gs_db_slave_connect();
-			if (! $db_slave) {
-				echo 'Could not connect to DB.';
-				return;
-			}
-			*/
-			
 			echo '<div class="nobr fr">' ,"\n";
 			echo ' &nbsp;<button type="submit">&rarr;</button>';
 			echo '</div>' ,"\n";
@@ -787,6 +775,6 @@
 </div>
 
 <div class="nofloat"></div>
-<div id="copyright"><a target="_blank" href="http://www.amooma.de/"><img alt="&copy; amooma" src="<?php echo GS_URL_PATH; ?>img/amooma-c.gif" /></a></div>
+<!-- <div id="copyright"><a target="_blank" href="http://www.amooma.de/"><img alt="&copy; amooma" src="<?php echo GS_URL_PATH; ?>img/amooma-c.gif" /></a></div> -->
 </body>
 </html>
\ No newline at end of file
Index: opt/gemeinschaft/htdocs/gui/inc/session.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/inc/session.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/inc/session.php	(working copy)
@@ -190,23 +190,31 @@
 $DB = @gs_db_master_connect();
 if (! $DB) die( 'Could not connect to database.' );
 
-
 # function to check if it's one of our users:
 #
 function get_user( $user )
 {
 	global $DB;
 	
-	$rs = $DB->execute(
+	if (GS_MASTER_SLAVE_MODE == true) {
+			$rs = $DB->execute(
 'SELECT
-	`u`.`id`, `u`.`user`, `u`.`firstname`, `u`.`lastname`, `s`.`name` `ext`,
-	`u`.`host_id`, `h`.`is_foreign` `host_is_foreign`
+`u`.`id`, `u`.`user`, `u`.`firstname`, `u`.`lastname`, `u`.`user` `ext`
 FROM
-	`users` `u` JOIN
-	`ast_sipfriends` `s` ON (`s`.`_user_id`=`u`.`id`) LEFT JOIN
-	`hosts` `h` ON (`h`.`id`=`u`.`host_id`)
+`users` `u`
 WHERE `u`.`user`=\''. $DB->escape($user) .'\''
-);
+		);
+		
+	} else {
+			$rs = $DB->execute(
+'SELECT
+`u`.`id`, `u`.`user`, `u`.`firstname`, `u`.`lastname`, `s`.`name` `ext`
+FROM
+`users` `u` JOIN
+`ast_sipfriends` `s` ON (`s`.`_user_id`=`u`.`id`)
+WHERE `u`.`user`=\''. $DB->escape($user) .'\''
+		);
+	}
 	if (! $rs)
 		die( __('Failed to get user.') );
 	if (! ($u = $rs->fetchRow()))
Index: opt/gemeinschaft/htdocs/gui/inc/modules.php
===================================================================
--- opt/gemeinschaft/htdocs/gui/inc/modules.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/gui/inc/modules.php	(working copy)
@@ -65,7 +65,7 @@
 $tmp = array(
 	15=>array(
 		'k' => 'common' ,
-		's' => array('title' => __('Gemeinschaft' ))  ),
+		's' => array('title' => __('Intern' ))  ),
 	25=>array(
 		'k' => 'private',
 		's' => array('title' => __('Pers&ouml;nlich' ))  )
@@ -74,7 +74,7 @@
 	$pos = (int)gs_get_conf('GS_PB_IMPORTED_ORDER', 9) * 10;
 	$tmp[$pos] = array(
 		'k' => 'imported',
-		's' => array('title' => __('Importiert'))
+		's' => array('title' => __('Extern'))
 	);
 }
 kSort($tmp);
@@ -95,7 +95,9 @@
 	'sub' => array(
 		'out'          => array('title' => __('gew&auml;hlt')),
 		'missed'       => array('title' => __('verpasst')),
-		'in'           => array('title' => __('angenommen'))
+		'in'           => array('title' => __('angenommen')),
+		'missed_queue' => array('title' => __('verpasst (Wart.)')),
+		'in_queue'     => array('title' => __('angenommen (Wart.)'))
 	)
 );
 
@@ -119,12 +121,20 @@
 	'sub' => array(
 		'forwards'     => array('title' => __('Rufumleitung')),
 		'extnumbers'   => array('title' => __('externe Nummern')),
-		'queues'       => array('title' => __('Warteschlangen'))
+		'queues'       => array('title' => __('Warteschlangen')),
+		'hgroups'      => array('title' => __('Sammelanschl&uuml;sse'))
 	)
 );
 
 #####################################################################
 
+$MODULES['blacklists' ]=  array('title' => __('Sperr-/VIP-Liste'),
+				'icon'  => 'crystal-svg/%s/act/fail.png',
+	'sub' => array(
+		'blacklist'    => array('title' => __('Sperr-/VIP-Liste'))
+	)
+);
+
 $MODULES['monitor'  ]=  array(
 	'title' => __('Monitor'),
 	'icon'  => 'crystal-svg/%s/app/display.png',
@@ -133,6 +143,7 @@
 		'queues'       => array('title' => __('Warteschlangen')),
 		'pgrps'        => array('title' => __('Rufannahmegrp.'))
 	)
+
 );
 if (gs_get_conf('GS_GUI_MON_PEERS_ENABLED')) {
 $MODULES['monitor'  ]['sub'][
@@ -154,27 +165,17 @@
 
 #####################################################################
 
-$MODULES['keys'     ]=  array(
-	'title' => __('Tastenbelegung'),
+$MODULES['phonesettings'    ]=  array('title' => __('Telefoneinstellungen'),     //TRANSLATE ME
 	'icon'  => 'crystal-svg/%s/app/keyboard.png',
 	'sub' => array(
+	'keys'   => array('title' => __('Tastenbelegung')),  //TRANSLATE ME
+	'ringtones'   => array('title' => __('Klingelt&ouml;ne')),//TRANSLATE ME
+	'volume'   => array('title' => __('Lautst&auml;rke'))//TRANSLATE ME
 	)
 );
-$MODULES['keys'     ]['sub'][
-		'keyprof'     ]=  array('title' => __('Tastenbelegung'));
 
 #####################################################################
 
-$MODULES['ringtones']=  array(
-	'title' => __('Klingelt&ouml;ne'),
-	'icon'  => 'crystal-svg/%s/app/knotify.png',
-	'sub' => array(
-		'ringtones'    => array('title' => __('Klingelt&ouml;ne'))
-	)
-);
-
-#####################################################################
-
 $MODULES['stats'    ]=  array(
 	'title' => __('Statistik'),
 	'icon'  => 'crystal-svg/%s/app/yast_partitioner.png',
@@ -211,18 +212,13 @@
 
 #####################################################################
 
-$MODULES['help'     ]=  array(
-	'title' => __('Hilfe'),
-	'icon'  => 'crystal-svg/%s/act/help.png',
-	'boi_ok'=> false,
+$MODULES['help'     ]=  array('title' => __('Hilfe'),
+                              'icon'  => 'crystal-svg/%s/act/help.png',
 	'sub' => array(
-		'numbers'      => array('title' => __('Service-Nummern'))
+		'numbers'      => array('title' => __('Service-Nummern')),
+		'snom'         => array('title' => __('snom-Telefone'))
 	)
 );
-if (gs_get_conf('GS_SNOM_PROV_ENABLED')) {
-$MODULES['help'     ]['sub'][
-		'snom']        =  array('title' => __('Snom'));
-}
 
 #####################################################################
 
@@ -234,9 +230,11 @@
 	'sub' => array(
 		'overview'     => array('title' => __('&Uuml;bersicht')),
 		'users'        => array('title' => __('Benutzer')),
+      'agents'        => array('title' => __('Agenten')),
 		'groups'       => array('title' => __('Benutzergruppen')),
 		'queues'       => array('title' => __('Warteschlangen')),
-		'pgroups'      => array('title' => __('Rufannahmegrp.#pl')),
+		'pgroups'      => array('title' => __('PickUp-Gruppen')),
+		'hgroups'      => array('title' => __('Sammelanschl&uuml;sse')),
 		//'ivrs'         => array('title' => __('IVRs')),
 		'calls'        => array('title' => __('CDRs')),
 		'reload'       => array('title' => __('Reload'))
@@ -363,4 +361,4 @@
 #####################################################################
 
 
-?>
\ No newline at end of file
+?>
Index: opt/gemeinschaft/htdocs/prov/snom/settings.php
===================================================================
--- opt/gemeinschaft/htdocs/prov/snom/settings.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/prov/snom/settings.php	(working copy)
@@ -423,7 +423,6 @@
 	}
 }
 
-
 # get host for user
 #
 $host = @gs_prov_get_host_for_user_id( $db, $user_id );
@@ -432,7 +431,6 @@
 }
 $pbx = $host;  # $host might be changed if SBC configured
 
-
 # who is logged in at that phone?
 #
 $user = @gs_prov_get_user_info( $db, $user_id );
@@ -515,17 +513,15 @@
 psetting('time_24_format'   , 'on'     , true);
 psetting('message_led_other', 'off'    );
 psetting('use_backlight'    , 'on'     , true);  # always | on | off | dim (370, >= 7.1.33)
-//psetting('headset_device'   , 'headset_rj', true);  # wuerde Default auf Headset am RJ14-Stecker setzen
-psetting('headset_device'   , 'none'   , true);
 psetting('ethernet_detect'  , 'on'     );  # Warnung falls kein Ethernet
-psetting('ethernet_replug'  , 'reboot' );
+psetting('ethernet_replug'  , 'nothing' );
 psetting('reboot_after_nr'  , '5'      );  # nach 5 Min. ohne Registrierung neu starten
 psetting('admin_mode'       , 'off'    , true);  # wenn die Einstellung nicht writable ist, ist auch kein Admin-Login moeglich
 psetting('admin_mode_password'         , '0000');
 psetting('admin_mode_password_confirm' , '0000');
+psetting('ignore_security_warning', 'on' );
 
 
-
 #####################################################################
 #  Network / Advanced Network / SIP
 #####################################################################
@@ -616,7 +612,7 @@
 psetting('http_port'       , '80' );
 psetting('https_port'      , '443');
 psetting('web_logout_timer', '10' );
-psetting('with_flash'      , 'on' , true);
+psetting('with_flash'      , 'off' , true);
 
 psetting('http_proxy'      , '' );  # IP address or URL
 psetting('http_client_user', '' );
@@ -629,43 +625,57 @@
 #####################################################################
 
 psetting('pickup_indication'    , 'on' );  # Piepton wenn Pickup moeglich
-psetting('keytones'             , 'on' );
+psetting('keytones'             , 'off' );
 psetting('holding_reminder'     , 'on' );
 psetting('alert_info_playback'  , 'on' );
 psetting('mute'                 , 'off', true);  # mute mic off
 psetting('disable_speaker'      , 'off', true);  # disable casing speaker off
 psetting('dtmf_speaker_phone'   , 'off', true);
 psetting('release_sound'        , 'off');
-if ($phone_model >= '370') {
-	psetting('vol_handset_mic'      ,  '5' , true);  # 1 - 8, Default: 4
-	psetting('vol_headset_mic'      ,  '6' , true);  # 1 - 8, Default: 4
-	psetting('vol_speaker_mic'      ,  '4' , true);  # 1 - 8, Default: 4
+psetting('mwi_notification'     , 'silent');  # keine akustischen Hinweise wenn neue Nachrichten
+psetting('mwi_dialtone'         , 'stutter');  # stotternder Waehlton wenn neue Nachrichten
+psetting('silence_compression'  , 'off');  # kann Asterisk (noch?) nicht
+psetting('ringer_headset_device', 'speaker');  # Klingeltonausgabe bei Kopfhoerer (headset|speaker)
+
+$volumes =  gs_phonesettings_volume_get( $user['user'] );
+
+$handset = 5;
+$headset = 6;
+$speaker = 4;
+if(isset($volumes['handsetmic']))$handset = $volumes['handsetmic'];
+if(isset($volumes['headsetmic']))$headset = $volumes['headsetmic'];
+if(isset($volumes['casemic']))$speaker = $volumes['casemic'];
+
+if ($phone_type >= '370') {
+	psetting('vol_handset_mic'      ,  $handset , true);  # 1 - 8, Default: 4
+	psetting('vol_headset_mic'      ,  $headset , true);  # 1 - 8, Default: 4
+	psetting('vol_speaker_mic'      ,  $speaker , true);  # 1 - 8, Default: 4
 	psetting('vol_speaker'          ,  '5' , true);  # 0 - 15, Default: 8
 	psetting('vol_handset'          , '10' , true);  # 0 - 15, Default: 8
 	psetting('vol_headset'          , '10' , true);  # 0 - 15, Default: 8
 	psetting('vol_ringer'           ,  '8' , true);  # 1 - 15
 } else {
-	psetting('vol_handset_mic'      ,  '4' , true);  # 1 - 8, Default: 4
-	psetting('vol_headset_mic'      ,  '6' , true);  # 1 - 8, Default: 4
-	psetting('vol_speaker_mic'      ,  '6' , true);  # 1 - 8, Default: 4
+	psetting('vol_handset_mic'      ,  $handset , true);  # 1 - 8, Default: 4
+	psetting('vol_headset_mic'      ,  $headset , true);  # 1 - 8, Default: 4
+	psetting('vol_speaker_mic'      ,  $speaker , true);  # 1 - 8, Default: 4
 	psetting('vol_speaker'          , '10' , true);  # 0 - 15, Default: 8
 	psetting('vol_handset'          , '11' , true);  # 0 - 15, Default: 8
 	psetting('vol_headset'          , '10' , true);  # 0 - 15, Default: 8
 	psetting('vol_ringer'           ,  '7' , true);  # 1 - 15
 }
-psetting('mwi_notification'     , 'silent');  # keine akustischen Hinweise wenn neue Nachrichten
-psetting('mwi_dialtone'         , 'stutter');  # stotternder Waehlton wenn neue Nachrichten
-psetting('silence_compression'  , 'off');  # kann Asterisk (noch?) nicht
-psetting('ringer_headset_device', 'speaker');  # Klingeltonausgabe bei Kopfhoerer (headset|speaker)
 
-
-
 #####################################################################
 #  Behavior
 #####################################################################
 
-psetting('callpickup_dialoginfo'  , 'on' );
-psetting('show_xml_pickup'        , 'on' );
+if ( GS_BUTTONDAEMON_USE == true ) {
+	psetting('callpickup_dialoginfo'  , 'off' );
+	psetting('show_xml_pickup'        , 'off' );
+} else {
+	psetting('callpickup_dialoginfo'  , 'on' );
+	psetting('show_xml_pickup'        , 'on' );
+	
+}
 psetting('show_name_dialog'       , 'off');
 psetting('ringing_time'           , '500');  # wird im Dialplan begrenzt
 psetting('block_url_dialing'      , 'on' );  # nur Ziffern erlauben
@@ -692,7 +702,7 @@
 psetting('cancel_on_hold'         , 'on' );
 psetting('cancel_missed'          , 'on' );
 psetting('cancel_desktop'         , 'off');
-psetting('cw_dialtone'            , 'on' );
+psetting('cw_dialtone'            , 'on',true );
 psetting('auto_connect_indication', 'on' );
 psetting('auto_connect_type'      , 'auto_connect_type_handsfree');
 psetting('privacy_in'             , 'off');  # accept anonymous calls
@@ -712,19 +722,27 @@
 psetting('mailbox_active'         , 'off');  # pay attention to the mailbox of the
                                              # active identity only?
 psetting('speaker_dialer'         , 'on' );
-psetting('no_dnd'                 , 'off');
-$dnd_mode = 'off';
-$cf = gs_callforward_get( $user['user'] );
-if (! isGsError($cf) && is_array($cf)) {
-	if ( @$cf['internal']['always']['active'] != 'no'
-	  || @$cf['external']['always']['active'] != 'no' )
-	{
-		$dnd_mode = 'on';  //FIXME - bad hack!
+if ( GS_BUTTONDAEMON_USE == false ) {
+	psetting('no_dnd'             , 'off');
+	$dnd_mode = 'off';
+	$cf = gs_callforward_get( $user['user'] );
+	if (! isGsError($cf) && is_array($cf)) {
+		
+		if ( @$cf['internal']['always']['active'] != 'no'
+		  || @$cf['external']['always']['active'] != 'no' )
+		{
+			$dnd_mode = 'on';  //FIXME - bad hack!
+		}
 	}
+	psetting('dnd_mode'               , $dnd_mode, true);
+	psetting('dnd_on_code'            , 'dnd-on');
+	psetting('dnd_off_code'           , 'dnd-off');
 }
-psetting('dnd_mode'               , $dnd_mode, true);
-psetting('dnd_on_code'            , 'dnd-on');
-psetting('dnd_off_code'           , 'dnd-off');
+else{
+	psetting('no_dnd'                 , 'on');
+	psetting('dnd_on_code'            , '');
+	psetting('dnd_off_code'           , '');
+}
 psetting('preselection_nr'        , '');
 
 
@@ -779,7 +797,13 @@
 setting('user_dtmf_info'          ,$i, (_snomAppCmp($fw_vers_nrml, '7.1.33') >0) ? 'sip_info_only':'on');
 setting('user_mailbox'            ,$i, 'mailbox');
 setting('user_dp_exp'             ,$i, ''   );  # see http://wiki.snom.com/Settings/user_dp_exp
-setting('user_dp_str'             ,$i, ''   );  # see http://wiki.snom.com/Dial_Plan
+
+if(GS_SNOM_USE_AUTOPREFIX <= 0) {
+	setting('user_dp_str'             ,$i, ''   );  # see http://wiki.snom.com/Dial_Plan
+} else {
+	setting('user_dp_str'             ,$i, '|^([0-9]{'. GS_SNOM_USE_AUTOPREFIX .',})|sip:0\1@\d|'   );
+}
+
 setting('user_dp'                 ,$i, ''   );
 setting('user_q'                  ,$i, '1.0');
 setting('user_descr_contact'      ,$i, 'off');  # not supported by Asterisk anyway
@@ -793,7 +817,10 @@
 setting('keepalive_interval'      ,$i, '14' );
 setting('user_full_sdp_answer'    ,$i, 'on' );
 setting('user_failover_identity'  ,$i, 'none');
-setting('user_xml_screen_url'     ,$i, ''   );
+if ( ( $phone_type == '370' ) && ( file_exists( 'idle370.xml' ) ) )
+	setting('user_xml_screen_url'     ,$i, $prov_url_snom . 'idle370.xml'   );
+else
+	setting('user_xml_screen_url'     ,$i, ''   );
 setting('user_event_list_subscription',$i, 'off');
 setting('user_event_list_uri'         ,$i, '');
 setting('user_presence_subscription'  ,$i, 'off');
@@ -873,19 +900,29 @@
 psetting('dkey_conf'     , 'keyevent F_CONFERENCE');
 psetting('dkey_transfer' , 'keyevent F_TRANSFER'  );
 psetting('dkey_hold'     , 'keyevent F_R'         ); # or F_HOLD
-psetting('dkey_dnd'      , 'keyevent F_DND'       );
+if( GS_BUTTONDAEMON_USE == true ) {
+	psetting('dkey_dnd'      ,  'url '. $prov_url_snom .'dnd.php?t=1&m=$mac&u=$user_name1'    );
+}
+else{
+	psetting('dkey_dnd'      , 'keyevent F_DND'       );
+}
 psetting('dkey_record'   , 'keyevent F_REC'       );
 psetting('dkey_directory', 'keyevent F_ADR_BOOK'  ); # or F_DIRECTORY
-psetting('dkey_menu'     , 'keyevent F_MENU'      );
+psetting('dkey_menu'     , 'url '. $prov_url_snom .'menu.php?m=$mac&u=$user_name1' );
 psetting('dkey_redial'   , 'keyevent F_REDIAL'    );
 
 psetting('dkey_directory', 'url '. $prov_url_snom .'pb.php?m=$mac&u=$user_name1');
 psetting('dkey_redial'   , 'url '. $prov_url_snom .'dial-log.php?user=$user_name1');
 # so geht die Retrieve-Taste auch ohne neue Nachrichten:
 psetting('dkey_retrieve' , 'speed voicemail');
-
-
-
+//For snom 300
+if($phone_type == "300"){
+	setting('fkey'        , 3,  'url '. $prov_url_snom .'pb.php?m=$mac&u=$user_name1',  array('context'=>'active') );
+	setting('fkey'        , 2,  'url '. $prov_url_snom .'dial-log.php?user=$user_name1', array('context'=>'active'));
+	setting('fkey'        , 4,  'keyevent F_TRANSFER' ,  array('context'=>'active') );
+	setting('fkey'        , 5,  'keyevent F_MUTE' ,  array('context'=>'active') );
+	
+}
 #####################################################################
 #  Action URLs 
 #####################################################################
@@ -912,91 +949,59 @@
 psetting('action_log_on_url'         , '');
 psetting('action_log_off_url'        , '');
 
-
-
 #####################################################################
 #  Keys
 #####################################################################
 
 # reset all keys
 #
-$max_key = 12+(42*3) -1;
-for ($i=0; $i<=$max_key; ++$i) {
-	setting('fkey'        , $i, 'line', array('context'=>'active'));
+$maxkeys = 137;
+//the snom 300 has no function-keys that should be configured
+if($phone_type == "300")
+	$maxkeys = -1;
+
+for ($i=0; $i<= $maxkeys; ++$i) {
+	if ( GS_BUTTONDAEMON_USE == false ) {
+		setting('fkey'        , $i, 'line', array('context'=>'active'));
+	}
+	else{
+		setting('fkey'        , $i, 'button ' . ($i+1), array('context'=>'active'));
+	}
 	//setting('fkey_context', $i, 'active');
 }
 
-/*  //FIXME
-
 # user defined keys
 #
-$keys = gs_keys_snom_get( $user['user'] );
-if (is_array($keys)) {
-	foreach ($keys as $kname => $kinfo) {
-		if (! preg_match('/^f(\d{1,2})$/S', $kname, $m)) continue;
-		if (trim(@$kinfo['val']) != '')
-			setting('fkey',@$m[1], 'dest <sip:'. @$kinfo['val'] .'@'. $host .'>|*81*', array('context'=>'active'));
+if ( GS_BUTTONDAEMON_USE == false ) {
+	$keys = gs_keys_snom_get( $user['user'] );
+	if (is_array($keys)) {
+		foreach ($keys as $kname => $kinfo) {
+			if (! preg_match('/^f(\d{1,2})$/S', $kname, $m)) continue;
+			if ((int) $m[1] > $maxkeys) continue;
+			if (trim(@$kinfo['val']) != '')
+				setting('fkey',@$m[1], 'dest <sip:'. @$kinfo['val'] .'@'. $host .'>|*81*', array('context'=>'active'));
+		}
 	}
-}
 
 # keys for pickup groups
 #
-$rs = $db->execute( 'SELECT DISTINCT(`p`.`id`) `id` FROM `pickupgroups_users` `pu` JOIN `pickupgroups` `p` ON (`p`.`id`=`pu`.`group_id`) WHERE `pu`.`user_id`='. $user_id .' ORDER BY `p`.`id` LIMIT 6' );
-$key = 6;
-while ($r = $rs->fetchRow()) {
-	setting('fkey',$key, 'dest <sip:*8*'. str_pad($r['id'], 5, '0', STR_PAD_LEFT) .'@'. $host .'>|*82', array('context'=>'active'));
+	$rs = $db->execute( 'SELECT DISTINCT(`p`.`id`) `id` FROM `pickupgroups_users` `pu` JOIN `pickupgroups` `p` ON (`p`.`id`=`pu`.`group_id`) WHERE `pu`.`user_id`='. $user_id .' ORDER BY `p`.`id` LIMIT 6' );
+	$key = 6;
+	while ($r = $rs->fetchRow()) {
+		setting('fkey',$key, 'dest <sip:*8*'. str_pad($r['id'], 5, '0', STR_PAD_LEFT) .'@'. $host .'>|*82', array('context'=>'active'));
 	//psetting('fkey_context'. $key, '1');
 	//psetting('fkey_context'. $key, 'active');
-	++$key;
-}
-*/
-
-$softkeys = null;
-$GS_Softkeys = gs_get_key_prov_obj( $phone_type );
-if ($GS_Softkeys->set_user( $user['user'] )) {
-	if ($GS_Softkeys->retrieve_keys( $phone_type, array(
-		'{GS_PROV_HOST}'      => gs_get_conf('GS_PROV_HOST'),
-		'{GS_P_PBX}'          => $pbx,
-		'{GS_P_EXTEN}'        => $user_ext,
-		'{GS_P_ROUTE_PREFIX}' => $hp_route_prefix,
-		'{GS_P_USER}'         => $user['user']
-	) )) {
-		$softkeys = $GS_Softkeys->get_keys();
+		++$key;
 	}
 }
-if (! is_array($softkeys)) {
-	gs_log( GS_LOG_WARNING, 'Failed to get softkeys' );
-} else {
-	foreach ($softkeys as $key_name => $key_defs) {
-		if (array_key_exists('slf', $key_defs)) {
-			$key_def = $key_defs['slf'];
-		} elseif (array_key_exists('inh', $key_defs)) {
-			$key_def = $key_defs['inh'];
-		} else {
-			continue;
-		}
-		$key_idx = (int)lTrim(subStr($key_name,1),'0');
-		setting('fkey', $key_idx, $key_def['function'] .' '. $key_def['data'], array('context'=>'active'));
-	}
-}
-
-
 # GUI softkeys
 #
-/*
-psetting('gui_fkey1', 'F_DIALOG');
-psetting('gui_fkey2', 'F_CALL_LIST');
-psetting('gui_fkey3', 'F_ADR_BOOK');
-psetting('gui_fkey4', 'F_PRESENCE');
-*/
 psetting('gui_fkey1', '');
 psetting('gui_fkey2', '');
 psetting('gui_fkey3', '');
 psetting('gui_fkey4', '');
 # these settings do not use the idx attribute in XML
 
-
-
 #####################################################################
 #  Klingeltoene
 #####################################################################
@@ -1151,6 +1156,7 @@
 #####################################################################
 
 $lang_releases = array(  # in descending order!
+	'7.1.39',
 	'7.1.33',
 	'7.1.30',
 	'7.1.19',
Index: opt/gemeinschaft/htdocs/prov/snom/pb.php
===================================================================
--- opt/gemeinschaft/htdocs/prov/snom/pb.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/prov/snom/pb.php	(working copy)
@@ -150,7 +150,7 @@
 	foreach ($typeToTitle as $t => $title) {
 		$cq = 'SELECT COUNT(*) FROM ';
 		switch ($t) {
-		case 'gs'      : $cq .= '`users` WHERE `nobody_index` IS NULL'; break;
+		case 'gs'      : $cq .= '`users` WHERE `nobody_index` IS NULL AND `invisible`=0'; break;
 		case 'imported': $cq .= '`pb_ldap`'                           ; break;
 		case 'prv'     : $cq .= '`pb_prv` WHERE `user_id`='. $user_id ; break;
 		default        : $cq  = false;
@@ -321,11 +321,15 @@
 		while ($r = $rs->fetchRow()) {
 			$name = $r['ln'] .( strLen($r['fn'])>0 ? (', '.$r['fn']) : '' );
 			$number = $r['ext'];
-			echo
-				'<DirectoryEntry>',
-					'<Name>', snomXmlEsc( $name ) ,'</Name>',
-					'<Telephone>', $number ,'</Telephone>',
-				'</DirectoryEntry>', "\n";
+			if( GS_SNOM_USE_AUTOPREFIX > 0 ){
+				if(  substr( $r['ext'], 0, 1 ) === "0" ){
+					$number =  substr( $r['ext'],1 );
+				}
+			}
+			echo '<DirectoryEntry>',
+			       '<Name>', snomXmlEsc( $name ) ,'</Name>',
+			       '<Telephone>', $number ,'</Telephone>',
+			     '</DirectoryEntry>', "\n";
 		}
 		defineKeys();
 		echo '</SnomIPPhoneDirectory>', "\n";
@@ -381,16 +385,32 @@
 	  ('. ($likeFn ? ($likeFn .' AND ') : '') .'
 	  `u`.`firstname` REGEXP \'^'. $db->escape($regex) .'\' )';
 	}
+	
+if (GS_MASTER_SLAVE_MODE == true) {
 	$query =
+'SELECT `u`.`lastname` `ln`, `u`.`firstname` `fn`, `u`.`user` `ext`
+FROM
+	`users` `u`
+WHERE
+	`u`.`invisible`=0 AND
+	`u`.`nobody_index` IS NULL
+	'. ($where ? ('AND ('. $where .')') : '') .'
+ORDER BY `u`.`lastname`, `u`.`firstname`
+LIMIT '. $num_results;
+}
+else {
+	$query =
 'SELECT `u`.`lastname` `ln`, `u`.`firstname` `fn`, `s`.`name` `ext`
 FROM
 	`users` `u` JOIN
 	`ast_sipfriends` `s` ON (`s`.`_user_id`=`u`.`id`)
 WHERE
+	`u`.`invisible`=0 AND
 	`u`.`nobody_index` IS NULL
 	'. ($where ? ('AND ('. $where .')') : '') .'
 ORDER BY `u`.`lastname`, `u`.`firstname`
 LIMIT '. $num_results;
+}
 	$rs = $db->execute($query);
 	if ($rs->numRows() !== 0) {
 		
@@ -401,11 +421,10 @@
 		while ($r = $rs->fetchRow()) {
 			$name = $r['ln'] .( strLen($r['fn'])>0 ? (', '.$r['fn']) : '' );
 			$number = $r['ext'];
-			echo
-				'<DirectoryEntry>',
-					'<Name>', snomXmlEsc( $name ) ,'</Name>',
-					'<Telephone>', $number ,'</Telephone>',
-				'</DirectoryEntry>', "\n";
+			echo '<DirectoryEntry>',
+				'<Name>', snomXmlEsc( $name ),' (',snomXmlEsc( $number ) ,')</Name>',
+			       '<Telephone>', $number ,'</Telephone>',
+			     '</DirectoryEntry>', "\n";
 		}
 		defineKeys();
 		echo '</SnomIPPhoneDirectory>', "\n";
@@ -491,11 +510,15 @@
 		while ($r = $rs->fetchRow()) {
 			$name = $r['ln'] .( strLen($r['fn'])>0 ? (', '.$r['fn']) : '' );
 			$number = $r['number'];
-			echo
-				'<DirectoryEntry>',
-					'<Name>', snomXmlEsc( $name ) ,'</Name>',
-					'<Telephone>', $number ,'</Telephone>',
-				'</DirectoryEntry>', "\n";
+			if( GS_SNOM_USE_AUTOPREFIX > 0 ){
+				if(  substr( $r['number'], 0, 1 ) === "0" ){
+					$number =  substr( $r['number'],1 );
+				}
+			}
+			echo '<DirectoryEntry>',
+			       '<Name>', snomXmlEsc( $name ) ,'</Name>',
+			       '<Telephone>', $number ,'</Telephone>',
+			     '</DirectoryEntry>', "\n";
 		}
 		defineKeys();
 		echo '</SnomIPPhoneDirectory>', "\n";
@@ -520,4 +543,4 @@
 #################################### PRIVATE PHONEBOOK }
 
 
-?>
\ No newline at end of file
+?>

Property changes on: opt/gemeinschaft/htdocs/prov/snom/sw
___________________________________________________________________
Name: svn:ignore
   + snom300-3.38-l.bin
snom300-6.5.10-SIP-j.bin
snom300-6.5.15-SIP-j.bin
snom300-7.1.24-SIP-f.bin
snom300-7.1.27-SIP-f.bin
snom300-7.1.28-SIP-f.bin
snom300-7.1.30-SIP-f.bin
snom300-update6to7-7.1.6-bf.bin
snom320-3.25-l.bin
snom320-3.38-l.bin
snom320-5.5a-SIP-j.bin
snom320-6.5.10-SIP-j.bin
snom320-6.5.15-SIP-j.bin
snom320-7.1.24-SIP-f.bin
snom320-7.1.27-SIP-f.bin
snom320-7.1.28-SIP-f.bin
snom320-7.1.30-SIP-f.bin
snom320-7.1.33-SIP-f.bin
snom320-ramdiskToJffs2-3.36-br.bin
snom320-update6to7-7.1.6-bf.bin
snom360-3.25-l.bin
snom360-3.38-l.bin
snom360-5.5a-SIP-j.bin
snom360-6.5.10-SIP-j.bin
snom360-6.5.15-SIP-j.bin
snom360-7.1.24-SIP-f.bin
snom360-7.1.27-SIP-f.bin
snom360-7.1.28-SIP-f.bin
snom360-7.1.30-SIP-f.bin
snom360-7.1.33-SIP-f.bin
snom360-7.3.2-SIP-f.bin
snom360-ramdiskToJffs2-3.36-br.bin
snom360-update6to7-7.1.6-bf.bin
snom370-7.1.24-SIP-f.bin
snom370-7.1.27-SIP-f.bin
snom370-7.1.28-SIP-f.bin
snom370-7.1.30-SIP-f.bin
snom370-7.1.33-SIP-f.bin
lang-7.1.30
lang-7.1.33
lang-7.3.2


Index: opt/gemeinschaft/htdocs/prov/snom/dial-log.php
===================================================================
--- opt/gemeinschaft/htdocs/prov/snom/dial-log.php	(revision 5977)
+++ opt/gemeinschaft/htdocs/prov/snom/dial-log.php	(working copy)
@@ -66,12 +66,11 @@
 {
 	@ob_end_clean();
 	ob_start();
-	echo
-		'<?','xml version="1.0" encoding="utf-8"?','>', "\n",
-		'<SnomIPPhoneText>', "\n",
-			'<Title>', __('Fehler'), '</Title>', "\n",
-			'<Text>', snomXmlEsc( __('Fehler') .': '. $msg ), '</Text>', "\n",
-		'</SnomIPPhoneText>', "\n";
+	echo '<?','xml version="1.0" encoding="utf-8"?','>', "\n",
+	     '<SnomIPPhoneText>', "\n",
+	       '<Title>', 'Error', '</Title>', "\n",
+	       '<Text>', snomXmlEsc( 'Error: '. $msg ), '</Text>', "\n",
+	     '</SnomIPPhoneText>', "\n";
 	_ob_send();
 }
 
@@ -81,15 +80,29 @@
 	_err( 'Not enabled.' );
 }
 
+$longdisplays = array('370');
 
 $user = trim( @ $_REQUEST['user'] );
 if (! preg_match('/^\d+$/', $user))
 	_err( 'Not a valid SIP user.' );
 $type = trim( @ $_REQUEST['type'] );
-if (! in_array( $type, array('in','out','missed'), true ))
+if (! in_array( $type, array('in','out','missed','q_in','q_missed'), true ))
 	$type = false;
+	
+$delete = trim( @$_REQUEST['delete'] );
+$qdelete = trim( @$_REQUEST['qdelete'] );
 
+$model = gs_user_phonemodel_get( $user );
+$longview = false;
 
+foreach($longdisplays as $phone){
+	if(substr_count($model, $phone) > 0){
+		$longview = true;
+		break;
+	}
+}
+
+
 $db = gs_db_slave_connect();
 
 # get user_id
@@ -98,52 +111,72 @@
 if ($user_id < 1)
 	_err( 'Unknown user.' );
 
-
 $typeToTitle = array(
-	'out'    => __("Gew\xC3\xA4hlt"),
-	'missed' => __("Verpasst"),
-	'in'     => __("Angenommen")
+	'out'    => "Gew\xC3\xA4hlt",
+	'missed' => "Verpasst",
+	'in'     => "Angenommen"
 );
 
+$queueTypeToTitle = array(
+	'missed' => "Verpasst (Ws.)",
+	'in'     => "Angenommen (Ws.)"
+);
 
 
 ob_start();
 
 
-$url_snom_dl = GS_PROV_SCHEME .'://'. GS_PROV_HOST . (GS_PROV_PORT ? ':'.GS_PROV_PORT : '') . GS_PROV_PATH .'snom/dial-log.php';
+$url_snom_dl = GS_PROV_SCHEME .'://'. GS_PROV_HOST .(GS_PROV_PORT==80 ? '' : (':'. GS_PROV_PORT)). GS_PROV_PATH .'snom/dial-log.php';
 
 
 #################################### INITIAL SCREEN {
 if (! $type) {
 	
+	$db = gs_db_master_connect();
+	
 	# delete outdated entries
 	#
 	$db->execute( 'DELETE FROM `dial_log` WHERE `user_id`='. $user_id .' AND `timestamp`<'. (time()-(int)GS_PROV_DIAL_LOG_LIFE) );
+	$db->execute( 'DELETE FROM `queue_dial_log` WHERE `user_id`='. $user_id .' AND `timestamp`<'. (time()-(int)GS_PROV_DIAL_LOG_LIFE) );
 	
+	if ( ($delete == 1) && ($user_id > 0) )
+		$db->execute( 'UPDATE `dial_log` SET `read` = 2 WHERE `type` = \'missed\' AND `user_id`='. $user_id );
 	
-	
+	if ( ($qdelete == 1) && ($user_id > 0) )
+		$db->execute( 'UPDATE `queue_dial_log` SET `read` = 2 WHERE `type` = \'missed\' AND `user_id`='. $user_id );
+
 	echo '<?','xml version="1.0" encoding="utf-8"?','>', "\n";
-	echo
-		'<SnomIPPhoneMenu>', "\n",
-			'<Title>', __('Anruflisten') ,'</Title>', "\n";
-	
+	echo '<SnomIPPhoneMenu>', "\n",
+	       '<Title>Anruflisten</Title>', "\n";
+	$db = gs_db_slave_connect();
 	foreach ($typeToTitle as $t => $title) {
 		
-		$num_calls = (int)$db->executeGetOne( 'SELECT COUNT(*) FROM `dial_log` WHERE `user_id`='. $user_id .' AND `type`=\''. $t .'\'' );
+		$num_calls = (int)$db->executeGetOne( 'SELECT COUNT(*) FROM `dial_log` WHERE `user_id`='. $user_id .' AND `type`=\''. $t .'\' AND `read` < 2' );
 		if ($num_calls > 0) {
-			echo
-				"\n",
+			echo "\n",
+			     '<MenuItem>', "\n",
+			       '<Name>', snomXmlEsc( $title ) ,'</Name>', "\n",
+			       '<URL>', $url_snom_dl ,'?user=',$user, '&type=',$t, '</URL>', "\n",
+			     '</MenuItem>', "\n";
+			# Snom does not understand &amp; !
+		}
+	}
+	
+	foreach ($queueTypeToTitle as $t => $title) {
+		
+		$num_calls = (int)$db->executeGetOne( 'SELECT COUNT(*) FROM `queue_dial_log` WHERE `user_id`='. $user_id .' AND `type`=\''. $t .'\' AND `read` < 2' );
+		if ($num_calls > 0) {
+			echo "\n",
 				'<MenuItem>', "\n",
-					'<Name>', snomXmlEsc( $title ) ,'</Name>', "\n",
-					'<URL>', $url_snom_dl ,'?user=',$user, '&type=',$t, '</URL>', "\n",
+				'<Name>', snomXmlEsc( $title ) ,'</Name>', "\n",
+				'<URL>', $url_snom_dl ,'?user=',$user, '&type=q_',$t, '</URL>', "\n",
 				'</MenuItem>', "\n";
 			# Snom does not understand &amp; !
 		}
 	}
 	
-	echo
-		"\n",
-		'</SnomIPPhoneMenu>';
+	echo "\n",
+	'</SnomIPPhoneMenu>';
 	
 }
 #################################### INITIAL SCREEN }
@@ -151,12 +184,107 @@
 
 
 #################################### DIAL LOG {
+
+
+else if($type == "q_in" || $type == "q_missed"){
+	
+	if($type == "q_in")$qtype = "in";
+	if($type == "q_missed")$qtype = "missed";
+	
+	echo '<?','xml version="1.0" encoding="utf-8"?','>', "\n";
+	echo '<SnomIPPhoneDirectory>', "\n",
+	'<Title>', snomXmlEsc( $typeToTitle[$qtype] ) ,'</Title>', "\n";
+	
+	$query =
+'SELECT
+	MAX(`timestamp`) `ts`, `number`, `remote_name`, `remote_user_id`, `queue_number`,
+	COUNT(*) `num_calls`
+FROM `queue_dial_log`
+WHERE
+	`user_id`='. $user_id .' AND
+	`type`=\''. $qtype .'\' AND
+	`read` < 2
+GROUP BY `number`
+ORDER BY `ts` DESC
+LIMIT 20';
+	$rs = $db->execute( $query );
+	while ($r = $rs->fetchRow()) {
+		$pnumber = $r['number'];
+		$entry_name = 'Q' . $r['queue_number']. ' ';
+		$entry_name .= $r['number'];
+		if ($r['remote_name'] != '') {
+			$entry_name .= ' '. $r['remote_name'];
+		}
+		if(!$longview){
+			if (date('dm') == date('dm', (int)$r['ts']))
+				$when = date('H:i', (int)$r['ts']);
+			else
+				$when = date('d.m.', (int)$r['ts']);
+		}
+		else{
+			$when = date('d.m.', (int)$r['ts']) .' ' . date('H:i', (int)$r['ts']);
+		}
+		$entry_name = $when .'  '. $entry_name;
+
+		if ( $r['num_calls'] > 1 ) {
+			$num_calls = $db->executeGetOne(
+'SELECT
+	COUNT(*)
+FROM `queue_dial_log`
+WHERE
+	`user_id`=' . $user_id . ' AND
+	`number`=\'' . $r['number'] . '\' AND
+	`queue_number`=\'' . $r['queue_number'] . '\' AND
+	`type`=\'' . $qtype . '\' AND
+	`read` < 1'
+			);
+			if($r['number'] ==''){
+				if ( ( $num_calls > 0 ) && ( $qtype == 'missed' ) )
+					$entry_name .= 'Unbekannt('. $num_calls .')';
+				else
+					$entry_name .= 'Unbekannt';
+			}
+			else{
+				if ( ( $num_calls > 0 ) && ( $qtype == 'missed' ) )
+					$entry_name .= ' ('. $num_calls .')';
+			}
+		}
+		if( GS_SNOM_USE_AUTOPREFIX > 0 ){
+				if(  substr( $r['number'], 0, 1 ) === "0" ){
+				$pnumber =  substr( $r['number'],1 );
+			}
+		}
+		echo "\n",
+			 '<DirectoryEntry>', "\n",
+			   '<Name>', snomXmlEsc( $entry_name ) ,'</Name>', "\n",
+			   '<Telephone>', snomXmlEsc( $pnumber ) ,'</Telephone>', "\n",
+			 '</DirectoryEntry>', "\n";
+		
+	}
+
+	if ( $qtype == 'missed' )
+		echo '<SoftKeyItem>',
+			'<Name>F2</Name>',
+			'<Label>' ,snomXmlEsc('Löschen'),'</Label>',
+			'<URL>', $url_snom_dl, '?user=', $user, '&qdelete=1</URL>',
+			'</SoftKeyItem>', "\n";
+	
+	echo "\n",
+		'</SnomIPPhoneDirectory>';
+	if ($qtype=='missed') {
+		gs_user_watchedmissed($user_id, 'queue');
+	}
+	if ( GS_BUTTONDAEMON_USE == true ) {
+		gs_buttondeamon_missedqueuecalls( $user);
+	}
+	
+}
+
 else {
 	
 	echo '<?','xml version="1.0" encoding="utf-8"?','>', "\n";
-	echo
-		'<SnomIPPhoneDirectory>', "\n",
-			'<Title>', snomXmlEsc( $typeToTitle[$type] ) ,'</Title>', "\n";
+	echo '<SnomIPPhoneDirectory>', "\n",
+	'<Title>', snomXmlEsc( $typeToTitle[$type] ) ,'</Title>', "\n";
 	
 	$query =
 'SELECT
@@ -165,39 +293,84 @@
 FROM `dial_log`
 WHERE
 	`user_id`='. $user_id .' AND
-	`type`=\''. $type .'\'
+	`type`=\''. $type .'\' AND
+	`read` < 2
 GROUP BY `number`
 ORDER BY `ts` DESC
 LIMIT 20';
 	$rs = $db->execute( $query );
 	while ($r = $rs->fetchRow()) {
 		
+		$pnumber =  $r['number'];
 		$entry_name = $r['number'];
 		if ($r['remote_name'] != '') {
 			$entry_name .= ' '. $r['remote_name'];
 		}
-		if (date('dm') == date('dm', (int)$r['ts']))
-			$when = date('H:i', (int)$r['ts']);
-		else
-			$when = date('d.m.', (int)$r['ts']);
+		if(!$longview){
+			if (date('dm') == date('dm', (int)$r['ts']))
+				$when = date('H:i', (int)$r['ts']);
+			else
+				$when = date('d.m.', (int)$r['ts']);
+		}
+		else{
+			$when = date('d.m.', (int)$r['ts']) .' ' . date('H:i', (int)$r['ts']);
+		}
 		$entry_name = $when .'  '. $entry_name;
-		if ($r['num_calls'] > 1) {
-			$entry_name .= ' ('. $r['num_calls'] .')';
+
+		if ( $r['num_calls'] > 1 ) {
+			$num_calls = $db->executeGetOne(
+'SELECT
+	COUNT(*)
+FROM `dial_log`
+WHERE
+	`user_id`=' . $user_id . ' AND
+	`number`=\'' . $r['number'] . '\' AND
+	`type`=\'' . $type . '\' AND
+	`read` < 1'
+			);
+			if($r['number'] ==''){
+				if ( ( $num_calls > 0 ) && ( $type == 'missed' ) )
+					$entry_name .= 'Unbekannt('. $num_calls .')';
+				else
+					$entry_name .= 'Unbekannt';
+			}
+			else{
+				if ( ( $num_calls > 0 ) && ( $type == 'missed' ) )
+					$entry_name .= ' ('. $num_calls .')';
+			}
+			
 		}
-		echo
-			"\n",
-			'<DirectoryEntry>', "\n",
-				'<Name>', snomXmlEsc( $entry_name ) ,'</Name>', "\n",
-				'<Telephone>', snomXmlEsc( $r['number'] ) ,'</Telephone>', "\n",
-			'</DirectoryEntry>', "\n";
+		if( GS_SNOM_USE_AUTOPREFIX > 0 ){
+				if(  substr( $r['number'], 0, 1 ) === "0" ){
+				$pnumber =  substr( $r['number'],1 );
+			}
+		}
+		echo "\n",
+			 '<DirectoryEntry>', "\n",
+			   '<Name>', snomXmlEsc( $entry_name ) ,'</Name>', "\n",
+			   '<Telephone>', snomXmlEsc( $pnumber ) ,'</Telephone>', "\n",
+			 '</DirectoryEntry>', "\n";
 		
 	}
 	
-	echo
-		"\n",
-		'</SnomIPPhoneDirectory>';
+	if ( $type=='missed' )
+		echo '<SoftKeyItem>',
+			'<Name>F2</Name>',
+			'<Label>' ,snomXmlEsc('Löschen'),'</Label>',
+			'<URL>', $url_snom_dl, '?user=', $user, '&delete=1</URL>',
+			'</SoftKeyItem>', "\n";
+
+	echo "\n",
+	     '</SnomIPPhoneDirectory>';
+	if ($type=='missed')
+		gs_user_watchedmissed($user_id, 'user');
+
+	if ( GS_BUTTONDAEMON_USE == true ) {
+		gs_buttondeamon_missedcalls( $user);
+	}
 	
 }
+
 #################################### DIAL LOG }
 
 
Index: opt/gemeinschaft/dialplan-scripts/in-user-get-ringer.agi
===================================================================
--- opt/gemeinschaft/dialplan-scripts/in-user-get-ringer.agi	(revision 5977)
+++ opt/gemeinschaft/dialplan-scripts/in-user-get-ringer.agi	(working copy)
@@ -99,8 +99,6 @@
 	}
 	//print_r($ringtones);
 		
-	if (@$ringtones['internal']['file'] && @$ringtones['external']['file'])
-		$ringtones['external']['file'] = null;
 	
 	if (@$ringtones[$source]['file']) {
 		echo 'SET VARIABLE ringer '. gs_agi_str_esc( '<'. GS_PROV_SCHEME .'://'. GS_PROV_HOST . (GS_PROV_PORT ? ':'.GS_PROV_PORT : '') . GS_PROV_PATH .'ringtones/'. $ringtones[$source]['file'] .'-snom.wav>' ) ."\n";

Property changes on: opt/gemeinschaft/dialplan-scripts/in-user-get-ringer.agi
___________________________________________________________________
Name: svn:executable
   - 
   + *

Index: opt/gemeinschaft/dialplan-scripts/in-get-where.agi
===================================================================
--- opt/gemeinschaft/dialplan-scripts/in-get-where.agi	(revision 5977)
+++ opt/gemeinschaft/dialplan-scripts/in-get-where.agi	(working copy)
@@ -36,6 +36,7 @@
 
 
 $ext  = trim(@$argv[1]);
+$is_huntgroup  = trim(@$argv[2]);
 
 if (! $ext) {
 	echo 'SET VARIABLE __exttype '. gs_agi_str_esc('') ."\n";
@@ -55,67 +56,81 @@
 include_once( GS_DIR .'inc/get-listen-to-ids.php' );
 
 
+function get_at_dial( $host_id ){
+	global $db;
 
-function get_at_dial( $host_id )
-{
 	$our_ids = @gs_get_listen_to_ids();
-	if (! is_array($our_ids) || ! in_array($host_id, $our_ids))
-		return 'gs-'. str_pad( $host_id, 4, '0', STR_PAD_LEFT );
-	else
-		return '';
+	
+	if (! is_array($our_ids) || ! in_array($host_id, $our_ids) ) {
+		$hostname = $db->executeGetOne( 'SELECT `hostname` FROM `hosts` WHERE `id`='. $db->escape($host_id)  );
+		return $hostname;
+	}
 }
 
 
 
 $db = gs_db_slave_connect();
 
+# is it a hunt group?
+#
+if ($is_huntgroup != 1) {
+  $num = $db->executeGetOne( 'SELECT COUNT(*) FROM `huntgroups` WHERE `number`=\''. $db->escape($ext) .'\'' );
+  if ($num > 0) {
+	  echo 'SET VARIABLE __exttype '. gs_agi_str_esc('huntgroup') ."\n";
+	  die();
+  }
+}
+
 # is it a user?
 #
-//$num = $db->executeGetOne( 'SELECT COUNT(*) FROM `ast_sipfriends` WHERE `name`=\''. $db->escape($ext) .'\'' );
-$rs = $db->execute(
-'SELECT `u`.`host_id`, `h`.`is_foreign`, `h`.`host`
-FROM
-	`ast_sipfriends` `s` JOIN
-	`users` `u` ON (`u`.`id`=`s`.`_user_id`) JOIN
-	`hosts` `h` ON (`h`.`id`=`u`.`host_id`)
-WHERE `s`.`name`=\''. $db->escape($ext) .'\''
-);
-if ($r = $rs->fetchRow()) {
-	if (! $r['is_foreign']) {
+if (GS_MASTER_SLAVE_MODE == true) {
+	$rs = $db->execute(
+	'SELECT `grp_id`, `host_id`
+	FROM `users`
+	WHERE `user`=\''. $db->escape($ext) .'\''
+	);
+	if (! $rs) _err('DB error');
+	$grpid = $rs->fetchRow();
+
+	if ($grpid['grp_id'] > 0) {
 		echo 'SET VARIABLE __exttype '. gs_agi_str_esc('user') ."\n";
-		if ($r['host_id'] < 1) {
-			echo 'SET VARIABLE __dial_to_node '. gs_agi_str_esc('') ."\n";
-		} else {
-			echo 'SET VARIABLE __dial_to_node '. gs_agi_str_esc( get_at_dial( $r['host_id'] ) ) ."\n";
+		echo 'SET VARIABLE __dial_to_node '. gs_agi_str_esc( get_at_dial( $host_id ) ) ."\n";
+		die();
+	} else {
+		$num = $db->executeGetOne( 'SELECT COUNT(*) FROM `ast_sipfriends` WHERE `name`=\''. $db->escape($ext) .'\'' );
+		if ($num > 0) {
+			echo 'SET VARIABLE __exttype '. gs_agi_str_esc('user') ."\n";
+			$host_id = $db->executeGetOne( 'SELECT `u`.`host_id` FROM `ast_sipfriends` `s` JOIN `users` `u` ON (`u`.`id`=`s`.`_user_id`) WHERE `s`.`name`=\''. $db->escape($ext) .'\'' );
+			if ($host_id < 1)
+				echo 'SET VARIABLE __dial_to_node '. gs_agi_str_esc('') ."\n";
+			else
+				echo 'SET VARIABLE __dial_to_node '. gs_agi_str_esc( get_at_dial( $host_id ) ) ."\n";
+			die();
 		}
-	} else {
-		echo 'SET VARIABLE __exttype '. gs_agi_str_esc('foreign') ."\n";
-		echo 'SET VARIABLE __dial_to_node '. gs_agi_str_esc( $r['host'] ) ."\n";
 	}
-	die();
+} else {
+	$num = $db->executeGetOne( 'SELECT COUNT(*) FROM `ast_sipfriends` WHERE `name`=\''. $db->escape($ext) .'\'' );
+	if ($num > 0) {
+		echo 'SET VARIABLE __exttype '. gs_agi_str_esc('user') ."\n";
+		$host_id = $db->executeGetOne( 'SELECT `u`.`host_id` FROM `ast_sipfriends` `s` JOIN `users` `u` ON (`u`.`id`=`s`.`_user_id`) WHERE `s`.`name`=\''. $db->escape($ext) .'\'' );
+		if ($host_id < 1)
+			echo 'SET VARIABLE __dial_to_node '. gs_agi_str_esc('') ."\n";
+		else
+			echo 'SET VARIABLE __dial_to_node '. gs_agi_str_esc( get_at_dial( $host_id ) ) ."\n";
+		die();
+	}
 }
 
 # is it a queue?
 #
-$rs = $db->execute(
-'SELECT `q`.`_host_id` `host_id`, `h`.`is_foreign`, `h`.`host`
-FROM
-	`ast_queues` `q` JOIN
-	`hosts` `h` ON (`h`.`id`=`q`.`_host_id`)
-WHERE `q`.`name`=\''. $db->escape($ext) .'\''
-);
-if ($r = $rs->fetchRow()) {
-	if (! $r['is_foreign']) {
-		echo 'SET VARIABLE __exttype '. gs_agi_str_esc('queue') ."\n";
-		if ($r['host_id'] < 1) {  // should never happen
-			echo 'SET VARIABLE __dial_to_node '. gs_agi_str_esc('') ."\n";
-		} else {
-			echo 'SET VARIABLE __dial_to_node '. gs_agi_str_esc( get_at_dial( $r['host_id'] ) ) ."\n";
-		}
-	} else {
-		echo 'SET VARIABLE __exttype '. gs_agi_str_esc('foreign') ."\n";
-		echo 'SET VARIABLE __dial_to_node '. gs_agi_str_esc( $r['host'] ) ."\n";
-	}
+$num = $db->executeGetOne( 'SELECT COUNT(*) FROM `ast_queues` WHERE `name`=\''. $db->escape($ext) .'\'' );
+if ($num > 0) {
+	echo 'SET VARIABLE __exttype '. gs_agi_str_esc('queue') ."\n";
+	$host_id = $db->executeGetOne( 'SELECT `_host_id` FROM `ast_queues` WHERE `name`=\''. $db->escape($ext) .'\'' );
+	if ($host_id < 1)  // should never happen
+		echo 'SET VARIABLE __dial_to_node '. gs_agi_str_esc('') ."\n";
+	else
+		echo 'SET VARIABLE __dial_to_node '. gs_agi_str_esc( get_at_dial( $host_id ) ) ."\n";
 	die();
 }
 
Index: opt/gemeinschaft/dialplan-scripts/in-get-type.agi
===================================================================
--- opt/gemeinschaft/dialplan-scripts/in-get-type.agi	(revision 5977)
+++ opt/gemeinschaft/dialplan-scripts/in-get-type.agi	(working copy)
@@ -36,6 +36,7 @@
 
 
 $ext  = trim(@$argv[1]);
+$is_huntgroup = trim(@$argv[2]);
 
 if (! $ext) {
 	echo 'SET VARIABLE __exttype '. gs_agi_str_esc('') ."\n";
@@ -54,9 +55,24 @@
 
 $db = gs_db_slave_connect();
 
+# is it a hunt group?
+#
+if ($is_huntgroup != 1) {
+  $num = $db->executeGetOne( 'SELECT COUNT(*) FROM `huntgroups` WHERE `number`=\''. $db->escape($ext) .'\'' );
+  if ($num > 0) {
+	  echo 'SET VARIABLE __exttype '. gs_agi_str_esc('huntgroup') ."\n";
+	  //fFlush(STDOUT); // <- do not use. not defined in php-cgi!
+	  die();
+  }
+}
+
 # is it a user?
 #
-$num = $db->executeGetOne( 'SELECT COUNT(*) FROM `ast_sipfriends` WHERE `name`=\''. $db->escape($ext) .'\'' );
+if (GS_MASTER_SLAVE_MODE == true) {
+	$num = $db->executeGetOne( 'SELECT COUNT(*) FROM `users` WHERE `user`=\''. $db->escape($ext) .'\'' );
+} else {
+	$num = $db->executeGetOne( 'SELECT COUNT(*) FROM `ast_sipfriends` WHERE `name`=\''. $db->escape($ext) .'\'' );
+}
 if ($num > 0) {
 	echo 'SET VARIABLE __exttype '. gs_agi_str_esc('user') ."\n";
 	//fFlush(STDOUT); // <- do not use. not defined in php-cgi!
@@ -72,12 +88,6 @@
 	die();
 }
 
-
-//...
-
-
-
-
 echo 'SET VARIABLE __exttype '. gs_agi_str_esc('unknown') ."\n";
 //fFlush(STDOUT); // <- do not use. not defined in php-cgi!
 
Index: opt/gemeinschaft/dialplan-scripts/in-queue-get-fw.agi
===================================================================
--- opt/gemeinschaft/dialplan-scripts/in-queue-get-fw.agi	(revision 5977)
+++ opt/gemeinschaft/dialplan-scripts/in-queue-get-fw.agi	(working copy)
@@ -35,9 +35,9 @@
 ob_implicit_flush(1);
 
 
-$queue_ext  = trim(@$argv[1]);
+$queue  = trim(@$argv[1]);
 
-if (! preg_match('/^\d+$/', $queue_ext)) {  // is not just digits
+if (! preg_match('/^\d+$/', $queue)) {  // is not just digits
 	die();
 }
 
@@ -47,24 +47,22 @@
 
 $db = gs_db_slave_connect();
 
-# get queue info:
-$rs = $db->execute( 'SELECT `_id`, `musicclass`, `_title` FROM `ast_queues` WHERE `name`=\''. $db->escape($queue_ext) .'\'' );
-$queue = $rs->getRow();
-if (! $queue) die();
-if ((int)$queue['_id'] < 1) die();
+# get queue_id:
+$queue_id = (int)$db->executeGetOne( 'SELECT `_id` FROM `ast_queues` WHERE `name`=\''. $db->escape($queue) .'\'' );
+if ($queue_id < 1) die();
 
 
 # get call forwards
 #
 
 $forwards = array(
-	'internal'=> array(
+		'internal'=> array(
 		'always'  => array( 'number'=>'' ),
 		'full'    => array( 'number'=>'' ),
 		'empty'   => array( 'number'=>'' ),
 		'timeout' => array( 'number'=>'', 'timeout'=>15 )
 	),
-	'external'=> array(
+		'external'=> array(
 		'always'  => array( 'number'=>'' ),
 		'full'    => array( 'number'=>'' ),
 		'empty'   => array( 'number'=>'' ),
@@ -72,17 +70,17 @@
 	)
 );
 
-$rs = $db->execute( 'SELECT `source`, `case`, `timeout`, `number_std`, `number_var`, `active` FROM `queue_callforwards` WHERE `queue_id`='. (int)$queue['_id'] );
+$rs = $db->execute( 'SELECT `source`, `case`, `timeout`, `number_std`, `number_var`, `active` FROM `queue_callforwards` WHERE `queue_id`='. $queue_id );
 while ($r = $rs->fetchRow()) {
 	$number_std = trim( $r['number_std'] );
 	$number_var = trim( $r['number_var'] );
 	$number = '';
-	if     ($r['active']==='std' && $number_std != '')
+	if     ($r['active']=='std' && $number_std != '')
 		$number = $number_std;
-	elseif ($r['active']==='var' && $number_var != '')
+	elseif ($r['active']=='var' && $number_var != '')
 		$number = $number_var;
 	$forwards[$r['source']][$r['case']]['number'] = $number;
-	if ($r['case']==='timeout' && $number != '')
+	if ($r['case']=='timeout' && $number != '')
 		$forwards[$r['source']][$r['case']]['timeout'] = $r['timeout'];
 }
 
@@ -105,19 +103,30 @@
 }
 
 
-# ring instead of MOH?
+# get settings
 #
-$ring_instead_of_moh = (trim($queue['musicclass']) == '');
+
+$ring_instead_of_moh = false;
+$rs = $db->execute( 'SELECT `musicclass` FROM `ast_queues` WHERE `_id`='. $queue_id );
+if ($r = $rs->fetchRow()) {
+	if (trim($r['musicclass']) == '') {
+		$ring_instead_of_moh = true;
+	}
+}
 echo 'SET VARIABLE ring_instead_of_moh '. gs_agi_str_esc( $ring_instead_of_moh ? 'r':'' ) ."\n";
 //fFlush(STDOUT); // <- do not use. not defined in php-cgi!
 
-# queue title (for caller ID display)
+# Get the Name of the queue
 #
-$displayname = rTrim(subStr( preg_replace('/  +/', ' ',
-	preg_replace('/[^a-zA-Z0-9\\-_.,+\\(\\) ]/', '', trim($queue['_title']))),
-	0, 15));
-echo 'SET VARIABLE queue_displayname '. gs_agi_str_esc( $displayname != '' ? $displayname : 'Q'.$queue_ext ) ."\n";
-//fFlush(STDOUT); // <- do not use. not defined in php-cgi!
+if(gs_get_conf('GS_QUEUE_SHOW_QUEUENAME')){
 
+$queuename = $db->executeGetOne( 'SELECT `_title` FROM `ast_queues` WHERE `_id`=' . $queue_id );
+	echo 'SET VARIABLE queuename '. gs_agi_str_esc($queuename) ."\n";
+	echo 'SET VARIABLE showname '. gs_agi_str_esc('true') ."\n";
+}
+else{
+	echo 'SET VARIABLE showname '. gs_agi_str_esc('false') ."\n";
+}
 
+
 ?>
\ No newline at end of file

Property changes on: opt/gemeinschaft/dialplan-scripts/in-queue-get-fw.agi
___________________________________________________________________
Name: svn:executable
   - 
   + *

Index: opt/gemeinschaft/dialplan-scripts/usercode-by-ext.agi
===================================================================
--- opt/gemeinschaft/dialplan-scripts/usercode-by-ext.agi	(revision 5977)
+++ opt/gemeinschaft/dialplan-scripts/usercode-by-ext.agi	(working copy)
@@ -49,7 +49,13 @@
 
 $db = gs_db_slave_connect();
 
+if (GS_MASTER_SLAVE_MODE == true) {
 
+$usercode = $ext; 
+
+}
+else {
+
 $usercode = $db->executeGetOne(
 'SELECT `u`.`user`
 FROM
@@ -57,6 +63,8 @@
 	`ast_sipfriends` `s` ON (`s`.`_user_id`=`u`.`id`)
 WHERE `s`.`name`=\''. $ext .'\''
 );
+
+}
 if (! $usercode) {
 	echo 'SET VARIABLE user_code '. gs_agi_str_esc('') ."\n";
 	//fFlush(STDOUT); // <- do not use. not defined in php-cgi!

Property changes on: opt/gemeinschaft/dialplan-scripts/usercode-by-ext.agi
___________________________________________________________________
Name: svn:executable
   - 
   + *

Index: opt/gemeinschaft/dialplan-scripts/dial-log-store
===================================================================
--- opt/gemeinschaft/dialplan-scripts/dial-log-store	(revision 5977)
+++ opt/gemeinschaft/dialplan-scripts/dial-log-store	(working copy)
@@ -48,13 +48,16 @@
 
 require_once( dirName(__FILE__) .'/../inc/conf.php' );
 include_once( GS_DIR .'inc/db_connect.php' );
+include_once( GS_DIR .'inc/gs-lib.php' );
 
-
 $db = gs_db_master_connect();
 
 # get user id:
 #
-$uid = (int)$db->executeGetOne( 'SELECT `_user_id` FROM `ast_sipfriends` WHERE `name`=\''. $db->escape($user_ext) .'\'' );
+if (GS_MASTER_SLAVE_MODE == true)
+	$uid = (int)$db->executeGetOne( 'SELECT `id` FROM `users` WHERE `user`=\''. $db->escape($user_ext) .'\'' );
+else
+	$uid = (int)$db->executeGetOne( 'SELECT `_user_id` FROM `ast_sipfriends` WHERE `name`=\''. $db->escape($user_ext) .'\'' );
 if ($uid < 1) die();
 
 # get remote user
@@ -84,7 +87,9 @@
 # log
 #
 $db->execute( 'INSERT INTO `dial_log` (`user_id`, `type`, `timestamp`, `number`, `remote_name`, `remote_user_id`) VALUES ('. $uid .', \''. $type .'\', '. time() .', \''. $db->escape($number) .'\', \''. $db->escape($remote_name) .'\', '. $db_remote_user_id .')' );
+if($type =='missed' && gs_get_conf('GS_BUTTONDAEMON_USE')){
+        gs_buttondeamon_missedcalls( $user_ext);
+}
 
 
-
 ?>
\ No newline at end of file
Index: opt/gemeinschaft/dialplan-scripts/queue-login-logout.agi
===================================================================
--- opt/gemeinschaft/dialplan-scripts/queue-login-logout.agi	(revision 5977)
+++ opt/gemeinschaft/dialplan-scripts/queue-login-logout.agi	(working copy)
@@ -30,7 +30,10 @@
 define( 'GS_VALID', true );  /// this is a parent file
 require_once( dirName(__FILE__) .'/../inc/conf.php' );
 require_once( GS_DIR .'inc/agi-fns.php' );
+include_once( GS_DIR .'inc/gs-fns/gs_astphonebuttons.php' );
+include_once( GS_DIR .'inc/gs-fns/gs_callforward_activate.php' );
 
+
 ini_set('implicit_flush', 1);
 ob_implicit_flush(1);
 
@@ -41,11 +44,9 @@
 $out = ob_get_clean();
 fWrite(STDERR,$out);
 */
-
 $user       = trim(@$argv[1]);
 $queue_name = trim(@$argv[2]);
 $action     = trim(@$argv[3]);
-
 if (! preg_match('/^\d+$/', $user))  // is not just digits
 	die();
 if (! preg_match('/^\d+$/', $queue_name))  // is not just digits
@@ -53,24 +54,46 @@
 if (! in_array( $action, array('login','logout','logoutall'), true ))
 	die();
 
-
-
 include_once( GS_DIR .'inc/db_connect.php' );
 
 $db = gs_db_master_connect();
 
-
 # get user id
 #
-$user_id = (int)$db->executeGetOne( 'SELECT `_user_id` FROM `ast_sipfriends` WHERE `name`=\''. $db->escape($user) .'\'' );
-if ($user_id < 1) die();
+if (GS_MASTER_SLAVE_MODE == true) {
+	$user_id = (int)$db->executeGetOne( 'SELECT `id` FROM `users` WHERE `user`=\''. $db->escape($user) .'\'' );	
+}
+else{
+	$user_id = (int)$db->executeGetOne( 'SELECT `_user_id` FROM `ast_sipfriends` WHERE `name`=\''. $db->escape($user) .'\'' );
+}
 
+if ($user_id < 1){
+	echo 'SET VARIABLE user_id_error '. gs_agi_str_esc($user_id) ."\n";
+	die();
+}
+
+# test whether there is a agent logged in on this phone
+#
+$agent = (int)$db->executeGetOne( 'SELECT COUNT(*) FROM `agents` WHERE `user_id`='. $db->escape($user_id) );
+if ($agent > 0){
+	echo 'SET VARIABLE agent_login_status '. gs_agi_str_esc('agent-exists') ."\n";
+	die();
+}
+
 # get user's host id
 #
 $user_host_id = (int)$db->executeGetOne( 'SELECT `host_id` FROM `users` WHERE `id`='. $user_id );
-if ($user_host_id < 1) die();
+if ($user_host_id < 1){
+	echo 'SET VARIABLE host_id_error '. gs_agi_str_esc($host_id) ."\n";
+	die();
+}
 
+# get user name
+#
+$user_name = $db->executeGetOne( 'SELECT `user` FROM `users` WHERE `id`='. $user_id );
+if (strlen($user_name) < 1) die();
 
+
 if ($action != 'logoutall') {
 	
 	# get queue
@@ -85,22 +108,35 @@
 
 
 if ($action === 'login') {
-	
+	gs_callforward_activate($user_name,'internal','always','no');
+	gs_callforward_activate($user_name,'external','always','no');
 	if ($queue['host_id'] != $user_host_id) {
 		echo 'SET VARIABLE agent_login_status '. gs_agi_str_esc('failhost') ."\n";
 		die();
 	}
 	
+	$gwuser = (int)$db->executeGetOne( 'SELECT `grp_id` FROM `users` WHERE `id`=' . $user_id);
+	echo 'SET VARIABLE gw_group ' . $gwuser . "\n";
 	$num = (int)$db->executeGetOne( 'SELECT COUNT(*) FROM `ast_queue_members` WHERE `_queue_id`='. $queue_id .' AND `_user_id`='. $user_id );
 	if ($num > 0) {  // user is already logged in on that queue
 		echo 'SET VARIABLE agent_login_status '. gs_agi_str_esc('alreadyon') ."\n";
 		//fFlush(STDOUT); // <- do not use. not defined in php-cgi!
 		die();
 	}
-	
-	$db->execute( 'INSERT INTO `ast_queue_members` (`queue_name`, `_queue_id`, `interface`, `_user_id`) VALUES (\''. $db->escape($queue_name) .'\', '. $queue_id .', \''. $db->escape( 'SIP/'. $user ) .'\', '. $user_id .')' );
+	if($gwuser <= 0)
+		$db->execute( 'INSERT INTO `ast_queue_members` (`queue_name`, `_queue_id`, `interface`, `_user_id`) VALUES (\''. $db->escape($queue_name) .'\', '. $queue_id .', \''. $db->escape( 'SIP/'. $user ) .'\', '. $user_id .')' );
+	else{
+		$db->execute( 'INSERT INTO `ast_queue_members` (`queue_name`, `_queue_id`, `interface`, `_user_id`) VALUES (\''. $db->escape($queue_name) .'\', '. $queue_id .', \''. $db->escape( 'Local/'. $user .'@to-gguser' ) .'\', '. $user_id .')' );
+	}
 	echo 'SET VARIABLE agent_login_status '. gs_agi_str_esc('loggedin') ."\n";
 	//fFlush(STDOUT); // <- do not use. not defined in php-cgi!
+
+
+
+	if(gs_get_conf('GS_BUTTONDAEMON_USE')){
+		gs_buttondeamon_diversion_update($user);
+		gs_buttondeamon_queue_update( $user, $queue_name, "on");
+	}
 	
 }
 elseif ($action === 'logout') {
@@ -108,13 +144,18 @@
 	$db->execute( 'DELETE FROM `ast_queue_members` WHERE `_queue_id`='. $queue_id .' AND `_user_id`='. $user_id );
 	echo 'SET VARIABLE agent_login_status '. gs_agi_str_esc('loggedout') ."\n";
 	//fFlush(STDOUT); // <- do not use. not defined in php-cgi!
-	
+	if(gs_get_conf('GS_BUTTONDAEMON_USE')){
+		gs_buttondeamon_queue_update( $user, $queue_name, "off");
+	}
 }
 elseif ($action === 'logoutall') {
 	
 	$db->execute( 'DELETE FROM `ast_queue_members` WHERE `_user_id`='. $user_id );
 	echo 'SET VARIABLE agent_login_status '. gs_agi_str_esc('loggedout') ."\n";
 	//fFlush(STDOUT); // <- do not use. not defined in php-cgi!
+	if(gs_get_conf('GS_BUTTONDAEMON_USE')){
+		gs_buttondeamon_queue_update( $user, "*" , "off");
+	}
 	
 }
 

Property changes on: opt/gemeinschaft/dialplan-scripts/queue-login-logout.agi
___________________________________________________________________
Name: svn:executable
   - 
   + *

Index: opt/gemeinschaft/dialplan-scripts/in-user-get-fw.agi
===================================================================
--- opt/gemeinschaft/dialplan-scripts/in-user-get-fw.agi	(revision 5977)
+++ opt/gemeinschaft/dialplan-scripts/in-user-get-fw.agi	(working copy)
@@ -49,7 +49,10 @@
 $db = gs_db_slave_connect();
 
 # get user id:
-$uid = (int)$db->executeGetOne( 'SELECT `_user_id` FROM `ast_sipfriends` WHERE `name`=\''. $db->escape($uname) .'\'' );
+if (GS_MASTER_SLAVE_MODE == true)
+	$uid = (int)$db->executeGetOne( 'SELECT `id` FROM `users` WHERE `user`=\''. $db->escape($uname) .'\'' );
+else
+	$uid = (int)$db->executeGetOne( 'SELECT `_user_id` FROM `ast_sipfriends` WHERE `name`=\''. $db->escape($uname) .'\'' );
 if ($uid < 1) die();
 
 
Index: opt/gemeinschaft/dialplan-scripts/vm-postexec
===================================================================
--- opt/gemeinschaft/dialplan-scripts/vm-postexec	(revision 5977)
+++ opt/gemeinschaft/dialplan-scripts/vm-postexec	(working copy)
@@ -1,7 +1,7 @@
 #!/usr/bin/php -q
 <?php
 /*******************************************************************\
-*            Gemeinschaft - asterisk cluster gemeinschaft
+*			Gemeinschaft - asterisk cluster gemeinschaft
 * 
 * $Revision$
 * 
@@ -37,10 +37,11 @@
 include_once( GS_DIR .'inc/db_connect.php' );
 include_once( GS_DIR .'inc/log.php' );
 include_once( GS_DIR .'inc/get-listen-to-ids.php' );
+include_once( GS_DIR .'lib/utf8-normalize/gs_utf_normal.php' );
 
 $context = preg_replace('/[^a-z0-9\-_]/i', '', @$argv[1]);
-$mailbox = preg_replace('/[^0-9]/', '',        @$argv[2]);
-$num_vms =                           (int)trim(@$argv[3]);
+$mailbox = preg_replace('/[^0-9]/', '',		   @$argv[2]);
+$num_vms = (int)trim(@$argv[3]);
 # only messages in INBOX are counted
 
 if ($context === '') {
@@ -72,11 +73,17 @@
 	exit(1);
 }
 
+$use_trans = gs_get_conf('GS_DB_MASTER_TRANSACTIONS');
 
 function _mbox_to_userid( $mailbox )
 {
 	global $db;
-	$uid = (int)$db->executeGetOne( 'SELECT `_user_id` FROM `ast_sipfriends` WHERE `name`=\''. $db->escape($mailbox) .'\'' );
+	if (GS_MASTER_SLAVE_MODE == true) {
+		$uid = (int)$db->executeGetOne( 'SELECT `id` FROM `users` WHERE `user`=\''. $db->escape($mailbox) .'\'' );
+	} else {
+		$uid = (int)$db->executeGetOne( 'SELECT `_user_id` FROM `ast_sipfriends` WHERE `name`=\''. $db->escape($mailbox) .'\'' );
+	}
+
 	return ($uid > 0) ? $uid : null;
 }
 
@@ -89,188 +96,6 @@
 }
 */
 
-if (! function_exists('__')) {
-function __($str)
-{
-	return $str;
-}
-}
-
-function email_notify( $mailbox, $uid, $info, $about, $email )
-{
-	global $db;
-	
-	$rs = $db->executeGetOne( 'SELECT `firstname`, `lastname` FROM `users` WHERE `id`='. $uid );
-	if (!($user = $rs->getRow())) return false;
-	$new_msgs = (int)$db->executeGetOne( 'SELECT COUNT(*) FROM `vm_msgs` WHERE `mbox`=\''. $db->escape($mailbox) .'\' AND `folder`=\'INBOX\' AND `listened_to`=0' );
-	
-	$vm_dir = '/var/spool/asterisk/voicemail/';
-	$origfile = $vm_dir .'default/'. $mailbox .'/'. $info['fld'] .'/'. $info['file'] .'.alaw';
-	$tmpfile_base = '/tmp/gs-vm-'. preg_replace('/[^0-9]/', '', $mailbox) .'-'. $info['fld'] .'-'. $info['file'];
-	
-	if (! file_exists($origfile)) {
-		gs_log( GS_LOG_WARNING, "Voicemail \"$origfile\" not found on this node" );
-		return false;
-	}
-	
-	# delete files like /tmp/gs-vm-* with mtime < time()-5 minutes
-	#
-	@exec( 'find \'/tmp/\' -maxdepth 1 -name \'gs-vm-*\' -type f -mmin +5 | xargs rm -f 1>>/dev/null 2>>/dev/null' );
-	
-	# convert file from original format (aLaw) to WAV (signed linear PCM,
-	# 8000 Hz sampling rate, 16 bits/sample)
-	#
-	
-	$err=0; $out=array();
-	@exec( 'sudo chmod a+r '. qsa($origfile) .' 1>>/dev/null 2>>/dev/null', $out, $err );
-	if ($err != 0) {
-		gs_log( GS_LOG_WARNING, 'Can\'t read \"$origfile\"' );
-		return false;
-	}
-	
-	$outfile = $tmpfile_base.'.wav';
-	$cmd = 'sox -q -t al '. qsa($origfile) .' -r 8000 -c 1 -s -w -t wav '. qsa($outfile) .' 2>>/dev/null';
-	$err=0; $out=array();
-	@exec( $cmd, $out, $err );
-	if ($err != 0) {
-		gs_log( GS_LOG_WARNING, 'Failed to convert voicemail file' );
-		return false;
-	}
-	if (! file_exists($outfile)) {
-		gs_log( GS_LOG_WARNING, 'Failed to convert voicemail file' );
-		return false;
-	}
-	
-	@exec('hostname 2>>/dev/null', $out, $err);
-	if ($err == 0) {
-		$hostname = trim(implode(' ', $out));
-		if (! $hostname) $hostname = 'localhost';
-	} else {
-		$hostname = 'localhost';
-	}
-	
-	$subject = sPrintF(__('Neue Voicemail von %s'),
-		($info['cidnum'] .($info['cidname'] != '' ? ' ('.$info['cidname'].')' : '')) );
-	
-	$body = sPrintF(__('Hallo %s!'), trim($user['firstname'] .' '. $user['lastname'])) ."\n\n";
-	
-	$body.= str_replace(array('\\\\n','\\n'), array("\n","\n"),
-		sPrintF(__('Eine neue Voicemail von %s\\nist für Sie eingegangen.'),
-		($info['cidnum'] .($info['cidname'] != '' ? ' ('.$info['cidname'].')' : '')) )) ."\n\n";
-	
-	$body.= str_replace(array('\\\\n','\\n'), array("\n","\n"),
-		sPrintF(__('Die Voicemail erreichte Sie auf Durchwahl %s.'), @$about['exten'])) ."\n";
-	
-	$body.= __('Datum') .': '. @$about['origdate'] ."\n";
-	$body.= __('Dauer') .': '. @$about['duration'] .' '. __('Sekunden') ."\n";
-	$body.= "\n";
-	$body.= str_replace(array('\\\\n','\\n'), array("\n","\n"),
-		__('Sie finden die Voicemail im Anhang dieser Email.')) ."\n\n";
-	
-	if ($new_msgs == 1) {
-		$body.= str_replace(array('\\\\n','\\n'), array("\n","\n"),
-			__('Es befindet sich jetzt 1 neue Voicemail in Ihrer Mailbox.')) ."\n";
-	} else {
-		$body.= str_replace(array('\\\\n','\\n'), array("\n","\n"),
-			__('Es befinden sich jetzt %d neue Voicemails in Ihrer Mailbox.', $new_msgs)) ."\n";
-	}
-	
-	$body.= "\n";
-	$body.= '-- ' ."\n";
-	$body.= str_replace(array('\\\\n','\\n'), array("\n","\n"),
-		__('Dies ist eine automatisierte Nachricht. Bitte antworten Sie nicht.')) ."\n";
-	$body.= sPrintF(__('%s auf "%s"'), 'Gemeinschaft', $hostname) ."\n";
-	
-	$file_name = baseName($outfile);
-	$GS_EMAIL_DELIVERY = gs_get_conf('GS_EMAIL_DELIVERY');
-	
-	if (! file_exists($outfile) || ! is_readable($outfile)) {
-		gs_log( GS_LOG_WARNING, 'Can\'t read \"$outfile\"' );
-		return false;
-	}
-	$fh = @fOpen($outfile, 'rb');
-	if (! $fh) {
-		gs_log( GS_LOG_WARNING, 'Can\'t read \"$outfile\"' );
-		return false;
-	}
-	
-	if ($GS_EMAIL_DELIVERY === 'sendmail') {
-		
-		$boundary = strToUpper(md5(uniqid(time())));
-		$mail_header  = "From: \"Gemeinschaft\" <root>";
-		$mail_header .= "\r\nReply-To: \"". 'Nicht antworten' ."\" <noreply@noreply.local>";
-		$mail_header .= "\r\nMIME-Version: 1.0";
-		$mail_header .= "\r\nContent-Type: multipart/mixed; boundary=$boundary";
-		
-		$mime_body  = "This is a multi-part message in MIME format";
-		$mime_body .= "\r\n--$boundary"; 
-		$mime_body .= "\r\nContent-Type: text/plain; charset=\"utf-8\"";
-		$mime_body .= "\r\nContent-Transfer-Encoding: 8bit";
-		$mime_body .= "\r\n\r\n$body";
-		unset($body);
-		$mime_body .= "\r\n--$boundary";
-		$mime_body .= "\r\nContent-Type: audio/x-wav; name=\"$file_name\"";
-		$mime_body .= "\r\nContent-Transfer-Encoding: base64";
-		$mime_body .= "\r\nContent-Disposition: attachment; filename=\"$file_name\"";
-		$mime_body .= "\r\n\r\n". @chunk_split(@base64_encode(@fRead($fh, @fileSize($outfile))));
-		@fClose($fh);
-		$mail_header .= "\r\n--$boundary--";
-		$ok = mail( $email, $subject, $mime_body, $mail_header );
-		unset($mime_body);
-		return $ok;
-		
-	}
-	elseif ($GS_EMAIL_DELIVERY === 'direct-smtp') {
-		
-		require_once( GS_DIR .'lib/phpmailer/class.phpmailer.php' );
-		$mail = new PHPMailer();
-		$mail->CharSet = 'utf-8';
-		$mail->SetLanguage(
-			strToLower(subStr( gs_get_conf('GS_INTL_LANG'),0,2)),
-			GS_DIR .'lib/phpmailer/language/' );
-		$mail->Hostname = $hostname;
-		$mail->From = 'root@'.$hostname;
-		$mail->FromName = 'Gemeinschaft';
-		$mail->AddReplyTo( '', 'Nicht antworten' ); 
-		$mail->AddAddress($email,'','');
-		$mail->Subject = $subject;
-		$mail->Body = $body;
-		unset($body);
-		$mail->AddStringAttachment( @fRead($fh, @fileSize($outfile)), $file_name, 'base64', 'audio/x-wav' );
-		@fClose($fh);
-		$mail->IsSMTP();
-		//$mail->SMTPDebug = true;
-		$mail->Timeout = 10;
-		if (! preg_match('/@([^@]+)/', $email, $m)) {
-			$ok = false;
-		} else {
-			$host = $m[1];
-			$mx_hosts   = array();
-			$mx_weights = array();
-			getMXRR($host, $mx_hosts, $mx_weights);
-			$mxs = array();
-			if (@count($mx_hosts) > 0) {
-				for($i=0; $i<count($mx_hosts); ++$i) {
-					$mxs[$mx_hosts[$i]] = @$mx_weights[$i];
-				}
-				aSort($mxs, SORT_NUMERIC);
-			} else {
-				$mxs[$host] = 0;  # RFC 2821
-			}
-			while (list($mx_host, $mx_weight) = each($mxs)) {
-				@set_time_limit(30);
-				$mail->Host = $mx_host;
-				$ok = @$mail->Send();
-				if ($ok) break;
-			}
-		}
-		unset($mail);
-		return $ok;
-		
-	}
-}
-
-
 $our_host_id = (int)gs_get_listen_to_primary_id();
 if (! $our_host_id) {
 	gs_log(GS_LOG_WARNING, "Could not get our primary host ID!");
@@ -284,6 +109,7 @@
 foreach ($files as $filename) {
 	$tmp = explode('/', $filename, 3);
 	
+	$info = array();
 	$info['fld' ] =          @$tmp[0];
 	$info['file'] = baseName(@$tmp[1],'.txt');
 	
@@ -310,15 +136,19 @@
 	)
 	*/
 	
-	if (preg_match('/<([^>]+)/S', @$about['callerid'], $m))
-		$info['cidnum' ] = $m[1];
-	else
-		$info['cidnum' ] = '';
+	if (strpos(@$about['callerid'], '<')) {
+		if (preg_match('/<([^>]+)/S', @$about['callerid'], $m))
+			$info['cidnum' ] = $m[1];
+		else
+			$info['cidnum' ] = '';
 	
-	if (preg_match('/^([^<]*)/S', @$about['callerid'], $m))
-		$info['cidname'] = trim($m[1], ' "');
-	else
-		$info['cidname'] = '';
+		if (preg_match('/^([^<]*)/S', @$about['callerid'], $m))
+			$info['cidname'] = trim($m[1], ' "');
+		else
+			$info['cidname'] = '';
+	} else {
+		$info['cidnum'] = @$about['callerid'];
+	}
 	
 	$uniqueid = array(
 		'mailbox'    =>              $mailbox     ,
@@ -327,12 +157,10 @@
 	);
 	$uniqueids[] = $uniqueid;
 	
-	$send_notification = false;
-	
 	# check if we already know this message by unique signature
 	# (mbox, origtime, callerchan)
 	#
-	gs_db_start_trans($db);
+	if ($use_trans) $db->startTrans();
 	$rs = $db->execute(
 'SELECT
 	`id`, `folder`, `file`
@@ -406,7 +234,7 @@
 		
 		gs_log(GS_LOG_DEBUG, "Mailbox $mailbox: New message ". $info['fld'].'/'.$info['file'] );
 		
-		$uid_curr = (int)_mbox_to_userid( $mailbox );
+		$uid_curr = _mbox_to_userid( $mailbox );
 		/*
 		$uid_orig = (@$about['origmailbox'] == $mailbox)
 			? $uid_curr
@@ -446,25 +274,22 @@
 		);
 		if (! $ok)
 			gs_log(GS_LOG_WARNING, "Mailbox $mailbox: Could not insert new message");
-		$send_notification = $ok;
+		else{
+			$vm2mail = (int)$db->executeGetOne( 'SELECT `email_notify` FROM `vm` WHERE `user_id`=' . _mbox_to_userid( $mailbox )  );
+			gs_log(GS_LOG_DEBUG, "Mail-Status for user_id " . _mbox_to_userid( $mailbox ) ." is :" . $vm2mail);
+			if($vm2mail == 1){
+				gs_log(GS_LOG_DEBUG, "The User wants to get a mail");
+				$email = $db->executeGetOne( 'SELECT `email` FROM `users` WHERE `id`='. _mbox_to_userid( $mailbox )  );
+				gs_log(GS_LOG_DEBUG, "Mail-Address for user_id " . _mbox_to_userid( $mailbox ) ." is :" . $email);
+				if($email != '')email_notify( $info, $about, $email);
+			}
+		}
 	}
 	
-	if (! gs_db_commit_trans($db)) {
-		gs_log(GS_LOG_WARNING, "Mailbox $mailbox: Could not commit voicemail info to database!");
-	}
-	
-	if (@$send_notification) {
-		if ($uid_curr > 0) {
-			$email_notify = (int)$db->executeGetOne( 'SELECT `email_notify` FROM `vm` WHERE `user_id`='. $uid_curr  );
-			if ($email_notify == 1) {
-				$email = $db->executeGetOne( 'SELECT `email` FROM `users` WHERE `id`='. $uid_curr );
-				if ($email != '') {
-					gs_log(GS_LOG_DEBUG, "Notify user_id $uid_curr, email \"$email\"" );
-					$ok = email_notify( $mailbox, $uid_curr, $info, $about, $email );
-					if (! $ok)
-						gs_log(GS_LOG_WARNING, "Failed to send notification to \"$email\"" );
-				}
-			}
+	if ($use_trans) {
+		$ok = $db->completeTrans();
+		if (! $ok) {
+			gs_log(GS_LOG_WARNING, "Mailbox $mailbox: Could not commit voicemail info to database!");
 		}
 	}
 }
@@ -473,9 +298,12 @@
 # meaning they have been deleted:
 #
 $rs = $db->execute(
-'SELECT `id`, `orig_time`, `callerchan`
-FROM `vm_msgs`
-WHERE `mbox`=\''. $db->escape($mailbox) .'\''
+'SELECT 
+	`id`, `orig_time`, `callerchan`
+FROM 
+	`vm_msgs`
+WHERE 
+	`mbox`=\''. $db->escape($mailbox) .'\''
 );
 while ($r = $rs->fetchRow()) {
 	$file_exists = false;
@@ -496,5 +324,215 @@
 	}
 }
 
+function email_notify($info, $about, $email){
+	
+	global $mailbox, $db;
+	
+		$id = (int)$db->executeGetOne( 'SELECT distinct(_user_id) from `ast_sipfriends` where `mailbox`=\''.$about['exten']. '\'' );
+		$fn = $db->executeGetOne( 'SELECT distinct(firstname) from `users` where `id`='. $id );
+		$ln = $db->executeGetOne( 'SELECT distinct(lastname) from `users` where `id`='. $id );
+		$anz = (int)$db->executeGetOne( 'SELECT count(*) from `vm_msgs` where `orig_mbox`=\''.$about['origmailbox']. '\' AND `folder`=\'INBOX\'' );
+	
+	$vm_dir = '/var/spool/asterisk/voicemail/';
+	$origorigfile = $vm_dir .'default/'. $mailbox .'/'. $info['fld'] .'/'. $info['file'] .'.alaw';
+	$tmpfile_base = '/tmp/gs-vm-'. preg_replace('/[^0-9]/', '', $mailbox) .'-'. $info['fld'] .'-'. $info['file'];
+	
+	
+	
+	# delete files like /tmp/gs-vm-* with mtime < time()-5 minutes
+	#
+	@exec( 'find \'/tmp/\' -maxdepth 1 -name \'gs-vm-*\' -type f -mmin +5 | xargs rm -f 1>>/dev/null 2>>/dev/null' );
+	# user is on this host
+		if (! file_exists($origorigfile)) {
+			gs_log( GS_LOG_WARNING, "Voicemail \"$origorigfile\" not found on this node." );
+			_not_found( 'File not found on this node.' );
+		}
+		$origfile = $origorigfile;
+	# convert file from original format (aLaw) to WAV (signed linear PCM,
+	# 8000 Hz sampling rate, 16 bits/sample), then to MP3
+	#
+	
+	$err=0;
+	
+	@exec( 'sudo chmod a+r '. qsa($origfile) .' 1>>/dev/null 2>>/dev/null' );
+	if ($err != 0) {
+		gs_log( GS_LOG_WARNING, 'Can\'t read \"$origfile\".' );
+		_server_error( 'Failed to convert file.' );
+	}
+	
+	
+	$outfile = $tmpfile_base.'.wav';
+	
+	
+	$cmd = 'sox -q -t al '. qsa($origfile) .' -r 8000 -c 1 -s -w -t wav '.qsa($outfile).' 2>>/dev/null';
+	gs_log(GS_LOG_DEBUG, $cmd);
+	
+	$err=0; $out=array();
+	@exec( $cmd, $out, $err );
+	if ($err != 0) {
+		gs_log( GS_LOG_WARNING, 'Failed to convert voicemail file.' );
+		gs_log( GS_LOG_WARNING, $cmd );
+	
+		_server_error( 'Failed to convert file.' );
+	}
+	elseif (! file_exists($outfile)) {
+		gs_log( GS_LOG_WARNING, 'Failed to convert voicemail file.' );
+		_server_error( 'Failed to convert file.' );
+	}
+	else{
+		//now lets send a email
+		$GS_EMAIL_DELIVERY = gs_get_conf('GS_EMAIL_DELIVERY');
+		
+		$GS_INTL_LANG = gs_get_conf('GS_INTL_LANG');
+		
+		@exec('hostname 2>>/dev/null', $out, $err);
+			if ($err === 0) {
+				$hostname = trim(implode(' ', $out));
+				if (! $hostname) $hostname = 'localhost';
+			} else {
+				$hostname = 'localhost';
+			}
+		
+		
+		//Voicemail-Tests and Options.
+		
+		if($GS_INTL_LANG == 'en_US'){
+		
+			$body = 'Hallo ' . $fn . ' ' . $ln .",\n\n";
+		
+			$body= $body. 'A new voicemail from ' . $info['cidnum'];
+		
+			if($info['cidname'] != '')$body = $body . ' ('. $info['cidname'] .")just arrived.\n";
+			else $body = $body . " just arrived.\n";
+		
+			$body = $body . "\n"; //new Line
+		
+			$body = $body . 'The new voicemail arrived on extension -' .$about['origmailbox'] . ".\n"; 
+			$body = $body . 'Date: ' .$about['origdate'] . ".\n";
+			$body = $body . 'Duration of recording: ' .$about['duration'] . " seconds.\n";
+			$body = $body . "\n"; //new Line 
+			$body = $body . "The Voicemail is attached to this email.\n";  
+		
+			$body = $body . "\n"; //new Line
+		
+			if($anz == 1){
+				$body = $body . "There is now one new voicemail in your voicemailbox.\n";
+			}
+			else{ 
+				$body = $body . 'There are now ' .$anz . " new voicemails in your voicemailbox.\n";
+			}
+			$subject= 'A new Voicemail from ' . $info['cidnum'];
+		}
+		else{
+			$body = 'Hallo ' . $fn . ' ' . $ln .",\n\n";
+		
+			$body= $body. 'eine neue Voicemail von ' . $info['cidnum'];
+		
+			if($info['cidname'] != '')$body = $body . ' ('. $info['cidname'] .") ist für Sie eingegangen.\n";
+			else $body = $body . " ist für Sie eingegangen.\n";
+		
+			$body = $body . "\n"; //new Line
+		
+			$body = $body . 'Die Voicemail erreichte Sie auf Duchwahl -' .$about['origmailbox'] . ".\n"; 
+			$body = $body . 'Datum: ' .$about['origdate'] . "\n";
+			$body = $body . 'Dauer der Aufzeichnung: ' .$about['duration'] . " Sekunden. \n";
+			$body = $body . "\n"; //new Line 
+			$body = $body . "Diese Voicemail ist im Anhang dieser Email.\n";  
+		
+			$body = $body . "\n"; //new Line
+		
+			if($anz == 1){
+				$body = $body . "Es befindet sich jetzt eine neue Voicemail in Ihrer Mailbox.\n";
+			}
+			else{ 
+				$body = $body . 'Es befinden sich jetzt ' .$anz . " neue Voicemails in Ihrer Mailbox.\n";
+			}
+			$subject= 'Neue Voicemail von ' . $info['cidnum'];
+		}
+		
+		
+		
+		
+		if($info['cidname'] != '')$subject = $subject . ' ('. $info['cidname'] .').';
+		else $subject = $subject . '.';
+		
+		$file_name = 'voicemail.wav'; 
+		
+		if($GS_EMAIL_DELIVERY == 'sendmail'){
+		
+		$boundary = strtoupper(md5(uniqid(time())));
+		$mail_header  ="From:" .  gs_get_conf('GS_EMAIL_NAME') . "<". gs_get_conf('GS_EMAIL_ADDRESS') .">\n";
+		$mail_header .= "MIME-Version: 1.0";
+		$mail_header .= "\nContent-Type: multipart/mixed; boundary=$boundary";
+		$mail_header .= "\n\nThis is a multi-part message in MIME format  --  Dies ist eine mehrteilige Nachricht im MIME-Format";
+		$mail_header .= "\n--$boundary"; 
+		$mail_header .= "\nContent-Type: text/plain; charset=\"utf-8\"";
+		$mail_header .= "\nContent-Transfer-Encoding: 8bit";
+		$mail_header .= "\n\n$body";
+		$file_content = fread(fopen($outfile,"r"),filesize($outfile));
+		$file_content = chunk_split(base64_encode($file_content));
+		$mail_header .= "\n--$boundary";
+		$mail_header .= "\nContent-Type: audio/wav; name=\"".$file_name . "\"";
+		$mail_header .= "\nContent-Transfer-Encoding: base64";
+		$mail_header .= "\nContent-Disposition: attachment; filename=\"$file_name\"";
+		$mail_header .= "\n\n$file_content";
+		$mail_header .= "\n--$boundary--";
+		mail($email,$subject,'',$mail_header);
+		}
+		
+		elseif ($GS_EMAIL_DELIVERY === 'direct-smtp'){
+		
+		$file_content = fread(fopen($outfile,"r"),filesize($outfile));
+		
+			require_once( GS_DIR .'lib/phpmailer/class.phpmailer.php' );
+			$mail = new PHPMailer();
+			$mail->CharSet = 'utf-8';
+			$mail->SetLanguage(
+				strToLower(subStr( gs_get_conf('GS_INTL_LANG'),0,2)),
+				GS_DIR .'lib/phpmailer/language/' );
+			$mail->From = gs_get_conf('GS_EMAIL_ADDRESS');
+			$mail->FromName = gs_get_conf('GS_EMAIL_NAME');
+			$mail->AddReplyTo( '', 'Nicht antworten' ); 
+			$mail->AddAddress($email,'','');
+			$mail->Subject = $subject;
+			$mail->Body =  $body;
+			$mail->AddStringAttachment($file_content,'voicemail.wav','base64','audio/wav');	
+		
+			$mail->IsSMTP();
+			//$mail->SMTPDebug = true;
+			$mail->Timeout = 10;
+			if (! preg_match('/@([^@]+)/', $email, $m)) {
+					$ok = false;
+			} else {
+				$host = $m[1];
+				$mx_hosts   = array();
+				$mx_weights = array();
+				getMXRR($host, $mx_hosts, $mx_weights);
+				$mxs = array();
+				if (@count($mx_hosts) > 0) {
+					for($i=0; $i<count($mx_hosts); ++$i) {
+						$mxs[$mx_hosts[$i]] = @$mx_weights[$i];
+				}
+					aSort($mxs, SORT_NUMERIC);
+				} else {
+					$mxs[$host] = 0;  # RFC 2821
+				}
+				//print_r($mxs);
+				
+				while (list($mx_host, $mx_weight) = each($mxs)) {
+					@set_time_limit(30);
+					$mail->Host = $mx_host;
+					$ok = @$mail->Send();
+					if ($ok) break;
+				}
+			}
+		}
+	
+	
+	}
 
+}
+
+
+
 ?>
\ No newline at end of file
Index: opt/gemeinschaft/dialplan-scripts/in-user-pgrpdialstr.agi
===================================================================
--- opt/gemeinschaft/dialplan-scripts/in-user-pgrpdialstr.agi	(revision 5977)
+++ opt/gemeinschaft/dialplan-scripts/in-user-pgrpdialstr.agi	(working copy)
@@ -48,7 +48,10 @@
 $db = gs_db_slave_connect();
 
 # get user id:
-$uid = (int)$db->executeGetOne( 'SELECT `_user_id` FROM `ast_sipfriends` WHERE `name`=\''. $db->escape($uname) .'\'' );
+if (GS_MASTER_SLAVE_MODE == true)
+	$uid = (int)$db->executeGetOne( 'SELECT `id` FROM `users` WHERE `user`=\''. $db->escape($uname) .'\'' );
+else
+	$uid = (int)$db->executeGetOne( 'SELECT `_user_id` FROM `ast_sipfriends` WHERE `name`=\''. $db->escape($uname) .'\'' );
 if ($uid < 1) die();
 
 
Index: opt/gemeinschaft/dialplan-scripts/in-user-get-vm.agi
===================================================================
--- opt/gemeinschaft/dialplan-scripts/in-user-get-vm.agi	(revision 5977)
+++ opt/gemeinschaft/dialplan-scripts/in-user-get-vm.agi	(working copy)
@@ -49,11 +49,12 @@
 $db = gs_db_slave_connect();
 
 # get user id:
-$uid = (int)$db->executeGetOne( 'SELECT `_user_id` FROM `ast_sipfriends` WHERE `name`=\''. $db->escape($uname) .'\'' );
+if (GS_MASTER_SLAVE_MODE == true)
+	$uid = (int)$db->executeGetOne( 'SELECT `id` FROM `users` WHERE `user`=\''. $db->escape($uname) .'\'' );
+else
+	$uid = (int)$db->executeGetOne( 'SELECT `_user_id` FROM `ast_sipfriends` WHERE `name`=\''. $db->escape($uname) .'\'' );
 if ($uid < 1) die();
 
-
-
 $vm = array(
 	'internal_active'  => 0,
 	'external_active'  => 0
Index: opt/gemeinschaft/inc/canonization.php
===================================================================
--- opt/gemeinschaft/inc/canonization.php	(revision 5977)
+++ opt/gemeinschaft/inc/canonization.php	(working copy)
@@ -98,6 +98,8 @@
 				$this->errt = 'self';
 			} elseif ($this->is_special) {
 				$this->dial = $this->orig;
+			} elseif ($this->_NINT) {
+				$this->dial = $this->intl;
 			} else {
 				$this->dial = $this->natl;
 			}
Index: opt/gemeinschaft/inc/gs-fns/gs_vm_get.php
===================================================================
--- opt/gemeinschaft/inc/gs-fns/gs_vm_get.php	(revision 5977)
+++ opt/gemeinschaft/inc/gs-fns/gs_vm_get.php	(working copy)
@@ -56,8 +56,8 @@
 	#
 	$rs = $db->execute( 'SELECT `internal_active`, `external_active` FROM `vm` WHERE `user_id`='. $user_id );
 	if ($r = $rs->fetchRow()) {
-		$r['internal_active'] = (bool)$r['internal_active'];
-		$r['external_active'] = (bool)$r['external_active'];
+		// $r['internal_active'] = (bool)$r['internal_active'];
+		// $r['external_active'] = (bool)$r['external_active'];
 		return $r;
 	}
 	return array(
Index: opt/gemeinschaft/inc/gs-fns/gs_pickupgroup_del.php
===================================================================
--- opt/gemeinschaft/inc/gs-fns/gs_pickupgroup_del.php	(revision 5977)
+++ opt/gemeinschaft/inc/gs-fns/gs_pickupgroup_del.php	(working copy)
@@ -52,6 +52,19 @@
 	if ($num < 1)
 		return new GsError( 'Unknown pickup group ID.' );
 	
+	# get the users that will be removed
+	#
+		
+	$rs = $db->execute('SELECT DISTINCT `users`.`user` FROM `users`, `pickupgroups_users` WHERE `users`.`id` = `pickupgroups_users`.`user_id` AND `pickupgroups_users`.`group_id`='. $pgroup_id);    
+	if (! $rs)
+	return new GsError( 'Error reading left pickupgroups users' );
+		                         
+	$users = array();
+	while ($r = $rs->fetchRow()){
+	 	$users[] = $r['user'];
+	}
+	
+	
 	# remove users from the group
 	#
 	$ok = $db->execute( 'DELETE FROM `pickupgroups_users` WHERE `group_id`='. $pgroup_id );
@@ -61,7 +74,19 @@
 	$ok = $db->execute( 'DELETE FROM `pickupgroups` WHERE `id`='. $pgroup_id );
 	if (! $ok)
 		return new GsError( 'Failed to remove pickup group.' );
+		
 	
+	# Update user-pickupgroup
+	
+	foreach($users as $user){
+	
+		$ok = gs_pickupgroup_user_set( $user );
+		if (! $ok)
+			return new GsError( 'Failed to update pickupgroups of users.' );
+	
+	}
+		                                 
+	
 	return true;
 }
 
Index: opt/gemeinschaft/inc/gs-fns/gs_user_get.php
===================================================================
--- opt/gemeinschaft/inc/gs-fns/gs_user_get.php	(revision 5977)
+++ opt/gemeinschaft/inc/gs-fns/gs_user_get.php	(working copy)
@@ -53,10 +53,25 @@
 	
 	# get user
 	#
+if (GS_MASTER_SLAVE_MODE == true) {
 	$rs = $db->execute(
 'SELECT
 	`u`.`id`, `u`.`user`, `u`.`pin`, `u`.`email`,
 	`u`.`lastname`, `u`.`firstname`, `u`.`honorific`, `u`.`nobody_index`,
+	`u`.`user` `ext`, `s`.`callerid`, `s`.`mailbox`,
+	`h`.`id` `host_id`, `h`.`host`
+FROM
+	`users` `u` JOIN
+	`ast_sipfriends` `s` ON (`s`.`_user_id`=`u`.`id`) LEFT JOIN
+	`hosts` `h` ON (`h`.`id`=`u`.`host_id`)
+WHERE `u`.`user`=\''. $db->escape($user) .'\''
+	);
+}
+else {
+	$rs = $db->execute(
+'SELECT
+	`u`.`id`, `u`.`user`, `u`.`pin`, `u`.`email`,
+	`u`.`lastname`, `u`.`firstname`, `u`.`honorific`, `u`.`nobody_index`,
 	`s`.`name` `ext`, `s`.`callerid`, `s`.`mailbox`,
 	`h`.`id` `host_id`, `h`.`host`
 FROM
@@ -65,6 +80,7 @@
 	`hosts` `h` ON (`h`.`id`=`u`.`host_id`)
 WHERE `u`.`user`=\''. $db->escape($user) .'\''
 	);
+}
 	if (! $rs)
 		return new GsError( 'Error.' );
 	
Index: opt/gemeinschaft/inc/gs-fns/gs_user_change.php
===================================================================
--- opt/gemeinschaft/inc/gs-fns/gs_user_change.php	(revision 5977)
+++ opt/gemeinschaft/inc/gs-fns/gs_user_change.php	(working copy)
@@ -37,7 +37,7 @@
 *    change a user account
 ***********************************************************/
 
-function gs_user_change( $user, $pin, $firstname, $lastname, $host_id_or_ip, $force=false, $email='' )
+function gs_user_change( $user, $pin, $firstname, $lastname, $host_id_or_ip, $ggrp_id_or_name, $force=false, $email='', $invisible = 0 )
 {
 	if (! preg_match( '/^[a-z0-9\-_.]+$/', $user ))
 		return new GsError( 'User must be alphanumeric.' );
@@ -58,6 +58,10 @@
 	if ($email != '' && ! preg_match( GS_EMAIL_PATTERN_VALID, $email ))
 		return new GsError( 'Invalid e-mail address.' );
 	
+	if (! preg_match( '/^[01]$/', $invisible ))
+		 return new GsError( 'No vaild value for invisible.' );
+	
+	$invisible = (int)$invisible;
 	include_once( GS_DIR .'lib/utf8-normalize/gs_utf_normal.php' );
 	
 	# connect to db
@@ -103,6 +107,20 @@
 		gs_db_rollback_trans($db);
 		return new GsError( 'Changing the host will result in loosing mailbox messages etc. and thus will not be done without force.' );
 	}
+		
+	if (GS_MASTER_SLAVE_MODE == true) {
+		# check if (new) gateway group exists
+		#
+		if ($ggrp_id_or_name == 0 || $ggrp_id_or_name == '') {
+			$group['id'] = NULL;
+		} else {
+			$group = gs_ggrp_by_id_or_name( $ggrp_id_or_name );	
+			if (isGsError( $group ))
+				return new GsError( $host->getMsg() );
+			if (! is_array( $group ))
+				return new GsError( 'Unknown gateway group.' );
+		}
+	}
 	
 	/*
 	# check if queue with same ext exists
@@ -116,7 +134,7 @@
 	
 	# update user
 	#
-	$ok = $db->execute( 'UPDATE `users` SET `pin`=\''. $db->escape($pin) .'\', `firstname`=\''. $db->escape($firstname) .'\', `lastname`=\''. $db->escape($lastname) .'\', `email`=\''. $db->escape($email) .'\', `host_id`='. $host['id'] .' WHERE `id`='. $user_id );
+	$ok = $db->execute( 'UPDATE `users` SET `pin`=\''. $db->escape($pin) .'\', `firstname`=\''. $db->escape($firstname) .'\', `lastname`=\''. $db->escape($lastname) .'\', `email`=\''. $db->escape($email) .'\', `host_id`='. $host['id'] . ', `grp_id`=' . ( ($group['id'] === NULL ) ? 'NULL' : $group['id'] ) . ' ,`invisible`=' . $db->escape($invisible) . ' WHERE `id`='. $user_id );
 	if (! $ok) {
 		gs_db_rollback_trans($db);
 		return new GsError( 'Failed to change user.' );
@@ -130,6 +148,16 @@
 		gs_db_rollback_trans($db);
 		return new GsError( 'Failed to change SIP account.' );
 	}
+		
+	if (GS_MASTER_SLAVE_MODE == true) {
+		gs_log(GS_LOG_NOTICE, 'checking group id for _user_id ' . $user_id . ' : ' . $group['id'] . ', user is: ' . $user);
+		if ((int)$group['id'] > 0)
+			$ok = $db->execute( 'UPDATE `ast_sipfriends` SET `name` = \'_' . $db->escape($user) . '\' WHERE `_user_id`=' . $user_id );
+		else
+			$ok = $db->execute( 'UPDATE `ast_sipfriends` SET `name` = \'' . $db->escape($user) . '\' WHERE `_user_id`=' . $user_id );
+		if (! $ok)
+			return new GsError( 'Failed to enable or disable SIP account.' );
+	}
 	
 	# delete stuff not used for users on foreign hosts
 	#
Index: opt/gemeinschaft/inc/gs-fns/gs_pickupgroup_user_del.php
===================================================================
--- opt/gemeinschaft/inc/gs-fns/gs_pickupgroup_user_del.php	(revision 5977)
+++ opt/gemeinschaft/inc/gs-fns/gs_pickupgroup_user_del.php	(working copy)
@@ -85,8 +85,9 @@
 	# reboot the phone (because of the deleted key)
 	#
 	//@ shell_exec( 'asterisk -rx \'sip notify snom-reboot '. $ext .'\' >>/dev/null' );
-	@ gs_prov_phone_checkcfg_by_ext( $ext, false );
-	
+	if ( GS_BUTTONDAEMON_USE == false ) {
+		@ gs_prov_phone_checkcfg_by_ext( $ext, false );
+	}
 	return true;
 }
 
Index: opt/gemeinschaft/inc/gs-fns/gs_vm_activate.php
===================================================================
--- opt/gemeinschaft/inc/gs-fns/gs_vm_activate.php	(revision 5977)
+++ opt/gemeinschaft/inc/gs-fns/gs_vm_activate.php	(working copy)
@@ -41,7 +41,7 @@
 		return new GsError( 'User must be alphanumeric.' );
 	if (! in_array( $source, array('internal','external'), true ))
 		return new GsError( 'Source must be internal|external.' );
-	$active = (bool)$active;
+	// $active = (bool)$active;
 	
 	# connect to db
 	#
Index: opt/gemeinschaft/inc/gs-fns/gs_pickupgroup_user_add.php
===================================================================
--- opt/gemeinschaft/inc/gs-fns/gs_pickupgroup_user_add.php	(revision 5977)
+++ opt/gemeinschaft/inc/gs-fns/gs_pickupgroup_user_add.php	(working copy)
@@ -85,7 +85,11 @@
 	# reboot the phone (because of a new key)
 	#
 	//@ shell_exec( 'asterisk -rx \'sip notify snom-reboot '. $ext .'\' >>/dev/null' );
-	@ gs_prov_phone_checkcfg_by_ext( $ext, false );
+	/*
+	if ( GS_BUTTONDAEMON_USE == false ) {
+		@ gs_prov_phone_checkcfg_by_ext( $ext, false );
+	}
+	*/
 	
 	return true;
 }
Index: opt/gemeinschaft/inc/gs-fns/gs_hosts_get.php
===================================================================
--- opt/gemeinschaft/inc/gs-fns/gs_hosts_get.php	(revision 5977)
+++ opt/gemeinschaft/inc/gs-fns/gs_hosts_get.php	(working copy)
@@ -52,7 +52,7 @@
 		$where[] = '`group_id`='. (int)$group_id;
 	}
 	$query =
-'SELECT `id`, `host`, `comment`, `is_foreign`, `group_id`
+'SELECT `id`, `hostname`, `host`, `comment`, `is_foreign`, `group_id`
 FROM `hosts`
 '. (count($where)===0 ? '' : ('WHERE '.implode(' AND ', $where))) .'
 ORDER BY `is_foreign`,`host`'
Index: opt/gemeinschaft/inc/gs-fns/gs_user_del.php
===================================================================
--- opt/gemeinschaft/inc/gs-fns/gs_user_del.php	(revision 5977)
+++ opt/gemeinschaft/inc/gs-fns/gs_user_del.php	(working copy)
@@ -94,6 +94,10 @@
 	$db->execute( 'DELETE FROM `dial_log` WHERE `user_id`='. $user_id );
 	$db->execute( 'UPDATE `dial_log` SET `remote_user_id`=NULL WHERE `remote_user_id`='. $user_id );
 	
+	# delete queue dial log
+	#
+	$db->execute( 'DELETE FROM `queue_dial_log` WHERE `user_id`='. $user_id );
+	
 	# delete call waiting settings
 	#
 	$db->execute( 'DELETE FROM `callwaiting` WHERE `user_id`='. $user_id );
@@ -122,6 +126,10 @@
 	#
 	$db->execute( 'DELETE FROM `pb_prv` WHERE `user_id`='. $user_id );
 	
+	# delete outbound numbers
+	#
+	$db->execute( 'DELETE FROM `users_outbound_numbers` WHERE `user_id`='. $user_id );
+	
 	# delete mailbox
 	#
 	$db->execute( 'DELETE FROM `ast_voicemail` WHERE `_user_id`='. $user_id );
@@ -130,6 +138,26 @@
 	#
 	$db->execute( 'DELETE FROM `callblocking` WHERE `user_id`='. $user_id );
 	
+	# delete softkeys
+	#
+	$ok = $db->execute( 'DELETE FROM `softkeys` WHERE `user_id`='. $user_id );
+	
+	# delete volumes
+	#
+	$ok = $db->execute( 'DELETE FROM `volumes` WHERE `user_id`='. $user_id );
+	
+	# delete blacklists
+	#
+	$ok = $db->execute( 'DELETE FROM `blacklists` WHERE `user_id`='. $user_id );
+	
+	# delete ringtones
+	#
+	$ok = $db->execute( 'DELETE FROM `ringtones` WHERE `user_id`='. $user_id );
+	
+	# delete from huntgroups
+	#
+	$ok = $db->execute( 'DELETE FROM `huntgroups` WHERE `user_id`='. $user_id );
+	
 	# delete sip account
 	#
 	$db->execute( 'DELETE FROM `ast_sipfriends` WHERE `_user_id`='. $user_id );
Index: opt/gemeinschaft/inc/gs-fns/gs_queue_del.php
===================================================================
--- opt/gemeinschaft/inc/gs-fns/gs_queue_del.php	(revision 5977)
+++ opt/gemeinschaft/inc/gs-fns/gs_queue_del.php	(working copy)
@@ -62,6 +62,10 @@
 	$queue_id = (int)$db->executeGetOne( 'SELECT `_id` FROM `ast_queues` WHERE `name`=\''. $db->escape($name) .'\'' );
 	if ($queue_id < 1)
 		return new GsError( 'Unknown queue.' );
+		
+        # delete agent relations
+	#
+	$db->execute( 'DELETE FROM `agent_queues` WHERE `queue_id`='. $queue_id );
 	
 	# delete queue members
 	#
@@ -75,6 +79,10 @@
 	#
 	$CDR_DB->execute( 'DELETE FROM `queue_log` WHERE `queue_id`='. $queue_id );
 	
+	# delete agent relations
+	#
+	$db->execute( 'DELETE FROM `agent_queues` WHERE `_queue_id`='. $queue_id );
+	
 	# delete queue
 	#
 	$ok = $db->execute( 'DELETE FROM `ast_queues` WHERE `_id`='. $queue_id .' LIMIT 1' );
Index: opt/gemeinschaft/inc/conf.php
===================================================================
--- opt/gemeinschaft/inc/conf.php	(revision 5977)
+++ opt/gemeinschaft/inc/conf.php	(working copy)
@@ -194,6 +194,8 @@
 
 _gscnf( 'DB_SIP_REG_UPDATE'         , gs_get_conf('GS_INSTALLATION_TYPE_SINGLE') );
 
+_gscnf( 'MASTER_SLAVE_MODE'         , false              );
+
 _gscnf( 'LDAP_HOST'                 , '0.0.0.0'          );
 _gscnf( 'LDAP_SSL'                  , false              );
 _gscnf( 'LDAP_PORT'                 , 0                  );
@@ -317,7 +319,22 @@
 _gscnf( 'USERCOMMENT_OFFTIME'       , 'Feierabend'       );
 _gscnf( 'EMAIL_PATTERN_VALID'       , '/^[a-z0-9\-._]+@[a-z0-9\-._]{2,80}\.[a-z]{2,10}$/i'              );
 _gscnf( 'EMAIL_DELIVERY'            , 'sendmail'         );
+_gscnf( 'EMAIL_ADDRESS'            , 'noreply@localhost'         );
+_gscnf( 'EMAIL_NAME'            , 'Gemeinschaft'         );
 
+# Variables for the Astbuttond
+_gscnf( 'BUTTONDAEMON_USE'          , false         	);
+_gscnf( 'BUTTONDAEMON_HOST'         , '127.0.0.1'		);
+_gscnf( 'BUTTONDAEMON_PORT'         , 5041				);
+_gscnf( 'BUTTONDAEMON_SECRET'       , 'DefaultPassword'	);
+
+# Selectable outbound-number
+_gscnf('OUTBOUNDNUM_SELECTABLE'     , false				);
+
+# Show QueueName instead of Number
+_gscnf('QUEUE_SHOW_QUEUENAME'       , false				);
+
+
 # to communicate with HylaFax ftp_raw() is required, which is not
 # available in PHP < 5
 if ((float)PHP_VERSION < 5.0)
Index: opt/gemeinschaft/etc/listen-to-ip
===================================================================
--- opt/gemeinschaft/etc/listen-to-ip	(revision 5977)
+++ opt/gemeinschaft/etc/listen-to-ip	(working copy)
@@ -4,4 +4,4 @@
 # (/opt/gemeinschaft/sbin/start-asterisk)
 # IF YOU CHANGE THESE ADDRESSES!
 
-192.168.1.130
+212.28.230.68
Index: opt/gemeinschaft/etc/asterisk/e-gategroups-in.ael.php
===================================================================
--- opt/gemeinschaft/etc/asterisk/e-gategroups-in.ael.php	(revision 5977)
+++ opt/gemeinschaft/etc/asterisk/e-gategroups-in.ael.php	(working copy)
@@ -64,32 +64,25 @@
 	echo "\t", '_. => {' ,"\n";
 	echo "\t\t", 'if ("${EXTEN}" != "h" && "${EXTEN}" != "t" && "${EXTEN}" != "i") {' ,"\n";
 	echo "\t\t\t", 'Set(__is_from_gateway=1);' ,"\n";
+	echo "\t\t\t", 'Set(__from_gwgroup=',(int)$ggrp['id'] ,');' ,"\n";
 	if ((int)$ggrp['allow_in']) {
 		echo "\t\t\t", 'Set(did_full=${EXTEN});' ,"\n";
-		
-		/*
-		# hack for Sipgate.de {
-		if (preg_match('/\bsipgate\b/i', $name)) {
-			echo "\t\t\t", "\n";
-			echo "\t\t\t", 'Set(did_full=${SIP_HEADER(To)});' ,"\n";
-			echo "\t\t\t", 'Set(did_full=${CUT(did_full,@,1)});' ,"\n";
-			//echo "\t\t\t", 'Set(did_full=${did_full:5});' ,"\n";
-			# You should cut off the prefix with the gateway group's
-			# search/replace PCRE.
-			echo "\t\t\t", 'Verbose(1,##### Inbound call from Sipgate to ${did_full});' ,"\n";
-			echo "\t\t\t", "\n";
-		}
-		# hack for Sipgate.de }
-		*/
-		
+		# lets see if this is a call from an internal gateway
+		echo "\t\t\t", 'AGI(/opt/gemeinschaft/dialplan-scripts/in-user-get-ggrp.agi,${CALLERID(num)});' ,"\n";
+		echo "\t\t\t", 'if ( "${from_gwgroup}" = "${via_gateway_group}" ){' ,"\n";
+		echo "\t\t\t\t", 'Set(__user_name=${CALLERID(num)});' ,"\n";
+		echo "\t\t\t\t", 'AGI(/opt/gemeinschaft/dialplan-scripts/ggrpuser-set-vars.agi,${CALLERID(num)});' ,"\n";
+		echo "\t\t\t\t", 'Goto(from-internal-users,${EXTEN},1);' ,"\n";
+		echo "\t\t\t", '}' ,"\n";
 		# strip prefix off DID number (sets sets did_ext) and apply
 		# redirection rules for inbound calls (sets did_ext_to):
-		echo "\t\t\t", 'AGI(/opt/gemeinschaft/dialplan-scripts/in-route.agi,', (int)$ggrp['id'] ,',${did_full});' ,"\n";
+		echo "\t\t\t", 'AGI(/opt/gemeinschaft/dialplan-scripts/in-route.agi,', (int)$ggrp['id'] ,',${EXTEN},${CALLERID(num)});' ,"\n";
 		# make it appear as if the caller had dialed the extension without
 		# our trunk prefix etc.:
 		echo "\t\t\t", 'Set(CALLERID(dnid)=${did_ext});' ,"\n";
 		echo "\t\t\t", 'Verbose(1,### Inbound call from gw group "', $name ,'". dnid: ${did_full} => ext: ${did_ext} => ${did_ext_to});' ,"\n";
 		echo "\t\t\t", 'if ("${did_ext_to}" != "") {' ,"\n";
+		echo "\t\t\t\t", 'Set(CALLERID(dnid)=${did_ext_to});' ,"\n";
 		echo "\t\t\t\t", 'Goto(from-gateways,${did_ext_to},1);' ,"\n";
 		echo "\t\t\t", '}' ,"\n";
 		echo "\t\t\t", 'else {' ,"\n";
Index: opt/gemeinschaft/etc/asterisk/sip.conf
===================================================================
--- opt/gemeinschaft/etc/asterisk/sip.conf	(revision 5977)
+++ opt/gemeinschaft/etc/asterisk/sip.conf	(working copy)
@@ -78,9 +78,9 @@
 pedantic=yes
 
 ; See doc/README.tos for a description of these parameters.
-tos_sip=cs3                     ; Sets TOS for SIP packets.
-tos_audio=ef                    ; Sets TOS for RTP audio packets.
-tos_video=af41                  ; Sets TOS for RTP video packets.
+; tos_sip=cs3                     ; Sets TOS for SIP packets.
+; tos_audio=ef                    ; Sets TOS for RTP audio packets.
+; tos_video=af41                  ; Sets TOS for RTP video packets.
 
 ;maxexpiry=300                  ; Maximum allowed time of incoming registrations
                                 ; and subscriptions (seconds)
@@ -522,5 +522,3 @@
 
 ; create peers and users for the other Gemeinschaft nodes:
 #exec /opt/gemeinschaft/etc/asterisk/sip-nodes.conf.php
-
-
Index: opt/gemeinschaft/etc/asterisk/modules.conf
===================================================================
--- opt/gemeinschaft/etc/asterisk/modules.conf	(revision 5977)
+++ opt/gemeinschaft/etc/asterisk/modules.conf	(working copy)
@@ -94,3 +94,4 @@
 noload => app_zapras.so
 noload => app_zapscan.so
 
+noload => chan_zap.so
Index: opt/gemeinschaft/etc/asterisk/e-user-config.ael
===================================================================
--- opt/gemeinschaft/etc/asterisk/e-user-config.ael	(revision 5977)
+++ opt/gemeinschaft/etc/asterisk/e-user-config.ael	(working copy)
@@ -178,16 +178,35 @@
 		&user-call-forward-activate-numeric(std,0,0,1);
 		&user-call-forward-activate-numeric(std,1,0,1);
 		&queue-logout-all-silent();
+		&user-call-forward-buttond-notify();
 		Wait(0.5);
 		Playback(/opt/gemeinschaft/sounds/de-DE/rufumleitung&/opt/gemeinschaft/sounds/de-DE/aktiviert);
 		Hangup();
 	}
+	*31 => {
+		//redirect internal std
+		&user-call-forward-activate-numeric(std,0,0,1);
+		&queue-logout-all-silent();
+		&user-call-forward-buttond-notify();
+		Wait(0.5);
+		Playback(gemeinschaft/rufumleitung&gemeinschaft/aktiviert);
+		Hangup();
+	}
+	*32 => {
+		&user-call-forward-activate-numeric(std,1,0,1);
+		&queue-logout-all-silent();
+		&user-call-forward-buttond-notify();
+		Wait(0.5);
+		Playback(gemeinschaft/rufumleitung&gemeinschaft/aktiviert);
+		Hangup();
+	}
 	dnd-on => {
 		// like *2 but silent
 		Set(CDR(amaflags)=OMIT);
 		&user-call-forward-activate-numeric(std,0,0,1);
 		&user-call-forward-activate-numeric(std,1,0,1);
 		&queue-logout-all-silent();
+		&user-call-forward-buttond-notify();
 		Hangup();
 	}
 	
@@ -195,15 +214,32 @@
 		Set(CDR(amaflags)=OMIT);
 		&user-call-forward-activate-numeric(std,0,0,0);
 		&user-call-forward-activate-numeric(std,1,0,0);
+		&user-call-forward-buttond-notify();
 		Wait(0.5);
 		Playback(/opt/gemeinschaft/sounds/de-DE/rufumleitung&/opt/gemeinschaft/sounds/de-DE/deaktiviert);
 		Hangup();
 	}
+
+	*31* => {
+		&user-call-forward-activate-numeric(std,0,0,0);
+		&user-call-forward-buttond-notify();
+		Wait(0.5);
+		Playback(gemeinschaft/rufumleitung&gemeinschaft/deaktiviert);
+		Hangup();
+	}
+	*32* => {
+		&user-call-forward-activate-numeric(std,1,0,0);
+		&user-call-forward-buttond-notify();
+		Wait(0.5);
+		Playback(gemeinschaft/rufumleitung&gemeinschaft/deaktiviert);
+		Hangup();
+	}
 	dnd-off => {
 		// like *2* but silent
 		Set(CDR(amaflags)=OMIT);
 		&user-call-forward-activate-numeric(std,0,0,0);
 		&user-call-forward-activate-numeric(std,1,0,0);
+		&user-call-forward-buttond-notify();
 		Hangup();
 	}
 	
@@ -224,10 +260,41 @@
 		&user-call-forward-activate-numeric(var,0,0,1);
 		&user-call-forward-activate-numeric(var,1,0,1);
 		&queue-logout-all-silent();
+		&user-call-forward-buttond-notify();
 		Wait(0.5);
 		Playback(/opt/gemeinschaft/sounds/de-DE/rufumleitung&/opt/gemeinschaft/sounds/de-DE/aktiviert);
 		Hangup();
 	}
+	_*31X. => {
+		&usercode-by-ext(${user_name});
+		if ("${user_code}" = "")
+			Hangup();
+		Answer();
+		Set(tonumber=${EXTEN:3});
+		System(/opt/gemeinschaft/scripts/gs_callforward_number_set --user='${user_code}' --source='internal' --type='var' --number='${tonumber}');
+		System(/opt/gemeinschaft/scripts/gs_callforward_number_set --user='${user_code}' --source='external' --type='var' --number='${tonumber}');
+		&user-call-forward-activate-numeric(var,0,0,1);
+		&queue-logout-all-silent();
+		&user-call-forward-buttond-notify();
+		Wait(0.5);
+		Playback(gemeinschaft/rufumleitung&gemeinschaft/aktiviert);
+		Hangup();
+	}
+	_*32X. => {
+		&usercode-by-ext(${user_name});
+		if ("${user_code}" = "")
+			Hangup();
+		Answer();
+		Set(tonumber=${EXTEN:3});
+		System(/opt/gemeinschaft/scripts/gs_callforward_number_set --user='${user_code}' --source='internal' --type='var' --number='${tonumber}');
+		System(/opt/gemeinschaft/scripts/gs_callforward_number_set --user='${user_code}' --source='external' --type='var' --number='${tonumber}');
+		&user-call-forward-activate-numeric(var,1,0,1);
+		&queue-logout-all-silent();
+		&user-call-forward-buttond-notify();
+		Wait(0.5);
+		Playback(gemeinschaft/rufumleitung&gemeinschaft/aktiviert);
+		Hangup();
+	}	
 	
 	*30 => {
 		Set(CDR(amaflags)=OMIT);
@@ -245,8 +312,6 @@
 		Hangup();
 	}
 
-
-	
 	//-------------------------------------------------------------
 	// Comment
 	//-------------------------------------------------------------
@@ -354,3 +419,13 @@
 	System(/opt/gemeinschaft/scripts/gs-callforward-activate --user='${user_code}' --source='${msource}' --case='${mcase}' --active='${mactive}');
 }
 
+macro user-call-forward-buttond-notify() {
+	
+	&usercode-by-ext(${user_name});
+	if ("${user_code}" = "")
+		Hangup();
+	
+	System(/opt/gemeinschaft/scripts/gs_callforward_notifybd --user='${user_name}');
+}
+
+
Index: opt/gemeinschaft/etc/asterisk/sip-nodes.conf.php
===================================================================
--- opt/gemeinschaft/etc/asterisk/sip-nodes.conf.php	(revision 5977)
+++ opt/gemeinschaft/etc/asterisk/sip-nodes.conf.php	(working copy)
@@ -54,7 +54,8 @@
 	//echo "HOSTS:\n"; print_r($hosts);
 	
 	$min_our_ids = (count($our_ids) > 0) ? min($our_ids) : 0;
-	$outUser = 'gs-'. str_pad( $min_our_ids, 4, '0', STR_PAD_LEFT );
+	$outUser = hostbyid($hosts, $min_our_ids);
+	//$outUser = 'gs-'. str_pad( $min_our_ids, 4, '0', STR_PAD_LEFT );
 	
 	$out = '';
 	foreach ($hosts as $host) {
@@ -66,7 +67,7 @@
 		
 		# it's one of the other nodes
 		
-		$inUser = 'gs-'. str_pad( $host['id'], 4, '0', STR_PAD_LEFT );
+		$inUser = $host['hostname'];
 		$inPass = 'thiS is rEally seCret.';
 		$inPass = subStr( str_replace(
 			array( '+', '/', '=' ),
@@ -75,16 +76,16 @@
 		), 0, 25 );
 		$outPass = $inPass;
 		
-		$name = str_pad( $host['id'], 4, '0', STR_PAD_LEFT );
+		$name = $host['hostname'];
 		$out .= '
-[gs-'. $name .'](node-user)
+['. $name .'](node-user)
 host='. $host['host'] .'
 defaultip='. $host['host'] .'
 username='. $inUser .'
 secret='. $inPass .'
 setvar=__from_node=yes
 
-[gs-'. $name .'](node-peer)
+['. $name .'](node-peer)
 host='. 'dynamic' .'
 defaultip='. $host['host'] .'
 username='. $outUser .'
@@ -123,6 +124,14 @@
 	if ($gw['name'] == '') continue;
 	if ($gw['host'] == '') continue;
 
+	if (strpos($gw['host'], ':')) {
+		$host = substr($gw['host'], 0, strpos($gw['host'], ':'));
+		$port = substr(strstr($gw['host'], ':'), 1);
+	} else {
+		$host = $gw['host'];
+		$port = '5060';
+	}
+
 	if ($gw['host'] == 'sip.1und1.de') {
 		echo '[', $gw['name'] ,']' ,"\n";
 		echo 'type = peer' ,"\n";
@@ -147,12 +156,11 @@
 		echo "allow=g729\n";
 		echo "allow=gsm\n";
 		echo "allow=slinear\n\n";
-	}
-	else {
+	} else {
 		echo '[', $gw['name'] ,']' ,"\n";
 		echo 'type = peer' ,"\n";
 		echo 'host = ' , $gw['host'] ,"\n";
-		echo 'port = 5060' ,"\n";
+		echo 'port = ' , $port ,"\n";
 		echo 'username = ', $gw['user'] ,"\n";
 		echo 'secret = ' , $gw['pwd' ] ,"\n";
 		echo 'nat = yes' ,"\n";
@@ -170,5 +178,15 @@
 
 }
 
+function hostbyid($hosts, $hostid){
+	
+	foreach($hosts as $host){
+	
+		if($host['id'] == $hostid)return $host['hostname'];
+	}
+	return "xxx";
+	
 
-?>
\ No newline at end of file
+}
+
+?>
Index: opt/gemeinschaft/etc/asterisk/sip-register.conf.php
===================================================================
--- opt/gemeinschaft/etc/asterisk/sip-register.conf.php	(revision 5977)
+++ opt/gemeinschaft/etc/asterisk/sip-register.conf.php	(working copy)
@@ -58,7 +58,7 @@
 	if ($min_our_ids < 1) {
 		gs_log(GS_LOG_WARNING, 'This server is not configured to be a Gemeinschaft node. Not registering to other nodes.');
 	} else {
-		$outUser = 'gs-'. str_pad( $min_our_ids, 4, '0', STR_PAD_LEFT );
+		$outUser = hostbyid($hosts, $min_our_ids);
 		
 		$out = '';
 		foreach ($hosts as $host) {
@@ -71,7 +71,7 @@
 			
 			# it's one of the other nodes
 			
-			$inUser = 'gs-'. str_pad( $host['id'], 4, '0', STR_PAD_LEFT );
+			$inUser = $host['hostname'];
 			$inPass = 'thiS is rEally seCret.';
 			$inPass = subStr( str_replace(
 				array( '+', '/', '=' ),
@@ -80,8 +80,8 @@
 			), 0, 25 );
 			$outPass = $inPass;
 			
-			$name = str_pad( $host['id'], 4, '0', STR_PAD_LEFT );
-			$out .= 'register => '. $outUser .'@gs-'. $name .'/'. $inUser ."\n";
+			$name = $host['hostname'];
+			$out .= 'register => '. $outUser . '@' . $name .'/'. $inUser ."\n";
 		}
 		echo "\n", $out;
 	}
@@ -144,5 +144,15 @@
 }
 echo "\n";
 
+function hostbyid($hosts, $hostid){
+	
+	foreach($hosts as $host){
+	
+		if($host['id'] == $hostid)return $host['hostname'];
+	}
+	return "xxx";
+	
 
+}
+
 ?>
\ No newline at end of file
Index: opt/gemeinschaft/etc/asterisk/manager.conf
===================================================================
--- opt/gemeinschaft/etc/asterisk/manager.conf	(revision 5977)
+++ opt/gemeinschaft/etc/asterisk/manager.conf	(working copy)
@@ -102,4 +102,4 @@
 read = call,command,system
 write = call,command,system
 
-
+#exec /opt/gemeinschaft/etc/asterisk/astbuttond_manager.php
Index: opt/gemeinschaft/etc/asterisk/e-internal.ael
===================================================================
--- opt/gemeinschaft/etc/asterisk/e-internal.ael	(revision 5977)
+++ opt/gemeinschaft/etc/asterisk/e-internal.ael	(working copy)
@@ -25,7 +25,12 @@
 // MA 02110-1301, USA.
 //---------------------------------------------------------------------
 
+//---------------------------------------------------------------------
+//  Custom dialplan additions
+//---------------------------------------------------------------------
 
+#include "/opt/gemeinschaft/etc/asterisk/custom/e-internal.ael"
+
 //---------------------------------------------------------------------
 //  Check if extension is valid
 //---------------------------------------------------------------------
@@ -45,9 +50,9 @@
 	}
 	
 	// is it to one of *our* extensions?
-	AGI(/opt/gemeinschaft/dialplan-scripts/in-get-where.agi,${mext});
+	AGI(/opt/gemeinschaft/dialplan-scripts/in-get-where.agi,${mext},${is_huntgroup});
 	Verbose(1,### Extension ${mext} is of type ${exttype});
-	if ("${exttype}" != "user" && "${exttype}" != "queue" && "${exttype}" != "conference" && "${exttype}" != "foreign") {
+	if ("${exttype}" != "huntgroup" && "${exttype}" != "user" && "${exttype}" != "queue" && "${exttype}" != "conference" && "${exttype}" != "foreign") {
 		Verbose(1,### Extension ${mext} is unknown);
 		
 		if ("${is_from_gateway}" = "1") {
@@ -62,6 +67,12 @@
 			Verbose(1,### We are a sub-system. Dial to the gateway.);
 			&dial-gateway(${mext});
 		} else {
+			Verbose(1,### We are not a sub-system. Trying custom contexts.);
+			if ("${is_from_gateway}" = "1") {
+				Goto(from-gateways-custom,${mext},1);
+			} else {
+				Goto(from-internal-users-custom,${mext},1);
+			}
 			Verbose(1,### We are not a sub-system. Hang up.);
 		}
 		Hangup();
@@ -101,6 +112,10 @@
 //---------------------------------------------------------------------
 
 context to-internal-nobody {
+
+	includes {
+		to-internal-nobody-custom;
+	}
 	
 	#exec "/opt/gemeinschaft/etc/asterisk/e-nobody-exten.php"
 	
@@ -135,7 +150,7 @@
 	}
 	&set-callerid-by-clir();
 	Verbose(1,### Call local nobody ${mext3}\, timeout 30);
-	Dial(SIP/${mext3},30);
+	Dial(SIP/${mext3},30,o);
 	&hangup-proper-status();
 }
 
@@ -144,6 +159,10 @@
 //---------------------------------------------------------------------
 
 context to-internal-users {
+
+	includes {
+		to-internal-users-custom;
+	}
 	
 	//----------------------------------------------------------
 	// from ISDN
@@ -280,10 +299,9 @@
 	
 	/*
 	_*8. => {
-		//&dial-node(${EXTEN}@gs-0002);
 		if ("${PICKUPMARK}" = "") {
-			Set(pmark=${EXTEN:2});
-			Verbose(1,### User ${user_name} tries to pickup ${pmark});
+			Set(pmark=0${EXTEN:2});
+			Verbose(1,### User ${user_name} tries to Pickup ${pmark});
 			Pickup(${pmark}@PICKUPMARK);
 		}
 	}
@@ -297,9 +315,15 @@
 		Set(pext=${EXTEN:4});
 		if ("${pext}" != "") {
 			Verbose(1,### User ${user_name} tries to pickup ext. ${pext});
-			//FIXME - add pickup group check
-			Pickup(${pext}@to-internal-users-self);
-			//FIXME - does not work across nodes
+			&check-valid-extension(${EXTEN:4});
+			if ("${dial_to_node}" = "") {
+				Verbose(1,### Extension ${EXTEN} is at node: SELF);
+				 PickupChan(SIP/${pext});
+			}
+			else {
+				&dial-node(${EXTEN}@${dial_to_node});
+				&hangup-proper-status();
+			}
 		}
 	}
 	
@@ -312,7 +336,6 @@
 		if ("${PICKUPMARK}" = "") {
 			Set(pmark=${EXTEN:6});
 			Verbose(1,### User ${user_name} tries to pickup group ${pmark});
-			//FIXME - add pickup group check
 			Pickup(${pmark}@PICKUPMARK);
 			//FIXME - does not work across nodes
 			
@@ -448,8 +471,17 @@
 	//}
 }
 
+context to-internal-users-huntgroup {
 
+	_Z. => {
+		Set(is_huntgroup=1);
+		Goto(to-internal-users,${EXTEN},1);
+	}
+
+}
+
 context to-internal-users-self {
+
 	
 	// in this context it is guaranteed that the called extension is at
 	// the local node
@@ -457,6 +489,18 @@
 	//----------------------------------------------------------
 	// Boss/secretary function (override call forwards)
 	//----------------------------------------------------------
+
+	_*81*. => {
+		Set(pext=${EXTEN:4});
+		if ("${pext}" != "") {
+			Verbose(1,### User ${user_name} tries to pickup ext. ${pext});
+			//Pickup(1);
+			 PickupChan(SIP/${pext});
+			
+			//FIXME - this probably does not work across nodes
+		}
+	}
+
 	
 	_***-Z. => {
 		Set(boss=${EXTEN:4});
@@ -476,7 +520,7 @@
 		//	Set(CALLERID(all)=${saved_callerid});
 		//}
 		Set(CALLERID(name)=Sek. ${CALLERID(name)});
-		Dial(SIP/${boss},30);
+		Dial(SIP/${boss},30,o);
 		&hangup-proper-status();
 	}
 	
@@ -551,7 +595,6 @@
 	//----------------------------------------------------------
 	
 	_Z. => {
-		
 		Verbose(1,### Incoming call to ${EXTEN} at this node);
 		
 		//if ("${saved_callerid}" != "") {
@@ -605,8 +648,8 @@
 			}
 			else {
 				if ("${is_callfile_origin}" != "1") {
-					&is_dmz(${CALLERID(num)});
-					if ("${is_dmz}" != "1") {
+					//&is_dmz(${CALLERID(num)});
+					if ("${is_from_gateway}" == "1") {
 						Set(__is_call_from=external);
 					}
 					else {
@@ -630,10 +673,12 @@
 		&set-callerid-by-clir();
 		
 		// check the type of the called extension:
-		AGI(/opt/gemeinschaft/dialplan-scripts/in-get-type.agi,${EXTEN});
-		Verbose(1,### Incoming call to ${EXTEN}\, type: ${exttype}\, forwards: ${forwards});
+		AGI(/opt/gemeinschaft/dialplan-scripts/in-get-type.agi,${EXTEN},${is_huntgroup});
+		Verbose(1,### Incoming call to ${EXTEN}\, type: ${exttype}\, forwards: ${forwards}\, is_huntgroup: ${is_huntgroup});
 		
 		// is it a user? is it a queue?
+		if ("${exttype}" = "huntgroup")
+			goto to_huntgroup;
 		if ("${exttype}" = "user")
 			goto to_user;
 		if ("${exttype}" = "queue")
@@ -643,11 +688,66 @@
 		// the AGI script failed:
 		Verbose(1,### The AGI script returned an empty or bad type ("${exttype}")!);
 		Hangup();
+
+		//----------------------------------------------------------
+		// type is "huntgroup":
+		//----------------------------------------------------------
+		to_huntgroup:
+			Set(is_huntgroup=1);
+			AGI(/opt/gemeinschaft/dialplan-scripts/in-huntgroup-get.agi,${EXTEN},${is_call_from});
+			Set(huntgroup=1);
+			
+			AGI(/opt/gemeinschaft/dialplan-scripts/in-huntgroup-get-fw.agi,${EXTEN});
+			// forward (case=always) active?
+			if ("${fw_${is_call_from}_always}" != "") {
+				Verbose(1,### Called huntgroup: ${EXTEN} - always forward to: ${fw_${is_call_from}_always});
+				Set(__forwarded_by=${EXTEN});
+				Set(__is_from_gateway=);
+				Set(__redirect=${fw_${is_call_from}_always});
+				Dial(Local/${fw_${is_call_from}_always}/n,900);
+				&hangup-proper-status();
+			}
+			
+			if ("${huntgroup_strategy}" = "linear") {
+				while ("${huntgroup_${huntgroup}_dial}" != "") {
+					Verbose(1,### huntgroup member: ${huntgroup_${huntgroup}_dial});
+					Dial(Local/${huntgroup_${huntgroup}_dial}@to-internal-users-huntgroup,${huntgroup_${huntgroup}_timeout},o);
+					huntgroup=${huntgroup}+1;
+					}
+			} else {
+				Verbose(1,### Dialling hunt group ${EXTEN} in parallel mode);
+				Dial(${huntgroup_dial},${huntgroup_timeout},o);
+			}
+			Verbose(1,### finished trying huntgroup members. Last dialstatus: ${DIALSTATUS});
+			if("${DIALSTATUS}" = "CHANUNAVAIL"){
+				//"CHANUNAVAIL" may also be the dialstatus if nobody answers
+				Set(DIALSTATUS=NOANSWER);
+				Verbose(1,### Changed DIALSTATUS from CHANUNAVAIL to ${DIALSTATUS});
+			}
+			//write to log if nobody answered
+			if("${DIALSTATUS}" = "NOANSWER"){
+				Set(huntgroup=1);
+				while ("${huntgroup_${huntgroup}_dial}" != "") {
+					Verbose(1,### Writing missing call to DialLog: ${huntgroup_${huntgroup}_dial});
+					&dial-log-store(${huntgroup_${huntgroup}_dial},missed,${CALLERID(num)});
+					huntgroup=${huntgroup}+1;
+				}
+			}
+
+			if ("${fw_${is_call_from}_timeout}" != "") {
+			  Verbose(1,### forwarding call to ${fw_${is_call_from}_timeout});
+			  Set(__forwarded_by=${EXTEN});
+			  Set(__is_from_gateway=);
+			  Set(__redirect=${fw_${is_call_from}_timeout});	
+			  Dial(Local/${fw_${is_call_from}_timeout}/n,900);
+			}
+			&hangup-proper-status();
 		
 		//----------------------------------------------------------
 		// type is "user":
 		//----------------------------------------------------------
 		to_user:
+			Set(user_extension=${EXTEN});
 			
 			AGI(/opt/gemeinschaft/dialplan-scripts/in-user-get-fw.agi,${EXTEN});
 			// forward (case=always) active?
@@ -657,10 +757,12 @@
 					Verbose(1,### Call completion to ${EXTEN} - don't forward);
 					Hangup();
 				}
-				if ("${is_callfile_origin}" != "1") {
-					Verbose(1,### Called user: ${EXTEN} - always forward to: ${fw_${is_call_from}_always});
+			if ("${is_callfile_origin}" != "1") {
+				Verbose(1,### Called user: ${EXTEN} - always forward to: ${fw_${is_call_from}_always});
 					Set(__forwarded_by=${EXTEN});
 					Set(__is_from_gateway=);
+					Set(user_extension=${fw_${is_call_from}_always});
+					Set(__redirect=${fw_${is_call_from}_always});
 					Dial(Local/${fw_${is_call_from}_always}/n,200);
 					&hangup-proper-status();
 				}
@@ -669,18 +771,42 @@
 					Verbose(1,### Callfile: Don't forward for origin side);
 				}
 			}
-			
-			// call the user
-			//
-			#exec "/opt/gemeinschaft/etc/asterisk/e-dialtimeout-in.ael.php"
-			if ("${is_callfile_origin}" != "1") {
-				if ("${fw_${is_call_from}_unavail}" != "") {
-					Set(dialtimeout=${fw_${is_call_from}_unavail_timeout});
+
+			AGI(/opt/gemeinschaft/dialplan-scripts/in-user-get-blacklist.agi, ${EXTEN}, ${CALLERID(number)});
+			if ("${blacklist_match}" = "1") {
+				Set(DIALSTATUS="BUSY");
+				if ("${is_huntgroup}" = "1") {
+					Verbose(1,### blacklist match in huntgroup - skipping member);
+					Hangup();
 				}
+				else {
+					goto user_uncallable;
+				}
 			}
-			else {
-				Set(dialtimeout=15);
+      
+			AGI(/opt/gemeinschaft/dialplan-scripts/in-user-get-dnd.agi,${EXTEN});
+			if ("${dnd_active}" = "1") {
+				Set(DIALSTATUS="BUSY");
+				if ("${is_huntgroup}" = "1") {
+					Verbose(1,### DND active in huntgroup - skipping member);
+					Hangup();
+				}
+				if ("${whitelist_match}" != "1") {
+					goto user_uncallable;
+				}
 			}
+
+			if ("${is_huntgroup}" != "1") {
+				#exec "/opt/gemeinschaft/etc/asterisk/e-dialtimeout-in.ael.php"
+				if ("${is_callfile_origin}" != "1") {
+					if ("${fw_${is_call_from}_unavail}" != "") {
+						Set(dialtimeout=${fw_${is_call_from}_unavail_timeout});
+					}
+				}
+				else {
+					Set(dialtimeout=15);
+				}
+			}
 			
 			// get ringer
 			AGI(/opt/gemeinschaft/dialplan-scripts/in-user-get-ringer.agi,${EXTEN},${is_call_from});
@@ -692,6 +818,7 @@
 			
 			if ("${is_callfile_origin}" != "1") {
 				AGI(/opt/gemeinschaft/dialplan-scripts/in-user-pgrpdialstr.agi,${EXTEN});
+				Verbose(1,### PICKUPMARK: ${PICKUPMARK});
 			}
 			else {
 				Set(pgrpdialstr=);
@@ -702,9 +829,34 @@
 			else {
 				Verbose(1,### Call local user ${EXTEN}\, timeout: none);
 			}
-			Dial(SIP/${EXTEN}${pgrpdialstr},${dialtimeout});
+
+			AGI(/opt/gemeinschaft/dialplan-scripts/in-user-get-ggrp.agi,${EXTEN});
+			if ("${via_gateway_group}" != "0") {
+				AGI(/opt/gemeinschaft/dialplan-scripts/gateway-route.agi,${via_gateway_group},${EXTEN});
+				Set(no_route=1);
+				Set(r=1);
+				while ("${r_${r}_dial}" != "") {
+					Verbose(1,### route: r_${r}_dial);
+					Set(no_route=);
+					Verbose(1,### Gateway route: ${r_${r}_dial});
+					Dial(${r_${r}_dial},${dialtimeout},o);
+					Verbose(1,### Dialstatus for ${r_${r}_dial}: ${DIALSTATUS});
+					if ("${DIALSTATUS}" = "ANSWER" || "${DIALSTATUS}" = "CANCEL") {
+						Hangup();
+					}
+
+					if (${r} > 10) {
+						Verbose(1,### Could not reach ${mnumber} via 10 different gateways);
+					}
+					r=${r}+1;
+				}
+				Verbose(1,### finished trying via gateways);
+			} else {
+				AGI(/opt/gemeinschaft/dialplan-scripts/in-get-callername.agi,${EXTEN},${CALLERID(num)},${CALLERID(name)});
+				Dial(SIP/${EXTEN}${pgrpdialstr},${dialtimeout},o);
+			}
 			
-			if ("${is_callfile_origin}" != "1") {
+			if (("${is_callfile_origin}" != "1") && ("${is_huntgroup}" != "1") ) {
 				Set(is_dnd=0);
 				if ("${DIALSTATUS}" = "BUSY") {         // busy or deflected
 					//if ("${HANGUPCAUSE}" = "19" || "${HANGUPCAUSE}" = "21") {
@@ -739,7 +891,12 @@
 				}
 			}
 			else {
-				Verbose(1,### Callfile: Origin user ${callfile_from_user} did not answer);
+				if ("${is_huntgroup}" = "1") {
+					Verbose(1,### Huntgroup: user ${EXTEN} did not answer - hangup);
+					Hangup();
+				} else {
+					Verbose(1,### Callfile: Origin user ${callfile_from_user} did not answer);
+				}
 				NoCDR();
 			}
 			Hangup();
@@ -758,6 +915,8 @@
 					Verbose(1,### Called user: ${EXTEN}\, forward on busy to: ${fw_${is_call_from}_busy});
 					Set(__forwarded_by=${EXTEN});
 					Set(__is_from_gateway=);
+					Set(user_extension=${fw_${is_call_from}_busy});
+					Set(__redirect=${fw_${is_call_from}_busy});
 					Dial(Local/${fw_${is_call_from}_busy}/n,200);
 					&hangup-proper-status();
 				}
@@ -777,6 +936,8 @@
 					Verbose(1,### Called user ${EXTEN} - forward on unavail to: ${fw_${is_call_from}_unavail});
 					Set(__forwarded_by=${EXTEN});
 					Set(__is_from_gateway=);
+					Set(user_extension=${fw_${is_call_from}_unavail});
+					Set(__redirect=${fw_${is_call_from}_unavail});
 					Dial(Local/${fw_${is_call_from}_unavail}/n,200);
 					&hangup-proper-status();
 				}
@@ -796,6 +957,8 @@
 					Verbose(1,### Called user: ${EXTEN} - forward on offline to: ${fw_${is_call_from}_offline});
 					Set(__forwarded_by=${EXTEN});
 					Set(__is_from_gateway=);
+					Set(user_extension=${fw_${is_call_from}_offline});
+					Set(__redirect=${fw_${is_call_from}_offline});
 					Dial(Local/${fw_${is_call_from}_offline}/n,200);
 					Congestion(3);
 					&hangup-proper-status();
@@ -820,10 +983,11 @@
 				Verbose(1,### Called queue: ${EXTEN} - always forward to: ${fw_${is_call_from}_always});
 				Set(__forwarded_by=${EXTEN});
 				Set(__is_from_gateway=);
+				Set(__redirect=${fw_${is_call_from}_always});
 				Dial(Local/${fw_${is_call_from}_always}/n,900);
 				&hangup-proper-status();
 			}
-			
+			AGI(/opt/gemeinschaft/dialplan-scripts/queue-get-members.agi,${EXTEN});
 			Set(queuetimeout=3600);
 			if ("${fw_${is_call_from}_timeout}" != "")
 				Set(queuetimeout=${fw_${is_call_from}_timeout_timeout});
@@ -835,42 +999,26 @@
 				Verbose(1,### Enter local queue ${EXTEN}\, timeout: none);
 			}
 			
-			//Set(CALLERID(name)=Queue ${EXTEN});
-			//Set(CALLERID(name)=Q${EXTEN} ${CALLERID(name)});
-			Set(CALLERID(name)=[${queue_displayname}] ${CALLERID(name)});
+			if("${showname}" == "true"){
+
+				if("${queuename}" == "")
+					Set(CALLERID(name)=Q-${EXTEN} ${CALLERID(name)});
+			
+				else
+					Set(CALLERID(name)=Q-${queuename} ${CALLERID(name)});
+			}
+			else {
+				Set(CALLERID(name)=Q${EXTEN} ${CALLERID(name)});
+			}
+
 			if ("${CALLERID(num)}" = "")
 				Set(CALLERID(num)=${EXTEN});
 			
 			Set(all_busy=);
 			
-			// SONDERFALL HACK
-			//if ("${EXTEN}" = "5000") {
-			//	Answer();
-			//	Wait(0.5);
-			//	Set(ring_instead_of_moh=r);
-			//	Set(queuetimeout=30);
-			//	Verbose(1,### Sonderfall fuer Queue ${EXTEN} - klingeln statt MOH\, timeout: ${queuetimeout});
-			//	AGI(/opt/gemeinschaft/dialplan-scripts/queue-num-avail-members.agi,${EXTEN});
-			//	Verbose(1,### Sonderfall fuer Queue ${EXTEN} - Agenten: ${queue_num_members}\, frei: ${queue_avail_members});
-			//	if ("${queue_avail_members}" = "0") {
-			//		Set(all_busy=1);
-			//		if ("${queue_num_members}" = "0") {
-			//			// empty:
-			//			Set(QUEUESTATUS=JOINEMPTY);
-			//			Verbose(1,### Sonderfall fuer Queue ${EXTEN} - keine Agenten\, behandeln wie ${QUEUESTATUS});
-			//		}
-			//		else {
-			//			// treat like full:
-			//			Set(QUEUESTATUS=FULL);
-			//			Verbose(1,### Sonderfall fuer Queue ${EXTEN} - alle besetzt\, behandeln wie ${QUEUESTATUS});
-			//		}
-			//	}
-			//}
-			// ENDE SONDERFALL HACK
-			
 			if ("${all_busy}" != "1") {
 				if ("${ring_instead_of_moh}" = "r") {
-					Progress();
+					Ringing();
 				}
 				else {
 					Set(ring_instead_of_moh=);
@@ -918,6 +1066,7 @@
 					Verbose(1,### Called queue: ${EXTEN}\, forward on timeout to: ${fw_${is_call_from}_timeout});
 					Set(__forwarded_by=${EXTEN});
 					Set(__is_from_gateway=);
+					Set(__redirect=${fw_${is_call_from}_timeout});
 					Dial(Local/${fw_${is_call_from}_timeout}/n,900);
 					&hangup-proper-status();
 				}
@@ -931,6 +1080,7 @@
 					Verbose(1,### Called queue: ${EXTEN}\, forward on full to: ${fw_${is_call_from}_full});
 					Set(__forwarded_by=${EXTEN});
 					Set(__is_from_gateway=);
+					Set(__redirect=${fw_${is_call_from}_full});
 					Dial(Local/${fw_${is_call_from}_full}/n,900);
 					&hangup-proper-status();
 				}
@@ -944,6 +1094,7 @@
 					Verbose(1,### Called queue: ${EXTEN}\, forward on empty to: ${fw_${is_call_from}_empty});
 					Set(__forwarded_by=${EXTEN});
 					Set(__is_from_gateway=);
+					Set(__redirect=${fw_${is_call_from}_empty});
 					Dial(Local/${fw_${is_call_from}_empty}/n,900);
 					&hangup-proper-status();
 				}
@@ -961,6 +1112,12 @@
 				Verbose(1,### We are a sub-system. Dial to the gateway.);
 				&dial-gateway(${EXTEN});
 			} else {
+				Verbose(1,### We are not a sub-system. Trying custom contexts.);
+				if ("${is_from_gateway}" = "1") {
+					Goto(from-gateways-custom,${EXTEN},1);
+				} else {
+					Goto(from-internal-users-custom,${EXTEN},1);
+				}
 				Verbose(1,### We are not a sub-system. Hang up.);
 			}
 			// 1 = AST_CAUSE_UNALLOCATED => SIP 404 Not Found
@@ -980,8 +1137,8 @@
 			}
 			else {
 				Set(vm_real_source=external);
-				&is_dmz(${CALLERID(num)});
-				if ("${is_dmz}" != "1") {
+				//&is_dmz(${CALLERID(num)});
+				if ("${is_from_gateway}" = "1") {
 					Set(vm_source=external);
 				}
 				else {
@@ -1002,9 +1159,14 @@
 					}
 				}
 			}
-			//We dont need the user_uncallable_vm_on any more.
-			//if ("${vm_${vm_source}_active}" != "1")
-			goto user_uncallable_vm_off;
+
+			if ( "${vm_${vm_source}_active}" != "1" && "${vm_${vm_source}_active}" != "2")
+				goto user_uncallable_vm_off;
+				
+			// busy on busy
+			if ("${vm_real_source}" = "external" && "${vm_external_active}" = "2" && "${DIALSTATUS}" = "BUSY") {
+				goto user_uncallable_vm_off;
+			}
 			
 		user_uncallable_vm_on:
 			Verbose(1,### Called user ${EXTEN} unreachable\, record voicemail from ${vm_source});
@@ -1067,8 +1229,22 @@
 	}
 	
 	h => {
+		
 		ResetCDR(w);
 		NoCDR();
+		if ("${is_huntgroup}" = "1" && "${DIALSTATUS}" = "ANSWER" && "${user_extension}" != "") {
+
+			Set(exttype=huntgroup);
+		}
+		// for normal users
+		if("${MEMBERINTERFACE}" != "" && "SIP/${CALLERID(ani)}" != "${MEMBERINTERFACE}" ) {
+			Set(exttype=queue);
+		}
+		// for gateway users
+		else if("${MEMBERINTERFACE}" != "" && "Local/${CALLERID(ani)}@to-gguser" != "${MEMBERINTERFACE}" ) {
+			Set(exttype=queue);
+		}
+
 		if ("${confnum}" != "") {
 			Verbose(1,### Participant "${CALLERID(all)}" has left conference ${confprefix}${confnum});
 			MeetMeCount(${confnum},cnt);
@@ -1083,7 +1259,9 @@
 		else
 		if ("${exttype}" = "user") {
 			// to internal user, store dial log (in|missed)
-			
+			if ("${DIALSTATUS}" = "")
+				Set(DIALSTATUS=ANSWER);
+			Verbose(1,DIALSTATUS: ${DIALSTATUS});
 			Set(type=missed);
 			if ("${DIALSTATUS}" = "ANSWER")
 				Set(type=in);
@@ -1096,13 +1274,83 @@
 			Verbose(1,###### CALLERID(num)  : ${CALLERID(num)});
 			Verbose(1,###### origext        : ${origext});
 			Verbose(1,###### user_name      : ${user_name});
+			Verbose(1,###### redirect      : ${redirect});
+			Verbose(1,###### DIALEDPEERNUMBER      : ${DIALEDPEERNUMBER});
 			*/
-			if ("${CALLERID(dnid)}" != "" && "${DIALEDPEERNUMBER:0:1}" != "*") {
+			if ("${DIALEDPEERNUMBER:0:1}" != "*") {
 				//&dial-log-store(${origext},${type},${user_name});
-				&dial-log-store(${CALLERID(dnid)},${type},${CALLERID(num)});
+				if ("${redirect}" != "" && "${CALLERID(dnid)}" == "" ) {
+					if( "${redirect}" == "${DIALEDPEERNUMBER:0:${LEN(${redirect})}}" && "${redirect}/n" != "${DIALEDPEERNUMBER}" && "${type}" == "in"  ) {
+						&dial-log-store(${redirect},${type},${CALLERID(num)});
+					}
+					else if( "${redirect}" == "${DIALEDPEERNUMBER:0:${LEN(${redirect})}}" && "${redirect}" != "${DIALEDPEERNUMBER}" && "${type}" == "missed"  ) {
+						&dial-log-store(${redirect},${type},${CALLERID(num)});
+					}
+				}
+				else if ("${redirect}" == "" ) {
+					&dial-log-store(${CALLERID(dnid)},${type},${CALLERID(num)});
+				}
 				//FIXME - does not always work as expected
 			}
 		}
+		else if ("${exttype}" = "huntgroup") {
+			if ("${DIALSTATUS}" != "ANSWER"){
+				Set(huntgroup=1);
+				while ("${huntgroup_${huntgroup}_dial}" != "") {
+					Verbose(1,### Writing missing call to DialLog: ${huntgroup_${huntgroup}_dial});
+					&dial-log-store(${huntgroup_${huntgroup}_dial},missed,${CALLERID(num)});
+					huntgroup=${huntgroup}+1;
+				}
+			}
+			else {
+				if("${user_extension}" != ""){
+					&dial-log-store(${user_extension},in,${CALLERID(num)});
+				}
+			}
+		}
+		else if ("${exttype}" = "queue") {
+			if("${MEMBERINTERFACE}" = ""){
+				Verbose(1,### Queue ${CALLERID(dnid)} Call ${CALLERID(num)} no Answer);
+				Set(member=1);
+				while ("${member_${member}}" != "") {
+					&queue-dial-log-store(${member_${member}},missed,${CALLERID(num)},${CALLERID(dnid)});
+					member=${member}+1;
+				}
+			}
+			else {
+				 Verbose(1,### Queue ${CALLERID(dnid)} ${MEMBERINTERFACE} Answered Call ${CALLERID(num)});
+				Set(member=1);
+				while ("${member_${member}}" != "") {
+					// for normal users
+					if("${MEMBERINTERFACE}" = "SIP/${member_${member}}") {
+						if("${DIALEDPEERNUMBER}" != "") {
+							//Set(log_user=${DIALEDPEERNUMBER});
+							Set(log_user=${mext});
+							
+							if( "${is_huntgroup}" = "1" ) {
+								Set(huntgroup=1);
+								while ("${huntgroup_${huntgroup}_dial}" != "") {
+									if( "${huntgroup_${huntgroup}_dial}@to-internal-users-huntgroup" = "${DIALEDPEERNUMBER}" ) {
+										Set(log_user=${huntgroup_${huntgroup}_dial});
+									}
+									huntgroup=${huntgroup}+1;
+								}
+							}
+							
+ 
+							&queue-dial-log-store(${log_user},in,${CALLERID(num)},${CALLERID(dnid)});
+						}
+						else {
+							&queue-dial-log-store(${member_${member}},in,${CALLERID(num)},${CALLERID(dnid)});
+						}
+					}
+					else if("${MEMBERINTERFACE}" = "Local/${member_${member}}@to-gguser" ) {
+						&queue-dial-log-store(${member_${member}},in,${CALLERID(num)},${CALLERID(dnid)});
+					}
+					member=${member}+1;
+				}
+			}
+		}
 	}
 	
 }
@@ -1169,8 +1417,41 @@
 		AGI(/opt/gemeinschaft/dialplan-scripts/get-clir-internal.agi,${user_id});
 	}
 	if ("${clir}" = "1") {
-		Set(CALLERID(all)=Anonymous <anonymous>);
-		// RFC 2543
+		SIPAddHeader(P-Preferred-Identity: <sip:${CALLERID(num)}\;user=phone>);
+		SIPAddHeader(Privacy: id);
+		Set(CALLERID(name)=Anonymous);
 	}
 }
 
+context to-gguser {
+	 _Z. => {
+
+		AGI(/opt/gemeinschaft/dialplan-scripts/in-user-get-ggrp.agi,${EXTEN});
+		if ("${via_gateway_group}" != "0") {
+			AGI(/opt/gemeinschaft/dialplan-scripts/gateway-route.agi,${via_gateway_group},${EXTEN});
+			Set(no_route=1);
+			Set(r=1);
+			while ("${r_${r}_dial}" != "") {
+				Verbose(1,### route: r_${r}_dial);
+				Set(no_route=);
+				Verbose(1,### Gateway route: ${r_${r}_dial});
+				Dial(${r_${r}_dial},${dialtimeout},o);
+				Verbose(1,### Dialstatus for ${r_${r}_dial}: ${DIALSTATUS});
+				if ("${DIALSTATUS}" = "ANSWER" || "${DIALSTATUS}" = "CANCEL") {
+					Hangup();
+				}
+
+				if (${r} > 10) {
+					Verbose(1,### Could not reach ${mnumber} via 10 different gateways);
+				}
+				r=${r}+1;
+			}
+			Verbose(1,### finished trying via gateways);
+		} else {
+			Busy();
+		}
+		
+
+	}
+}
+
Index: opt/gemeinschaft/etc/asterisk/e.ael
===================================================================
--- opt/gemeinschaft/etc/asterisk/e.ael	(revision 5977)
+++ opt/gemeinschaft/etc/asterisk/e.ael	(working copy)
@@ -34,7 +34,12 @@
 	#include "/opt/gemeinschaft/etc/asterisk/e-globals.ael"
 };
 
+//---------------------------------------------------------------------
+//  Custom dialplan additions
+//---------------------------------------------------------------------
 
+#include "/opt/gemeinschaft/etc/asterisk/custom/e.ael"
+
 //---------------------------------------------------------------------
 //  Macro to get or generate a "connection ID"
 //---------------------------------------------------------------------
@@ -212,8 +217,234 @@
 	_*0. => &cmm-login(${EXTEN:2});
 }
 
+//---------------------------------------------------------------------
+//  LDAP phonebook quick dial
+//---------------------------------------------------------------------
 
+context pb {
+	
+	_*1.  => {
+		AGI(/opt/gemeinschaft/dialplan-scripts/pb-imported-get.agi, ${EXTEN:2});
+		if ( "${LEN(${pb_ldap_number})}" = "0" ) {
+			Playback(beeperr);
+		} else {
+			Dial(Local/${pb_ldap_number}@from-internal-users);
+		}
+		Hangup();
+	}
+}
+
+
 //---------------------------------------------------------------------
+//  Agent Login Macro
+//---------------------------------------------------------------------
+
+macro agent-login-enterid(){
+	
+	Answer();
+	NoOp(### Agent without id tries to log in);
+	Wait(1);
+	Read(new_user_name,gemeinschaft/agent-enterid,10,s,3,5);
+	&agent-login(${new_user_name});
+
+}
+
+macro agent-login( new_user_name ) {
+
+	Answer();
+	NoOp(### Agent ${new_user_name} tries to log in on user: ret = ${user_name});
+	
+	Wait(1);
+	Read(pass,agent-pass);
+	AGI(/opt/gemeinschaft/dialplan-scripts/agent-login.agi,${new_user_name},${pass},${user_name});
+	if ("${ret}" = "error")
+		goto error;
+	if ("${ret}" != "ok")
+		goto unknown;
+	
+	//we will first have to log off the agent from the phone he is registered at, if there is any
+	if("${old_user}"  != "") {
+                AGI(/opt/gemeinschaft/dialplan-scripts/agent-login-logout.agi,${old_user},${new_user_name},logoutall);
+		for(i=0;${i} < ${oqueue_count}; i=${i} + 1){
+			queueNr=${oqueue${i}};
+			Set(count=${QUEUE_MEMBER_COUNT(${queueNr})});
+			System(echo  "${EPOCH}|${UNIQUEID}|${queueNr}|Local/${new_user_name}@agents|REMOVEMEMBER|SIP/${user_name}" >> /var/log/asterisk/queue_log );
+			UserEvent(AgentLogoffUI|agent: ${new_user_name});
+		}
+	}
+
+
+	if("${old_local_agent}" != ""){
+		AGI(/opt/gemeinschaft/dialplan-scripts/agent-login-logout.agi,${user_name},${old_local_agent},logoutall);
+		for(i=0;${i} < ${oqueue_count}; i=${i} + 1){
+			queueNr=${oqueue${i}};
+			Set(count=${QUEUE_MEMBER_COUNT(${queueNr})});
+			System(echo  "${EPOCH}|${UNIQUEID}|${queueNr}|Local/${old_local_agent}@agents|REMOVEMEMBER|SIP/${user_name}" >> /var/log/asterisk/queue_log );
+		}
+		UserEvent(AgentLogoffUI|agent: ${old_local_agent});
+	}
+
+	if( ${old_local_user} > 0 ) {
+		&queue-logout-all-silent();
+		 NoOp(### Bingo);
+		//user logoff
+	}
+
+
+	//Logoff the agent, if he is still registered on another phone
+
+
+	// Login the agent
+	// NoOp(### Anz. queues: ${queue_count});
+         AGI(/opt/gemeinschaft/dialplan-scripts/agent-login-logout.agi,${user_name},${new_user_name},login);
+	NoOp(### AGI returned: ${agent_login_status});
+	if( "${agent_login_status}" == "OK"){ 
+	
+		QueueLog(NONE,${UNIQUEID},${CHANNEL(channeltype)}/${user_name},AGENTLOGIN,fake);
+		UserEvent(AgentLoginUI|agent: ${new_user_name}|user: ${user_name});
+		for(i=0;${i} < ${queue_count}; i=${i} + 1){
+			queueNr=${queue${i}};
+			Set(count=${QUEUE_MEMBER_COUNT(${queueNr})});
+			System(echo "${EPOCH}|${UNIQUEID}|${queueNr}|Local/${new_user_name}@agents|ADDMEMBER|SIP/${user_name}" >> /var/log/asterisk/queue_log );
+		}
+		Playback(gemeinschaft/sie-sind-jetzt-angemeldet); 
+
+	}
+	else
+		goto error;
+	Hangup();
+	
+	unknown:
+		Wait(1);
+		Playback(vm-incorrect&vm-goodbye);
+		Wait(0.5);
+		Hangup();
+	
+	error:
+		Playback(tt-somethingwrong);
+		Wait(0.5);
+		Hangup();
+}
+
+macro agent-logout() {
+	
+	Answer();
+	Verbose(1,### Agent on ${user_name} wants to log out from all queues);
+	AGI(/opt/gemeinschaft/dialplan-scripts/agent-login-logout.agi,${user_name},,logoutall);
+	Wait(0.5);
+	if ("${agent_login_status}" = "loggedout") {
+		
+		UnpauseQueueMember(|SIP/${user_name});
+		
+		UserEvent(AgentLogoffUI|agent: ${agent});
+		AGI(/opt/gemeinschaft/dialplan-scripts/agent-login-logout.agi,${user_name},${old_local_agent},logoutall);
+		for(i=0;${i} < ${oqueue_count}; i=${i} + 1){
+			queueNr=${oqueue${i}};
+			Set(count=${QUEUE_MEMBER_COUNT(${queueNr})});
+			System(echo  "${EPOCH}|${UNIQUEID}|${queueNr}|Local/${agent}@agents|REMOVEMEMBER|SIP/${user_name}" >> /var/log/asterisk/queue_log );
+		}
+		Playback(agent-loggedoff);
+		
+	} else {
+		Playback(beeperr);
+	}
+	Hangup();
+	
+}
+
+macro agent-logout-silent() {
+	
+	Answer();
+	Verbose(1,### Agent on ${user_name} wants to log out from all queues);
+	AGI(/opt/gemeinschaft/dialplan-scripts/agent-login-logout.agi,${user_name},,logoutall);
+	if ("${agent_login_status}" = "loggedout") {
+		
+		UnpauseQueueMember(|SIP/${user_name});
+		
+		UserEvent(AgentLogoffUI|agent: ${agent});
+		AGI(/opt/gemeinschaft/dialplan-scripts/agent-login-logout.agi,${user_name},${old_local_agent},logoutall);
+		for(i=0;${i} < ${oqueue_count}; i=${i} + 1){
+			queueNr=${oqueue${i}};
+			Set(count=${QUEUE_MEMBER_COUNT(${queueNr})});
+			System(echo  "${EPOCH}|${UNIQUEID}|${queueNr}|Local/${agent}@agents|REMOVEMEMBER|SIP/${user_name}" >> /var/log/asterisk/queue_log );
+		}
+	}	
+	Hangup();
+	
+}
+
+macro agent-pause() {
+	
+	Answer();
+	Verbose(1,### Agent on ${user_name} wants to pause);
+	AGI(/opt/gemeinschaft/dialplan-scripts/agent-pause-unpause.agi,${user_name},pause);
+	
+	Wait(0.5);
+	Verbose(1,### Is Agent:${agent} );
+	Verbose(1,### DB-Stat:  ${agent_pause});
+	if ("${agent}" = "true") {
+		
+		PauseQueueMember(|SIP/${user_name});
+		UserEvent(AgentPausedUI|agent: ${user_name});
+		Playback(gemeinschaft/pause);
+
+	} else {
+		Playback(beeperr);
+	}
+	Hangup();
+	
+}
+
+macro agent-unpause() {
+	
+	Answer();
+	Verbose(1,### Agent on ${user_name} wants to unpause);
+	AGI(/opt/gemeinschaft/dialplan-scripts/agent-pause-unpause.agi,${user_name},unpause);
+	Wait(0.5);
+	
+	if ("${agent}" = "true") {
+		UnpauseQueueMember(|SIP/${user_name});
+		UserEvent(AgentUnPausedUI|agent: ${user_name});
+		Playback(gemeinschaft/unpause);
+		
+	} else {
+		Playback(beeperr);
+	}
+	Hangup();
+	
+}
+
+
+//---------------------------------------------------------------------
+//  Agent Login/Logout
+//---------------------------------------------------------------------
+
+context agents {
+
+        *6*  => &agent-logout();
+        *6  => &agent-login-enterid();
+	_*6. => {
+		&agent-login(${EXTEN:2});		
+	}
+	*6#* => &agent-pause();
+	*6## => &agent-unpause();
+}
+
+context donothing {
+
+	1 => {
+		Answer();
+		Wait(4);
+		Hangup();
+	}
+}
+
+context agent-silent {
+
+	silentlogout => &agent-logout-silent();
+}
+
+//---------------------------------------------------------------------
 //  Conferences (MeetMe)
 //---------------------------------------------------------------------
 
@@ -377,8 +608,10 @@
 	AGI(/opt/gemeinschaft/dialplan-scripts/queue-login-logout.agi,${user_name},${queue},login);
 	if ("${agent_login_status}" = "loggedin") {
 		// fake login for the statistics:
+		//AddQueueMember(${queue},${CHANNEL(channeltype)}/${user_name});
 		QueueLog(NONE,${UNIQUEID},${CHANNEL(channeltype)}/${user_name},AGENTLOGIN,fake);
 	}
+	Set(count=${QUEUE_MEMBER_COUNT(${queue})});
 	Verbose(1,### agent_login_status: ${agent_login_status});
 	Wait(0.5);
 	if ("${agent_login_status}" = "loggedin" || "${agent_login_status}" = "alreadyon") {
@@ -386,6 +619,10 @@
 	} else {
 		Playback(beeperr);
 	}
+	if ("${agent_login_status}" = "agent-exists") {
+		Wait(0.5);
+		Playback(gemeinschaft/agent-exists);
+	}
 	Hangup();
 	
 }
@@ -398,9 +635,14 @@
 	Wait(0.5);
 	if ("${agent_login_status}" = "loggedout") {
 		Playback(agent-loggedoff);
+		Set(count=${QUEUE_MEMBER_COUNT(${queue})});
 	} else {
 		Playback(beeperr);
 	}
+	if ("${agent_login_status}" = "agent-exists") {
+		Wait(0.5);
+		Playback(gemeinschaft/agent-exists);
+	}
 	Hangup();
 	
 }
@@ -416,6 +658,10 @@
 	} else {
 		Playback(beeperr);
 	}
+	if ("${agent_login_status}" = "agent-exists") {
+		Wait(0.5);
+		Playback(gemeinschaft/agent-exists);
+	}
 	Hangup();
 	
 }
@@ -429,6 +675,7 @@
 	
 	*5*   => &queue-logout-all();
 	_*5.  => &queue-login(${EXTEN:2});
+
 	//_*5.* => &queue-logout(${EXTEN:2});  // does not work
 	_*5X* => &queue-logout(${EXTEN:2:-1});
 	_*5XX* => &queue-logout(${EXTEN:2:-1});
@@ -497,6 +744,8 @@
 }
 
 
+
+
 //---------------------------------------------------------------------
 //  Macro to Record VM Box Announcements
 //---------------------------------------------------------------------
@@ -557,6 +806,7 @@
 context from-gateways {
 	
 	includes {
+		from-gateways-custom;
 		cmm;                  // user login/logout (for BOI)
 		//voicemail-any;        // voicemail main (own mailbox)
 		//to-internal-nobody;   // internal phones (nobodies)
@@ -583,6 +833,10 @@
 //---------------------------------------------------------------------
 
 context to-gateway {
+
+	includes {
+		to-gateway-custom;
+	}
 	
 	_0. => {
 		if ("${user_id}" != "") {
@@ -590,19 +844,19 @@
 			//DumpChan();
 			&dial-log-store(${user_name},out,${EXTEN});
 		}
+		AGI(/opt/gemeinschaft/dialplan-scripts/get_outbound_cid.agi,${user_name});
+                Verbose(1,### Caller-ID is ${CALLERID(num)});
 		&dial-gateway(${gateway_prefix}${EXTEN:1});
 	}
 	//_X. => &dial-gateway(${EXTEN});
 }
 
+// context for selecting a gateway group directly
+#exec "/opt/gemeinschaft/etc/asterisk/direct-gateway.ael.php"
+
+
+
 macro dial-gateway-do( mnumber ) {
-	/*
-	if ("${is_from_gateway}" = "1" || "${SIPCHANINFO(peername)}" = "gateway") {
-		Verbose(1,### Don't allow call from outside to go to the outside again - number: ${mnumber});
-		Congestion(3);
-		Hangup();
-	}
-	*/
 	// get CLIR for a call to external:
 	&is_dmz(${mnumber});
 	if ("${is_dmz}" != "1") {
@@ -616,8 +870,9 @@
 			AGI(/opt/gemeinschaft/dialplan-scripts/get-clir-${zone}.agi,${user_id});
 		}
 		if ("${clir}" = "1") {
-			Set(CALLERID(all)=Anonymous <anonymous>);
-			// RFC 2543
+			SIPAddHeader(P-Preferred-Identity: <sip:${CALLERID(num)}\;user=phone>);
+			SIPAddHeader(Privacy: id);
+			Set(CALLERID(name)=Anonymous);
 		}
 	}
 	
@@ -745,6 +1000,143 @@
 }
 
 
+macro direct-dial-gateway-do( mnumber , gwgrp ) {
+	// get CLIR for a call to external:
+
+	Set(zone=external);
+
+	if ("${user_id}" != "") {
+		AGI(/opt/gemeinschaft/dialplan-scripts/get-clir-${zone}.agi,${user_id});
+		if ("${clir}" = "1") {
+			SIPAddHeader(P-Preferred-Identity: <sip:${CALLERID(num)}\;user=phone>);
+			SIPAddHeader(Privacy: id);
+			Set(CALLERID(name)=Anonymous);
+		}
+	}
+	
+	AGI(/opt/gemeinschaft/dialplan-scripts/out-gwgrp-get.agi,${mnumber},${gwgrp},${CALLERID(num)});
+	Set(no_route=1);
+	Set(r=1);
+	while ("${r_${r}_dial}" != "") {
+		//Verbose(1,### route: r_${r});
+		Set(no_route=);
+		Set(CALLERID(num)=${r_${r}_cid});
+		Verbose(1,### Outbound route: ${r_${r}_dial} - Caller ID: ${CALLERID(num)});
+		Dial(${r_${r}_dial},180);
+		Verbose(1,### Dialstatus for ${r_${r}_dial}: ${DIALSTATUS});
+		if ("${DIALSTATUS}" = "ANSWER" || "${DIALSTATUS}" = "CANCEL") {
+			Hangup();
+		}
+		else if ("${DIALSTATUS}" = "NOANSWER") {
+			Hangup();
+		}
+		else if ("${DIALSTATUS}" = "BUSY") {
+			Busy(5);
+			Hangup();
+		}
+		else if ("${DIALSTATUS}" = "CHANUNAVAIL" || "${DIALSTATUS}" = "CONGESTION") {
+			//Verbose(1,### DIALEDTIME  : ${DIALEDTIME});
+			//Verbose(1,### ANSWEREDTIME: ${ANSWEREDTIME});
+			Verbose(1,### HANGUPCAUSE : ${HANGUPCAUSE});
+			// see Asterisk's causes.h or
+			// Q.931 Disconnect Cause Codes
+			if ("${HANGUPCAUSE}" = "66") {
+				// 66 = channel not implemented
+				Verbose(0,### You're trying to dial to channel type "${CUT(r_${r}_dial,/,1)}" which this Asterisk is not configured to handle!);
+			}
+			else if ("${HANGUPCAUSE}" = "17") {
+				// 17 = user busy
+				Verbose(1,### HANGUPCAUSE 17 = user busy);
+				Busy(5);
+				Hangup();
+			}
+			else if ("${HANGUPCAUSE}" = "18") {
+				// 18 = no user responding
+				Verbose(1,### HANGUPCAUSE 18 = no user responding);
+				Congestion(5);
+				Hangup();
+			}
+			
+			// else don't hangup and try the next gateway
+		}
+		else {
+			Congestion(5);
+			Hangup();
+		}
+		
+		if (${r} > 10) {
+			Verbose(1,### Could not reach ${mnumber} via 10 different gateways);
+			Congestion(5);
+			Hangup();
+		}
+		r=${r}+1;
+	}
+	if ("${no_route}" != "") {
+		Verbose(1,### We don't have a route for ${mnumber});
+		Set(DIALSTATUS=CONGESTION);
+		Congestion(5);
+		Hangup();
+	}
+	else {
+		// we have run out of gateways to try
+		Congestion(5);
+		Hangup();
+	}
+	Hangup();
+}
+
+macro direct-dial-gateway( mnumber, gwgrp ) {
+	
+	// is the user allowed to dial that number?
+	// always allow for private calls:
+	if ("${is_private_call}" = "1")
+		goto allowed;
+	// else check:
+	
+	if ("${forwarded_by}" = "") {
+		Set(__is_forwarded=0);
+		Set(__forwarded_by=${user_name});
+	}
+	else {
+		Set(__is_forwarded=1);
+		Verbose(1,### forwarded_by: ${forwarded_by});
+	}
+	// AGI ...      dial_allowed = yes | no | pin,  dial_pin = <pin>
+	AGI(/opt/gemeinschaft/dialplan-scripts/callblocking.agi,${forwarded_by},${mnumber});
+	if ("${dial_allowed}" = "pin") {
+		Verbose(1,### User ${user_name} needs PIN (${dial_pin}) to dial ${mnumber} via gateway);
+		if ("${is_forwarded}" = "1") {
+			Verbose(1,### Don't ask for PIN after forward. Hangup.);
+			goto not_allowed;
+		}
+		Answer();
+		Wait(1);
+		Read(input,vm-password,10,s,3,5);
+		if ("${input}" = "${dial_pin}") {
+			Playback(beep);
+			goto allowed;
+		}
+		goto not_allowed;
+	}
+	if ("${dial_allowed}" != "no")
+		goto allowed;
+	goto not_allowed;
+	
+	not_allowed:
+		Verbose(1,### User ${forwarded_by} is not allowed to dial ${mnumber} via gateway);
+		// beeperr if channel is up, else just declined:
+		if ("${CHANNEL(state)}" = "Up")
+			Playback(beeperr);
+		Hangup();
+	
+	allowed:
+		Verbose(1,### User ${forwarded_by} is allowed to dial ${mnumber} via gateway);
+		//&dial-gateway-do(${gateway_prefix}${mnumber});
+		&direct-dial-gateway-do(${mnumber},${gwgrp});
+		Hangup();
+}
+
+
 //---------------------------------------------------------------------
 //  To Emergency Numbers
 //---------------------------------------------------------------------
@@ -816,6 +1208,7 @@
 context from-internal-nobody {
 	
 	includes {
+		from-internal-nobody-custom;
 		//ivrs;                 //FIXME IVR demo
 		to-emergency;         // emergency numbers
 		cmm;                  // user login/logout
@@ -837,20 +1230,24 @@
 context from-internal-users {
 	
 	includes {
+		from-internal-users-custom;
 		//ivrs;                 //FIXME IVR demo
 		to-emergency;         // emergency numbers
 		cmm;                  // user login/logout
+		pb;                   // LDAP phonebook quickdial
 		vm-ann-rec;           // record vm-box announcements
 		voicemail-self;       // voicemail main (own mailbox)
 		voicemail-any;        // voicemail main (any mailbox)
 		private-call;         // private calls
 		user-config;          // user's configuration
 		queues-login-logout;  // queue login/logout
+		to-gwg-direct;		//directly select a gatewaygroup
 		to-conferences;       // conferences
 		to-internal-nobody;   // internal phones (nobodies)
 		to-internal-users;    // internal phones (users)
 		to-gateway;           // to the gateway
 		test;                 // test extensions
+		agents;
 	}
 	
 	_*31. => {
@@ -892,6 +1289,7 @@
 
 context from-node {
 	includes {
+		from-node-custom;
 		to-conferences-self;       // conferences
 		to-internal-nobody-self;   // internal phones (nobodies)
 		voicemail-any-self;        // vm boxes
@@ -917,7 +1315,24 @@
 	}
 }
 
+//---------------------------------------------------------------------
+//  Macro to store queue dial log
+//---------------------------------------------------------------------
 
+macro queue-dial-log-store( muser, mtype, mnumber, queue ) {
+	
+	if ("${mtype}"="in" || "${mtype}"="out" || "${mtype}"="missed") {
+		if ("${mnumber}" = "") {
+			if ("${mtype}"="in" || "${mtype}"="missed") {
+				Set(mnumber=${CALLERID(num)});
+			}
+		}
+		Verbose(1,### Store in queue dial log of user ${muser}: ${mtype} ${mnumber});
+		TrySystem(/opt/gemeinschaft/dialplan-scripts/queue-dial-log-store '${muser}' '${mtype}' '${mnumber}' '${queue}');
+	}
+}
+
+
 //---------------------------------------------------------------------
 //  HA-System Alarm
 //---------------------------------------------------------------------
@@ -1038,7 +1453,15 @@
 	}
 }
 
+//---------------------------------------------------------------------
+//  Spy a Channel
+//---------------------------------------------------------------------
 
+context spyme {
+	asterisk-. => {
+		ChanSpy(${EXTEN});
+	}
+}
 
 //---------------------------------------------------------------------
 //  Default Context (do not use here. it's in extensions.conf)
Index: opt/gemeinschaft/etc/asterisk/queues.conf
===================================================================
--- opt/gemeinschaft/etc/asterisk/queues.conf	(revision 5977)
+++ opt/gemeinschaft/etc/asterisk/queues.conf	(working copy)
@@ -133,7 +133,7 @@
 ; of the queue member that was chosen and is now connected to be bridged with
 ; the caller
 ;
-;setinterfacevar=no
+setinterfacevar=yes
 ;
 ; How often to announce queue position and/or estimated 
 ; holdtime to caller (0=off)
Index: opt/gemeinschaft/sbin/gs-cc-worker
===================================================================
--- opt/gemeinschaft/sbin/gs-cc-worker	(revision 5977)
+++ opt/gemeinschaft/sbin/gs-cc-worker	(working copy)
@@ -118,12 +118,13 @@
 	#
 	$rs_ccw = @ $DB->execute(
 'SELECT
-	`c`.`from_ext`, `c`.`from_host_id`, `c`.`from_user_id`, `sf`.`callerid` `from_cid`,
-	`c`.`to_ext`, `c`.`to_host_id`, `c`.`to_user_id`, `st`.`callerid` `to_cid`
+	`c`.`to_user_id`, `c`.`from_ext`, `c`.`from_host_id`, `c`.`from_user_id`, `sf`.`callerid` `from_cid`,
+	`c`.`to_ext`, `c`.`to_host_id`, `st`.`callerid` `to_cid`
 FROM
 	`call_completion_waiting` `c`
 	LEFT JOIN `ast_sipfriends` `sf` ON (`sf`.`_user_id`=`c`.`from_user_id`)
-	LEFT JOIN `ast_sipfriends` `st` ON (`st`.`_user_id`=`c`.`to_user_id`)'
+	LEFT JOIN `ast_sipfriends` `st` ON (`st`.`_user_id`=`c`.`to_user_id`)
+GROUP BY `c`.`to_user_id`'
 	);
 	if (! $rs_ccw) {
 		gs_log(GS_LOG_FATAL, 'Could not get waiting call completions!');
@@ -136,6 +137,10 @@
 		
 		gs_log(GS_LOG_DEBUG, 'Checking CC '. $cc['from_ext'] .' to '. $cc['to_ext'] .' ...', 'cc.log');
 		
+		$dnd = $DB->executeGetOne( 'SELECT `dnd` FROM `users` WHERE `id`='. (int)$cc['to_user_id'] );
+		if($dnd > 0)
+			 continue;
+
 		if ( ! isSet( $hosts[$cc['from_host_id']] )
 		  || ! isSet( $hosts[$cc[  'to_host_id']] ) ) continue;
 		
