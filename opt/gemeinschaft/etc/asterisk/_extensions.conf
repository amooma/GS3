[general]

static=yes
;
; if static=yes and writeprotect=no, you can save dialplan by
; CLI command 'save dialplan' too
;
;writeprotect=no
writeprotect=yes
autofallthrough=yes
clearglobalvars=no
priorityjumping=no

[globals]

;CONSOLE=Console/dsp				; Console interface for demo
;IAXINFO=guest					; IAXtel username/password
;TRUNK=Zap/g2					; Trunk interface
;TRUNKMSD=1					; MSD digits to strip (usually 1 or 0)
;TRUNK=IAX2/user:pass@provider


; gateway for everything except out internal phones:
;
gateway_host=192.168.1.109   ; host
gateway_prefix=0             ; if 0... was dialed internally to get
                             ; an outside line, what should the prefix
                             ; be to the gateway?

; max. forwards from user to user to prevent infinite loops:
;
max_forwards=10

; special emergency numbers:
:
emergency_police=110
emergency_fire=112


;----------------------------------------------------------------------
;   User Login Macro
;----------------------------------------------------------------------

[macro-cmm-login]

;  ${ARG1}  Neuer Username (= Extension des Users)
exten => s,1,Set(new_user_name=${ARG1})
exten => s,n,Answer()
exten => s,n,Wait(1)
exten => s,n,AGI(/opt/ast/dialplan-scripts/cmm-check-user.agi|${new_user_name})
exten => s,n,Verbose(1,### AGI returned: ret = ${ret})
exten => s,n,GotoIf($["${ret}" != "1"]?unknown,1)
exten => s,n,Read(pass,agent-pass,10,skip,3,5)
exten => s,n,AGI(/opt/ast/dialplan-scripts/cmm-login.agi|${new_user_name}|${pass}|${user_id})
exten => s,n,Verbose(1,### AGI returned: ret = ${ret})
exten => s,n,GotoIf($["${ret}" = "error"]?error,1)
exten => s,n,GotoIf($["${ret}" != "ok"]?unknown,1)

exten => s,n,Playback(agent-loginok)
exten => s,n,TrySystem(asterisk -rx \'sip notify snom-reboot ${new_user_name}\')
exten => s,n,TrySystem(asterisk -rx \'sip notify snom-reboot ${user_name}\')
exten => s,n,TrySystem(asterisk -rx \'sip prune realtime ${new_user_name}\')
exten => s,n,TrySystem(asterisk -rx \'sip prune realtime ${user_name}\')
exten => s,n,Hangup()

exten => unknown,1,Playback(vm-incorrect)
exten => unknown,n,Playback(vm-goodbye)
exten => unknown,n,Wait(1)
exten => unknown,n,Hangup()

exten => error,1,Playback(tt-somethingwrong)
exten => error,n,Wait(1)
exten => error,n,Hangup()


;----------------------------------------------------------------------
;   User Logout Macro
;----------------------------------------------------------------------

[macro-cmm-logout]

exten => s,1,Answer()
exten => s,n,Wait(1)
exten => s,n,AGI(/opt/ast/dialplan-scripts/cmm-logout.agi|${user_id})
exten => s,n,Playback(agent-loggedoff)
exten => s,n,Playback(vm-goodbye)
exten => s,n,Wait(1)
exten => s,n,TrySystem(asterisk -rx \'sip notify snom-reboot ${user_name}\')
exten => s,n,TrySystem(asterisk -rx \'sip prune realtime ${user_name}\')
exten => s,n,Hangup()


;----------------------------------------------------------------------
;   User Login/Logout Context
;----------------------------------------------------------------------

[cmm-login]

; login:
exten => _*0.,1,Macro(cmm-login,${EXTEN:2})
; logout:
exten => *0*,1,Macro(cmm-logout)


;----------------------------------------------------------------------
;   Voicemailbox
;----------------------------------------------------------------------

[voicemail-self]        ; Voicemail abfragen mit eigener Mailbox

;exten => mailbox,1,VoiceMailMain(${CALLERID(num)},s)
exten => mailbox,1,Set(language=de)
exten => mailbox,n,VoiceMailMain(${user_name},s)
exten => asterisk,1,Goto(mailbox,1)
exten => voicemail,1,Goto(mailbox,1)
exten => 80,1,Goto(mailbox,1)

[voicemail-any]         ; Voicemail abfragen mit beliebieger Mailbox

exten => 81,1,Set(language=de)
exten => 81,n,VoiceMailMain()


;----------------------------------------------------------------------
;   Record VM box announcements
;----------------------------------------------------------------------

[macro-vm-record]

;  ${ARG1}  internal|external
exten => s,1,Set(source=${ARG1})
exten => s,n,GotoIf($["${source}" = "internal"]?rec)
exten => s,n,GotoIf($["${source}" = "external"]?rec)
exten => s,n,Hangup()
exten => s,n(rec),Answer()
exten => s,n,Wait(1)
exten => s,n,Playback(vm-extension)
exten => s,n,SayDigits(${user_name})
exten => s,n,Playback(vm-rec-unv)
exten => s,n,Record(/opt/ast/vm-rec/${user_name}-${source}.alaw,5,200)
exten => s,n,Playback(vm-msgsaved)
exten => s,n,Playback(/opt/ast/vm-rec/${user_name}-${source})
exten => s,n,Wait(1)
exten => s,n,Hangup()


;----------------------------------------------------------------------
;   to internal phones
;----------------------------------------------------------------------

[to-internal-nobody]

exten => _9XXXX,1,Dial(SIP/${EXTEN},30,tT)
exten => _9XXXX,n,Hangup()


[to-internal-users]

#include "extensions-internal.conf"


;----------------------------------------------------------------------
;   from internal phones
;----------------------------------------------------------------------

[from-internal-nobody]

include => to-emergency
include => to-internal-users   ; internal phones (users)
include => to-internal-nobody  ; internal phones (nobodies)
include => voicemail-any       ; voicemail main (own mailbox)


[from-internal-users]

include => to-emergency
include => to-internal-users   ; internal phones (users)
include => to-internal-nobody  ; internal phones (nobodies)
include => cmm-login           ; user login/logout
include => voicemail-self      ; voicemail main (own mailbox)
include => voicemail-any       ; voicemail main (any mailbox)
include => vm-ann-rec          ; record vm-box announcements
include => to-gateway          ; to the gateway


;----------------------------------------------------------------------
;   record vm-box announcements
;----------------------------------------------------------------------

[vm-ann-rec]

exten => *99*,1,Macro(vm-record,internal)
exten => *99*,n,Hangup()

exten => *98*,1,Macro(vm-record,external)
exten => *98*,n,Hangup()


;----------------------------------------------------------------------
;  from the gateway
;----------------------------------------------------------------------

[from-gateway]

exten => s,1,Verbose(1,### Incoming call from the gateway. CallerID: ${CALLERID(all)})

include => to-internal-users   ; internal phones (users)
include => to-internal-nobody  ; internal phones (nobodies)
include => voicemail-any       ; voicemail main (own mailbox)


;----------------------------------------------------------------------
;  to the gateway
;----------------------------------------------------------------------

[to-gateway]

exten => _0.,1,Macro(dial-gateway,${gateway_prefix}${EXTEN:1})


[macro-dial-gateway]

;  ${ARG1}  Phone number

exten => s,1,Verbose(1,### Outgoing call via the gateway. CallerID: ${CALLERID(all)})
exten => s,n,SIPAddHeader(X-ast-clir: ${clir})
exten => s,n,SIPAddHeader(X-ast-origext: ${origext})
exten => s,n,SIPAddHeader(X-ast-forwards: ${forwards})
exten => s,n,SIPAddHeader(X-ast-user_name: ${user_name})
exten => s,n,SIPAddHeader(X-ast-user_id: ${user_id})
; dial with max. call duration 1 day
exten => s,n,Dial(SIP/${ARG1}@${gateway_host},300,TL(86400000:1800000:300000)i)
exten => s,n,Hangup()


;----------------------------------------------------------------------
;  to emergency numbers
;----------------------------------------------------------------------

[to-emergency]

exten => 110,1,Macro(dial-gateway,${emergency_police})
exten => 112,1,Macro(dial-gateway,${emergency_fire})
exten => 911,1,Macro(dial-gateway,${emergency_police})
exten => 999,1,Macro(dial-gateway,${emergency_police})
exten => 767,1,Macro(dial-gateway,${emergency_police})


;----------------------------------------------------------------------
;   Default Context
;----------------------------------------------------------------------

[default]




exten => 22,1,Answer()
exten => 22,n,Queue(support)
exten => 22,n,Hangup()
















;----------------------------------------------------------------------
;   ab hier nur noch alter Test-Kram
;----------------------------------------------------------------------



[macro-stdexten]
;   ${ARG1} - Extension  (we could have used ${MACRO_EXTEN} here as well
;   ${ARG2} - Device(s) to ring
;exten => s,1,SIPAddHeader(Alert-Info: <http://www.ignored.com>\;info=alert-internal\;x-line-id=0)
exten => s,1,Ringing()
exten => s,n,Set(DIALDEVICE=${ARG2})

; Tandem?
exten => s,n,Verbose(1,------------  incoming call to ext. ${ARG1})
;exten => s,n,AGI(incoming.php,${ARG1})   ; setzt DIALDEVICE
;exten => s,n,GotoIf($["${ISATEXTENSION}"="INVALID"]?invalid,1)

exten => s,n,Dial(${DIALDEVICE},20)			; Ring the interface, 20 seconds maximum
exten => s,n,Verbose(1,DIALSTATUS: ${DIALSTATUS}, HANGUPCAUSE: ${HANGUPCAUSE}, CAUSECODE: ${CAUSECODE})
exten => s,n,Goto(s-${DIALSTATUS},1)		; Jump based on status (NOANSWER,BUSY,CHANUNAVAIL,CONGESTION,ANSWER)

exten => s-NOANSWER,1,VoiceMail(${ARG1},u)	; If unavailable, send to voicemail w/ unavail announce
exten => s-NOANSWER,n,Hangup()

exten => s-BUSY,1,VoiceMail(${ARG1},b)		; If busy, send to voicemail w/ busy announce
exten => s-BUSY,n,Hangup()

exten => s-ANSWER,1,Hangup()

exten => _s-.,1,Goto(s-NOANSWER,1)		; Treat anything else as no answer

;exten => a,1,GotoIf($["${CHANNEL}"="SIP/${EXTEN}"]:local:other)
;exten => a,2(local),VoiceMailMain(${ARG1})		; If they press *, send the user into VoicemailMain
;exten => a,3(other),Hangup()



[macro-virtual]
;   ${ARG1} - Extension  (we could have used ${MACRO_EXTEN} here as well
exten => s,1,Ringing()
exten => s,n,AGI(virtual.php,${ARG1})    ; in /var/lib/asterisk/agi-bin/
exten => s,n,Verbose(1,------------  virtual ext. ${ARG1} is at ext: ${ISATEXTENSION})
exten => s,n,GotoIf($["${ISATEXTENSION}"="INVALID"]?invalid,1)
exten => s,n,GotoIf($["${ISATEXTENSION}"="UNAVAIL"]?s-NOANSWER,1)

;exten => s,n,Dial(SIP/${ISATEXTENSION},20)
exten => s,n,Dial(SIP/${ARG1},20)
exten => s,n,Goto(s-${DIALSTATUS},1)		; Jump based on status (NOANSWER,BUSY,CHANUNAVAIL,CONGESTION,ANSWER)

exten => invalid,1,Playback(invalid)
exten => invalid,n,Hangup()

exten => s-NOANSWER,1,VoiceMail(${ARG1},u)	; If unavailable, send to voicemail w/ unavail announce
exten => s-NOANSWER,n,Hangup()

exten => s-BUSY,1,VoiceMail(${ARG1},b)		; If busy, send to voicemail w/ busy announce
exten => s-BUSY,n,Hangup()

exten => s-ANSWER,1,Hangup()

exten => _s-.,1,Goto(s-NOANSWER,1)		; Treat anything else as no answer




; normale Extensions:
;
;exten => 2001,hint,SIP/2001
;exten => 2001,1,Macro(stdexten,${EXTEN},SIP/2001)
;
;exten => 2002,hint,SIP/2002
;exten => 2002,1,Macro(stdexten,${EXTEN},SIP/2002)
;
;exten => 3001,hint,SIP/3001
;exten => 3001,1,Macro(stdexten,${EXTEN},SIP/3001)
;
;exten => 3002,hint,SIP/3002
;exten => 3002,1,Macro(stdexten,${EXTEN},SIP/3002)
;
;
;
;exten => _nobodyXXX,1,Dial(SIP/${EXTEN})
;exten => 200,1,Dial(SIP/nobody002)
;
;
;
;; Voicemailbox:
;exten => mailbox,1,VoiceMailMain(${CALLERID(num)},s)
;exten => asterisk,1,Goto(mailbox,1)
;exten => voicemail,1,Goto(mailbox,1)
;exten => 8500,1,VoiceMailMain()
;
;; virtuelle Tandem-Nummern:
;exten => _4XXX,1,Macro(virtual,${EXTEN})
;
;; Tandem Login/Logout:
;exten => _*4XXX,1,Macro(tandem-login,${EXTEN:1:4})
;exten => _*4XXX*,1,Macro(tandem-logout,${EXTEN:1:4})
;
;
;
;; Test:
;
exten => 123,1,Answer()
exten => 123,2,Ringing()
exten => 123,3,Wait(2)
exten => 123,4,Playback(tt-monkeys)
exten => 123,5,Hangup()
;
;exten => 600,1,Playback(demo-echotest)	; Let them know what's going on
;exten => 600,n,Echo			; Do the echo test
;exten => 600,n,Playback(demo-echodone)	; Let them know it's over
;exten => 600,n,Goto(1)			; Start over
;
;exten => 124,1,Answer()
;exten => 124,n,Wait(2)
;exten => 124,n,SendText(hallo welt)
;exten => 124,n,Hangup()
;
;
;
;exten => #,1,Hangup()
;exten => i,1,Playback(invalid)
;exten => i,n,Hangup()
;
