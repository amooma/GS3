-- ------------------------------------------------------------------
-- CHANGES TO THE DATABASE
-- $Revision$
-- ------------------------------------------------------------------


--
-- since rev. 3968
--

USE `asterisk`;


--
-- Create new table `boi_perms`:
--

CREATE TABLE IF NOT EXISTS `boi_perms` (
  `user_id` int(10) unsigned NOT NULL,
  `host_id` mediumint(8) unsigned NOT NULL,
  `roles` varchar(8) character set ascii NOT NULL,
  PRIMARY KEY  (`user_id`,`host_id`),
  UNIQUE KEY `host_user` (`host_id`,`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;


--
-- Modify `host` column in table `hosts`:
--

ALTER TABLE `hosts`
  CHANGE `host` `host` VARCHAR(15) CHARACTER SET ascii COLLATE ascii_general_ci NOT NULL;


--
-- Add new column `is_foreign` in table `hosts`:
--

ALTER TABLE `hosts` ADD
  `is_foreign` TINYINT(1) UNSIGNED NOT NULL default '0' AFTER `comment`;
ALTER TABLE `hosts` ADD
  INDEX `is_foreign_id` (`is_foreign`,`id`);
ALTER TABLE `hosts` ADD
  INDEX `is_foreign_host` (`is_foreign`,`host`);


--
-- Add index for column `comment` in table `hosts`:
--

ALTER TABLE `hosts` ADD
  INDEX `comment` (`comment`(20));
ALTER TABLE `hosts` ADD
  INDEX `foreign_comment` (`is_foreign`,`comment`(20));


--
-- Add new column `group_id` in table `hosts`:
--

ALTER TABLE `hosts` ADD
  `group_id` MEDIUMINT(8) UNSIGNED NOT NULL default '0' AFTER `is_foreign`;
ALTER TABLE `hosts` ADD
  INDEX `group_id` (`group_id`);


--
-- Create new table `softkey_profiles`:
--

CREATE TABLE IF NOT EXISTS `softkey_profiles` (
  `id` int(10) unsigned NOT NULL auto_increment,
  `is_user_profile` tinyint(1) unsigned NOT NULL default '0',
  `title` varchar(50) character set utf8 collate utf8_unicode_ci NOT NULL,
  PRIMARY KEY  (`id`),
  KEY `title` (`title`(45)),
  KEY `is_user_profile_title` (`is_user_profile`,`title`(45))
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;


--
-- Create new table `softkeys`:
--

-- Old structure was:
-- CREATE TABLE IF NOT EXISTS `softkeys` (
--   `user_id` int(10) unsigned NOT NULL default '0',
--   `phone` varchar(20) NOT NULL default '',
--   `key` varchar(10) NOT NULL default '',
--   `number` varchar(30) NOT NULL default '',
--   PRIMARY KEY  (`user_id`,`phone`,`key`)
-- ) ENGINE=InnoDB DEFAULT CHARSET=ascii;

DROP TABLE IF EXISTS `softkeys`;
CREATE TABLE IF NOT EXISTS `softkeys` (
  `profile_id` int(10) unsigned NOT NULL default '0',
  `phone_type` varchar(20) NOT NULL,
  `key` varchar(10) NOT NULL,
  `function` varchar(15) NOT NULL,
  `data` varchar(100) NOT NULL,
  `label` varchar(40) character set utf8 collate utf8_unicode_ci NOT NULL,
  `user_writeable` tinyint(1) unsigned NOT NULL default '0',
  PRIMARY KEY  (`profile_id`,`phone_type`,`key`),
  KEY `phone_type_key` (`phone_type`,`key`),
  KEY `phone_type_function` (`phone_type`,`function`)
) ENGINE=InnoDB DEFAULT CHARSET=ascii;


--
-- Add new column `softkey_profile_id` in table `users`:
--

ALTER TABLE `users` ADD
  `softkey_profile_id` INT(10) UNSIGNED default NULL AFTER `user_comment`;
ALTER TABLE `users` ADD
  INDEX `softkey_profile_id` (`softkey_profile_id`);


--
-- Create new table `user_groups`:
--

CREATE TABLE IF NOT EXISTS `user_groups` (
  `id` mediumint(8) unsigned NOT NULL auto_increment,
  `lft` mediumint(8) unsigned NOT NULL,
  `rgt` mediumint(8) unsigned NOT NULL,
  `name` varchar(20) character set ascii NOT NULL,
  `title` varchar(50) collate utf8_unicode_ci NOT NULL,
  `softkey_profile_id` int(10) unsigned default NULL,
  PRIMARY KEY  (`id`),
  UNIQUE KEY `name` (`name`),
  UNIQUE KEY `lft` (`lft`),
  UNIQUE KEY `rgt` (`rgt`),
  KEY `softkey_profile_id` (`softkey_profile_id`),
  KEY `title` (`title`(40)),
  KEY `lft_rgt` (`lft`,`rgt`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;

INSERT INTO `user_groups` VALUES (1,1,2,'root-node','Root node',NULL,NULL);


--
-- Add new column `group_id` in table `users`:
--

ALTER TABLE `users` ADD
  `group_id` MEDIUMINT(8) UNSIGNED default NULL AFTER `user_comment`;
ALTER TABLE `users` ADD
  INDEX `group_id` (`group_id`);


--
-- Change index `mac_addr` in table `phones` to a unique index:
--

ALTER TABLE `phones`
  DROP INDEX `mac_addr`, ADD UNIQUE `mac_addr` (`mac_addr`);


--
-- Create new table `host_params`:
--

CREATE TABLE IF NOT EXISTS `host_params` (
  `host_id` mediumint(8) unsigned NOT NULL,
  `param` varchar(25) character set ascii NOT NULL,
  `value` varchar(100) collate utf8_unicode_ci NOT NULL,
  PRIMARY KEY  (`host_id`,`param`),
  KEY `param_value` (`param`,`value`(20))
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;

INSERT INTO `host_params` (`host_id`, `param`, `value`)
  (SELECT `id`, 'api', 'm01' FROM `hosts` WHERE `is_foreign`=1);


--
-- Create new table `prov_param_profiles`:
--

CREATE TABLE IF NOT EXISTS `prov_param_profiles` (
  `id` int(10) unsigned NOT NULL auto_increment,
  `is_group_profile` tinyint(1) unsigned NOT NULL default '1',
  `title` varchar(50) collate utf8_unicode_ci NOT NULL,
  PRIMARY KEY  (`id`),
  KEY `is_group_profile_title` (`is_group_profile`,`title`(45)),
  KEY `title` (`title`(45))
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;


--
-- Create new table `prov_params`:
--

CREATE TABLE IF NOT EXISTS `prov_params` (
  `profile_id` int(10) unsigned NOT NULL,
  `phone_type` varchar(20) character set ascii NOT NULL,
  `param` varchar(50) character set ascii NOT NULL,
  `index` smallint(5) NOT NULL default '-1',
  `value` varchar(100) collate utf8_unicode_ci NOT NULL,
  PRIMARY KEY  (`profile_id`,`phone_type`,`param`,`index`),
  KEY `phone_type_param_index` (`phone_type`,`param`,`index`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;


--
-- Add new column `prov_param_profile_id` in table `user_groups`:
--

ALTER TABLE `user_groups` ADD
  `prov_param_profile_id` INT UNSIGNED NULL AFTER `softkey_profile_id`;
ALTER TABLE `user_groups` ADD
  INDEX `prov_param_profile_id` (`prov_param_profile_id`);


--
-- Create new view `ast_sipfriends_gs`:
--

/*!50001 DROP TABLE IF EXISTS `ast_sipfriends_gs`*/;
/*!50001 DROP VIEW IF EXISTS `ast_sipfriends_gs`*/;
/*!50001 CREATE ALGORITHM=MERGE */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `ast_sipfriends_gs` AS (
  SELECT
    `s`.`_user_id`, `s`.`name`, `s`.`secret`, `s`.`type`, `s`.`host`,
    `s`.`defaultip`, `s`.`context`, `s`.`callerid`, `s`.`mailbox`,
    `s`.`callgroup`, `s`.`pickupgroup`, `s`.`setvar`, `s`.`call-limit`,
    `s`.`subscribecontext`, `s`.`regcontext`, `s`.`ipaddr`, `s`.`port`,
    `s`.`regseconds`, `s`.`username`, `s`.`regserver`, `s`.`fullcontact`
  FROM
    `ast_sipfriends` `s` JOIN
    `users` `u` ON (`u`.`id` = `s`.`_user_id`) JOIN
    `hosts` `h` ON (`h`.`id` = `u`.`host_id`)
  WHERE `h`.`is_foreign`=0
) */
/*!50002 WITH CASCADED CHECK OPTION */;


--
-- Add foreign key constraints (optional):
--

ALTER TABLE `ast_queue_members`
  ADD CONSTRAINT `ast_queue_members_ibfk_1`
  FOREIGN KEY (`_queue_id`) REFERENCES `ast_queues` (`_id`);
ALTER TABLE `ast_queue_members`
  ADD CONSTRAINT `ast_queue_members_ibfk_2`
  FOREIGN KEY (`_user_id`) REFERENCES `users` (`id`);

ALTER TABLE `ast_queues`
  ADD CONSTRAINT `ast_queues_ibfk_1`
  FOREIGN KEY (`_host_id`) REFERENCES `hosts` (`id`);

ALTER TABLE `ast_sipfriends`
  ADD CONSTRAINT `ast_sipfriends_ibfk_1`
  FOREIGN KEY (`_user_id`) REFERENCES `users` (`id`);

ALTER TABLE `ast_voicemail`
  ADD CONSTRAINT `ast_voicemail_ibfk_1`
  FOREIGN KEY (`_user_id`) REFERENCES `users` (`id`);

ALTER TABLE `boi_perms`
  ADD CONSTRAINT `boi_perms_ibfk_1`
  FOREIGN KEY (`user_id`) REFERENCES `users` (`id`);
ALTER TABLE `boi_perms`
  ADD CONSTRAINT `boi_perms_ibfk_2`
  FOREIGN KEY (`host_id`) REFERENCES `hosts` (`id`);

ALTER TABLE `callblocking`
  ADD CONSTRAINT `callblocking_ibfk_1`
  FOREIGN KEY (`user_id`) REFERENCES `users` (`id`);

ALTER TABLE `callforwards`
  ADD CONSTRAINT `callforwards_ibfk_1`
  FOREIGN KEY (`user_id`) REFERENCES `users` (`id`);

ALTER TABLE `callwaiting`
  ADD CONSTRAINT `callwaiting_ibfk_1`
  FOREIGN KEY (`user_id`) REFERENCES `users` (`id`);

ALTER TABLE `clir`
  ADD CONSTRAINT `clir_ibfk_1`
  FOREIGN KEY (`user_id`) REFERENCES `users` (`id`);

ALTER TABLE `conferences`
  ADD CONSTRAINT `conferences_ibfk_1`
  FOREIGN KEY (`host_id`) REFERENCES `hosts` (`id`);

ALTER TABLE `dial_log`
  ADD CONSTRAINT `dial_log_ibfk_1`
  FOREIGN KEY (`user_id`) REFERENCES `users` (`id`);

ALTER TABLE `gates`
  ADD CONSTRAINT `gates_ibfk_1`
  FOREIGN KEY (`grp_id`) REFERENCES `gate_grps` (`id`);

ALTER TABLE `host_params`
  ADD CONSTRAINT `host_params_ibfk_1`
  FOREIGN KEY (`host_id`) REFERENCES `hosts` (`id`)
  ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE `instant_messaging`
  ADD CONSTRAINT `instant_messaging_ibfk_1`
  FOREIGN KEY (`user_id`) REFERENCES `users` (`id`);

ALTER TABLE `pb_prv`
  ADD CONSTRAINT `pb_prv_ibfk_1`
  FOREIGN KEY (`user_id`) REFERENCES `users` (`id`);

ALTER TABLE `phones`
  ADD CONSTRAINT `phones_ibfk_1`
  FOREIGN KEY (`user_id`) REFERENCES `users` (`id`);

ALTER TABLE `pickupgroups_users`
  ADD CONSTRAINT `pickupgroups_users_ibfk_1`
  FOREIGN KEY (`group_id`) REFERENCES `pickupgroups` (`id`);
ALTER TABLE `pickupgroups_users`
  ADD CONSTRAINT `pickupgroups_users_ibfk_2`
  FOREIGN KEY (`user_id`) REFERENCES `users` (`id`);

ALTER TABLE `prov_params`
  ADD CONSTRAINT `prov_params_ibfk_1`
  FOREIGN KEY (`profile_id`) REFERENCES `prov_param_profiles` (`id`)
  ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE `queue_callforwards`
  ADD CONSTRAINT `queue_callforwards_ibfk_1`
  FOREIGN KEY (`queue_id`) REFERENCES `ast_queues` (`_id`);

ALTER TABLE `queue_log`
  ADD CONSTRAINT `queue_log_ibfk_1`
  FOREIGN KEY (`queue_id`) REFERENCES `ast_queues` (`_id`);

ALTER TABLE `ringtones`
  ADD CONSTRAINT `ringtones_ibfk_1`
  FOREIGN KEY (`user_id`) REFERENCES `users` (`id`);

ALTER TABLE `routes_in`
  ADD CONSTRAINT `routes_in_ibfk_1`
  FOREIGN KEY (`gate_grp_id`) REFERENCES `gate_grps` (`id`);

ALTER TABLE `softkeys`
  ADD CONSTRAINT `softkeys_ibfk_1`
  FOREIGN KEY (`profile_id`) REFERENCES `softkey_profiles` (`id`);

ALTER TABLE `user_groups`
  ADD CONSTRAINT `user_groups_ibfk_6`
  FOREIGN KEY (`prov_param_profile_id`) REFERENCES `prov_param_profiles` (`id`);
ALTER TABLE `user_groups`
  ADD CONSTRAINT `user_groups_ibfk_5`
  FOREIGN KEY (`softkey_profile_id`) REFERENCES `softkey_profiles` (`id`);

ALTER TABLE `users`
  ADD CONSTRAINT `users_ibfk_4`
  FOREIGN KEY (`softkey_profile_id`) REFERENCES `softkey_profiles` (`id`)
  ON DELETE SET NULL ON UPDATE SET NULL;
ALTER TABLE `users`
  ADD CONSTRAINT `users_ibfk_2`
  FOREIGN KEY (`group_id`) REFERENCES `user_groups` (`id`)
  ON DELETE SET NULL ON UPDATE SET NULL;
ALTER TABLE `users`
  ADD CONSTRAINT `users_ibfk_3`
  FOREIGN KEY (`host_id`) REFERENCES `hosts` (`id`);

ALTER TABLE `users_external_numbers`
  ADD CONSTRAINT `users_external_numbers_ibfk_1`
  FOREIGN KEY (`user_id`) REFERENCES `users` (`id`);

ALTER TABLE `vm`
  ADD CONSTRAINT `vm_ibfk_1`
  FOREIGN KEY (`user_id`) REFERENCES `users` (`id`);

ALTER TABLE `vm_msgs`
  ADD CONSTRAINT `vm_msgs_ibfk_1`
  FOREIGN KEY (`host_id`) REFERENCES `hosts` (`id`);
ALTER TABLE `vm_msgs`
  ADD CONSTRAINT `vm_msgs_ibfk_2`
  FOREIGN KEY (`user_id`) REFERENCES `users` (`id`);


--
-- since rev. 4804
--

USE `asterisk`;


--
-- Add new column `email_notify` in table `vm`:
--

ALTER TABLE `vm` ADD
  `email_notify` TINYINT(1) UNSIGNED NOT NULL default '0' AFTER `external_active`;


--
-- since rev. 4980
--

USE `asterisk`;


--
-- Add new column `prov_param_profile_id` in table `users`:
--

ALTER TABLE `users` ADD
  `prov_param_profile_id` INT UNSIGNED NULL AFTER `softkey_profile_id`;
ALTER TABLE `users` ADD
  INDEX `prov_param_profile_id` (`prov_param_profile_id`);
ALTER TABLE `users`
  ADD CONSTRAINT `users_ibfk_5`
  FOREIGN KEY (`prov_param_profile_id`) REFERENCES `prov_param_profiles` (`id`)
  ON DELETE SET NULL ON UPDATE SET NULL;


--
-- since rev. 5048
--

USE `asterisk`;


--
-- Add new column `firmware_cur` in table `phones`:
--

ALTER TABLE `phones` ADD
  `firmware_cur` VARCHAR(25) CHARACTER SET ascii COLLATE ascii_general_ci NOT NULL AFTER `added`;


--
-- since rev. 5063
--

USE `asterisk`;


--
-- Add new column `show_ext_modules` in table `user_groups`:
--

ALTER TABLE `user_groups` ADD
  `show_ext_modules` TINYINT(1) UNSIGNED NOT NULL DEFAULT '255' AFTER `prov_param_profile_id`;


--
-- since rev. 5082
--

USE `asterisk`;


--
-- Create new table `prov_jobs`:
--

CREATE TABLE IF NOT EXISTS `prov_jobs` (
  `id` int(10) unsigned NOT NULL auto_increment,
  `inserted` int(10) unsigned NOT NULL default '0',
  `running` tinyint(1) unsigned NOT NULL default '0',
  `trigger` enum('client','server') character set ascii NOT NULL default 'client',
  `phone_id` int(10) unsigned NOT NULL,
  `type` varchar(10) character set ascii NOT NULL default 'settings',
  `immediate` tinyint(1) unsigned NOT NULL default '0',
  `minute` varchar(20) character set ascii collate ascii_bin NOT NULL default '*',
  `hour` varchar(20) character set ascii collate ascii_bin NOT NULL default '*',
  `day` varchar(20) character set ascii collate ascii_bin NOT NULL default '*',
  `month` varchar(20) character set ascii collate ascii_bin NOT NULL default '*',
  `dow` varchar(20) character set ascii collate ascii_bin NOT NULL default '*',
  `data` varchar(100) character set ascii collate ascii_bin NOT NULL,
  PRIMARY KEY  (`id`),
  KEY `phone_id` (`phone_id`),
  KEY `immediate` (`immediate`),
  KEY `inserted` (`inserted`),
  KEY `type` (`type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


--
-- since rev. 5387
--

USE `asterisk`;


--
-- Add index for `remote_user_id` and foreign key constraint in table `dial_log`:
--

ALTER TABLE `dial_log`
  ADD INDEX `remote_user_id` (`remote_user_id`);
UPDATE `dial_log` SET `remote_user_id`=NULL
  WHERE `remote_user_id` NOT IN (SELECT `id` FROM `users`);
ALTER TABLE `dial_log`
  ADD CONSTRAINT `dial_log_ibfk_2`
  FOREIGN KEY (`remote_user_id`) REFERENCES `users` (`id`)
  ON DELETE SET NULL ON UPDATE SET NULL;


--
-- since rev. 5532
--

USE `asterisk`;


--
-- Alter the definer of the `ast_sipfriends_gs` view:
-- 
-- This view was previously defined by the `root`@`localhost` MySQL
-- user with SQL security "definer" but should be defined by the user
-- account of Gemeinschaft with SQL security "invoker".
-- Replace "gemeinschaft" with the account name you use
-- ( grep DB_MASTER_USER /etc/gemeinschaft/gemeinschaft.php ).
--

ALTER
  ALGORITHM=MERGE
  /*!50013 DEFINER=`gemeinschaft`@`localhost` */
  /*!50013 SQL SECURITY INVOKER */
  VIEW `ast_sipfriends_gs`
  AS (
    select `s`.`_user_id` AS `_user_id`,`s`.`name` AS `name`,`s`.`secret` AS `secret`,`s`.`type` AS `type`,`s`.`host` AS `host`,`s`.`defaultip` AS `defaultip`,`s`.`context` AS `context`,`s`.`callerid` AS `callerid`,`s`.`mailbox` AS `mailbox`,`s`.`callgroup` AS `callgroup`,`s`.`pickupgroup` AS `pickupgroup`,`s`.`setvar` AS `setvar`,`s`.`call-limit` AS `call-limit`,`s`.`subscribecontext` AS `subscribecontext`,`s`.`regcontext` AS `regcontext`,`s`.`ipaddr` AS `ipaddr`,`s`.`port` AS `port`,`s`.`regseconds` AS `regseconds`,`s`.`username` AS `username`,`s`.`regserver` AS `regserver`,`s`.`fullcontact` AS `fullcontact` from ((`ast_sipfriends` `s` join `users` `u` on((`u`.`id` = `s`.`_user_id`))) join `hosts` `h` on((`h`.`id` = `u`.`host_id`))) where (`h`.`is_foreign` = 0)
  )
  /*!50002 WITH CASCADED CHECK OPTION */
  ;


--
-- since rev. 5559
--

USE `asterisk`;


--
-- Resize column `name` in table `ast_sipfriends` for storing long dummy-user extensions:
--

ALTER TABLE `ast_sipfriends`
  CHANGE `name` `name` VARCHAR(16) CHARACTER SET ascii COLLATE ascii_general_ci NOT NULL;


--
-- since rev. 5626
--

USE `asterisk`;


--
-- Add new column `number_vml` in table `callforwards`,
-- add new option 'vml' to column `active`:
--

ALTER TABLE `callforwards`
  ADD COLUMN `number_vml` VARCHAR(20) CHARACTER SET ascii COLLATE ascii_general_ci NOT NULL AFTER `number_var`;
ALTER TABLE `callforwards`
  CHANGE `active` `active` ENUM('no','std','var','vml') CHARACTER SET ascii COLLATE ascii_general_ci NOT NULL DEFAULT 'no';


--
-- since rev. 5655
--

USE `asterisk`;


--
-- Add new column `fw_manual_update` in table `phones`
--

ALTER TABLE `phones`
  ADD COLUMN `fw_manual_update` TINYINT(1) unsigned NOT NULL default '0' AFTER `firmware_cur`;


--
-- since rev. 5699
--

USE `asterisk`;


--
-- Create new table `user_watchlist`:
--

CREATE TABLE IF NOT EXISTS `user_watchlist` (
  `user_id` int(10) unsigned NOT NULL,
  `buddy_user_id` int(10) unsigned NOT NULL,
  `status` ENUM('pnd','ack','nak') character set ascii COLLATE ascii_general_ci NOT NULL default 'pnd'
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;

ALTER TABLE `user_watchlist`
  ADD PRIMARY KEY (`user_id`,`buddy_user_id`);
ALTER TABLE `user_watchlist`
  ADD INDEX `buddy_user_id_user_id` (`buddy_user_id`,`user_id`);
ALTER TABLE `user_watchlist`
  ADD CONSTRAINT `user_watchlist_ibfk_1`
  FOREIGN KEY (`user_id`) REFERENCES `users` (`id`)
  ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE `user_watchlist`
  ADD CONSTRAINT `user_watchlist_ibfk_2`
  FOREIGN KEY (`buddy_user_id`) REFERENCES `users` (`id`)
  ON DELETE CASCADE ON UPDATE CASCADE;


--
-- since rev. 5839
--

USE `asterisk`;


--
-- Drop foreign key which references `ast_queues`(`_id`) in table
-- `user_watchlist` and add an index for `user_id`:
--

ALTER TABLE `queue_log` DROP FOREIGN KEY `queue_log_ibfk_1`;
ALTER TABLE `queue_log` ADD INDEX (`user_id`);


--
-- since rev. 6211
--

USE `asterisk`;


--
-- Add new column `user_grp_id` in table `routes`
--

ALTER TABLE `routes`
  ADD `user_grp_id` MEDIUMINT UNSIGNED NULL default NULL AFTER `h_to`;
ALTER TABLE `routes`
  ADD INDEX `user_grp_id` (`user_grp_id`);
ALTER TABLE `routes`
  ADD CONSTRAINT `routes_ibfk_1`
  FOREIGN KEY (`user_grp_id`)
  REFERENCES `user_groups` (`id`)
  ON DELETE CASCADE ON UPDATE CASCADE;

--
-- since rev. 6589
--

USE `asterisk`;


--
-- Add new column `proxy` in table `gates`
--

ALTER TABLE `gates`
  ADD `proxy` VARCHAR(50) CHARACTER SET utf8 COLLATE utf8_unicode_ci NULL DEFAULT NULL AFTER `host`;


--
-- since rev. 6642
--

USE `asterisk`;


--
-- Add new column `register` in table `gates`
--

ALTER TABLE `gates`   
  ADD `register` tinyint(1) unsigned NOT NULL default '1' AFTER `pwd`;


--
-- since rev. 6753
--

USE `asterisk`;


--
-- Add new table `gate_params`
--

CREATE TABLE IF NOT EXISTS `gate_params` (
 `gate_id` smallint(5) unsigned NOT NULL,
 `param` varchar(50) character set ascii NOT NULL,
 `value` varchar(255) collate utf8_unicode_ci NOT NULL,
 KEY `gate_id` (`gate_id`,`param`(20)),
 CONSTRAINT `gate_params_ibfk_1` FOREIGN KEY (`gate_id`) REFERENCES `gates` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;


--
-- since rev. 6862
--

USE `asterisk`;


--
-- Add new table `gate_cids`
--

CREATE TABLE IF NOT EXISTS `gate_cids` (
  `grp_id` smallint(5) unsigned NOT NULL,
  `cid_int` varchar(16) character set ascii NOT NULL,
  `cid_ext` varchar(30) character set ascii NOT NULL,
  PRIMARY KEY  (`grp_id`,`cid_int`),
  CONSTRAINT `gate_cids_ibfk_1` FOREIGN KEY (`grp_id`) REFERENCES `gate_grps` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;


--
-- since rev. 6979
--

USE `asterisk`;


--
-- Add new tables for group-based permissions:
--

CREATE TABLE IF NOT EXISTS `groups` (
  `id` mediumint(8) unsigned NOT NULL auto_increment,
  `name` varchar(20) character set ascii NOT NULL,
  `title` varchar(50) collate utf8_unicode_ci NOT NULL default '',
  `type` varchar(20) character set ascii NOT NULL default '',
  PRIMARY KEY  (`id`),
  UNIQUE KEY `name` (`name`),
  KEY `title` (`title`(25)),
  KEY `type` (`type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;

CREATE TABLE IF NOT EXISTS `group_members` (
  `group` mediumint(8) unsigned NOT NULL,
  `member` mediumint(8) unsigned NOT NULL,
  PRIMARY KEY  (`group`,`member`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;

CREATE TABLE IF NOT EXISTS `group_includes` (
  `group` mediumint(8) unsigned NOT NULL,
  `member` mediumint(8) unsigned NOT NULL,
  PRIMARY KEY  (`group`,`member`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;

CREATE TABLE IF NOT EXISTS `group_connections` (
  `type` varchar(20) character set ascii NOT NULL default '',
  `group` mediumint(8) unsigned NOT NULL,
  `key` varchar(20) character set ascii NOT NULL default 'id',
  `connection` varchar(255) collate utf8_unicode_ci NOT NULL default '',
  PRIMARY KEY  (`type`,`group`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;

CREATE TABLE IF NOT EXISTS `group_permissions` (
  `type` varchar(20) character set ascii NOT NULL default '',
  `group` mediumint(8) unsigned NOT NULL,
  `permit` mediumint(8) unsigned NOT NULL default '0',
  PRIMARY KEY  (`type`,`group`,`permit`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;


--
-- Use universal groups in routes instead of provisioning groups:
--

ALTER TABLE `routes`
  DROP FOREIGN KEY `routes_ibfk_1` ;

ALTER TABLE `routes`
  ADD CONSTRAINT `routes_ibfk_1`
  FOREIGN KEY (`user_grp_id`)
  REFERENCES `groups` (`id`)
  ON DELETE CASCADE ON UPDATE CASCADE;


--
-- ? (unused table):
--

/*
CREATE TABLE IF NOT EXISTS `blacklist` (
  `id` mediumint(8) unsigned NOT NULL auto_increment,
  `group_id` mediumint(8) unsigned default NULL,
  `type` enum('in','out','both') character set ascii NOT NULL default 'out',
  `comment` varchar(40) collate utf8_unicode_ci NOT NULL default '',
  `name` varchar(40) collate utf8_unicode_ci NOT NULL default '',
  `number` varchar(30) character set ascii NOT NULL default '',
  PRIMARY KEY  (`id`),
  UNIQUE KEY `group_number` (`group_id`, `number`),
  CONSTRAINT `blacklist_ibfk_1` FOREIGN KEY (`group_id`) REFERENCES `groups` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
*/


--
-- since rev. 7059
--

USE `asterisk`;


--
-- Table structure for table `cf_timerules`
--

CREATE TABLE IF NOT EXISTS `cf_timerules` (
  `id` int(10) unsigned NOT NULL auto_increment,
  `ord` int(10) unsigned NOT NULL,
  `_user_id` int(10) unsigned NOT NULL,
  `d_mo` tinyint(1) unsigned NOT NULL default '1',
  `d_tu` tinyint(1) unsigned NOT NULL default '1',
  `d_we` tinyint(1) unsigned NOT NULL default '1',
  `d_th` tinyint(1) unsigned NOT NULL default '1',
  `d_fr` tinyint(1) unsigned NOT NULL default '1',
  `d_sa` tinyint(1) unsigned NOT NULL default '1',
  `d_su` tinyint(1) unsigned NOT NULL default '1',
  `h_from` time NOT NULL default '00:00:00',
  `h_to` time NOT NULL default '24:00:00',
  `target` varchar(20) character set ascii NOT NULL,
  PRIMARY KEY  (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;


--
-- Table structure for table `vm_rec_messages`
--

CREATE TABLE IF NOT EXISTS `vm_rec_messages` (
  `id` int(10) unsigned NOT NULL auto_increment,
  `_user_id` int(10) unsigned NOT NULL default '0',
  `vm_rec_file` varchar(80) character set utf8 collate utf8_unicode_ci NOT NULL,
  `vm_comment` varchar(180) character set utf8 collate utf8_unicode_ci NOT NULL,
  PRIMARY KEY  (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


--
-- add new option 'trl' to column `active`:
--

ALTER TABLE `callforwards`
  CHANGE `active` `active` ENUM('no','std','var','vml','trl','par') CHARACTER SET ascii COLLATE ascii_general_ci NOT NULL DEFAULT 'no';
ALTER TABLE `callforwards`
  ADD COLUMN `vm_rec_id` int(10) unsigned default NULL AFTER `number_vml`;


--
-- Table structure for table `queue_cf_timerules`
--

CREATE TABLE IF NOT EXISTS `queue_cf_timerules` (
  `id` int(10) unsigned NOT NULL auto_increment,
  `_queue_id` int(10) unsigned NOT NULL,
  `ord` int(10) unsigned NOT NULL,
  `d_mo` tinyint(1) unsigned NOT NULL default '1',
  `d_tu` tinyint(1) unsigned NOT NULL default '1',
  `d_we` tinyint(1) unsigned NOT NULL default '1',
  `d_th` tinyint(1) unsigned NOT NULL default '1',
  `d_fr` tinyint(1) unsigned NOT NULL default '1',
  `d_sa` tinyint(1) unsigned NOT NULL default '1',
  `d_su` tinyint(1) unsigned NOT NULL default '1',
  `h_from` time NOT NULL default '00:00:00',
  `h_to` time NOT NULL default '24:00:00',
  `target` varchar(20) character set ascii NOT NULL,
  PRIMARY KEY  (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;


--
-- Table structure for table `queue_vm_rec_messages`
--

CREATE TABLE IF NOT EXISTS `queue_vm_rec_messages` (
  `id` int(10) unsigned NOT NULL auto_increment,
  `_queue_id` int(10) unsigned NOT NULL default '0',
  `vm_rec_file` varchar(80) character set utf8 collate utf8_unicode_ci NOT NULL,
  `vm_comment` varchar(180) character set utf8 collate utf8_unicode_ci NOT NULL,
  PRIMARY KEY  (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

--
-- add new option 'trl' and 'vml' to column `active`:
--

ALTER TABLE `queue_callforwards`
  CHANGE `active` `active` ENUM('no','std','var','vml','trl','par') CHARACTER SET ascii COLLATE ascii_general_ci NOT NULL DEFAULT 'no';
ALTER TABLE `queue_callforwards`
  ADD COLUMN `vm_rec_id` int(10) unsigned default NULL AFTER `number_var`;
ALTER TABLE `queue_callforwards`
  ADD COLUMN `number_vml` VARCHAR(20) CHARACTER SET ascii COLLATE ascii_general_ci NOT NULL AFTER `number_var`;


--
-- Table structure for table `cf_parallelcall`
--

CREATE TABLE IF NOT EXISTS `cf_parallelcall` (
  `id` int(10) unsigned NOT NULL auto_increment,
  `_user_id` int(10) unsigned NOT NULL default '0',
  `number` varchar(20) character set ascii NOT NULL,
  PRIMARY KEY  (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


--
-- Table structure for table `queue_cf_parallelcall`
--

CREATE TABLE IF NOT EXISTS `queue_cf_parallelcall` (
  `id` int(10) unsigned NOT NULL auto_increment,
  `_queue_id` int(10) unsigned NOT NULL default '0',
  `number` varchar(20) character set ascii NOT NULL,
  PRIMARY KEY  (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


--
-- since rev. 7064
--

USE `asterisk`;


--
-- Sample config for group system:
--

INSERT INTO `groups` VALUES (NULL,'admins','Admins','user');
INSERT INTO `groups` VALUES (NULL,'users','All Users','user');
INSERT INTO `groups` VALUES (NULL,'hosts','All Hosts','host');
INSERT INTO `groups` VALUES (NULL,'queues','All Queues','queue');
INSERT INTO `groups` VALUES (NULL,'user_gui','User GUI','module_gui');
INSERT INTO `groups` VALUES (NULL,'admin_gui','Admin GUI','module_gui');

INSERT INTO `group_connections` VALUES ('mysql',(SELECT `id` FROM `groups` WHERE `name` = 'users' LIMIT 1),'id','SELECT `id` FROM `users` WHERE `nobody_index` IS NULL');
INSERT INTO `group_connections` VALUES ('mysql',(SELECT `id` FROM `groups` WHERE `name` = 'hosts' LIMIT 1),'id','SELECT `id` FROM `hosts` WHERE `host` != \'\'');
INSERT INTO `group_connections` VALUES ('mysql',(SELECT `id` FROM `groups` WHERE `name` = 'queues' LIMIT 1),'id','SELECT `_id` AS `id` FROM `ast_queues`');

INSERT INTO `group_permissions` VALUES ('call_stats',(SELECT `id` FROM `groups` WHERE `name` = 'users' LIMIT 1),(SELECT `id` FROM `groups` WHERE `name` = 'users' LIMIT 1));
INSERT INTO `group_permissions` VALUES ('call_stats',(SELECT `id` FROM `groups` WHERE `name` = 'users' LIMIT 1),(SELECT `id` FROM `groups` WHERE `name` = 'queues' LIMIT 1));
INSERT INTO `group_permissions` VALUES ('forward_queues',(SELECT `id` FROM `groups` WHERE `name` = 'users' LIMIT 1),(SELECT `id` FROM `groups` WHERE `name` = 'queues' LIMIT 1));
INSERT INTO `group_permissions` VALUES ('phonebook_user',(SELECT `id` FROM `groups` WHERE `name` = 'users' LIMIT 1),(SELECT `id` FROM `groups` WHERE `name` = 'users' LIMIT 1));
INSERT INTO `group_permissions` VALUES ('sudo_user',(SELECT `id` FROM `groups` WHERE `name` = 'admins' LIMIT 1),(SELECT `id` FROM `groups` WHERE `name` = 'users' LIMIT 1));
INSERT INTO `group_permissions` VALUES ('display_module_gui',(SELECT `id` FROM `groups` WHERE `name` = 'admins' LIMIT 1),(SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1));
INSERT INTO `group_permissions` VALUES ('display_module_gui',(SELECT `id` FROM `groups` WHERE `name` = 'users' LIMIT 1),(SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1));

INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),1000);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),1001);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),2000);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),2001);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),3000);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),3001);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),3002);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),3003);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),3004);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),4000);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),4001);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),4002);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),4003);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),5000);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),5001);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),6000);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),6001);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),6002);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),7000);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),7001);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),7002);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),7003);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),8000);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),8001);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),9000);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),9001);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),10000);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),10001);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),11000);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),11001);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),11002);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),11003);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),11004);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),11005);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),12000);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),12001);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),12002);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),12003);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),12004);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),13000);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),13001);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),14000);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),14001);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),14002);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),14003);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),19000);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),19001);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),6003);         
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),15000);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),15001);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),15002);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),15003);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),15004);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),15005);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),15006);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),15007);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),15008);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),15009);        
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),15010);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),15011);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),15012);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),16000);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),16001);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),16002);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),16003);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),16004);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),16005);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),17000);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),17001);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),17002);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),17003);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),17004);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),17005);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),17006);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),17007);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),17008);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),18000);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),18001);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),18002);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),18003);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),18004);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),18005);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),18006);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),18007);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),18008);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),18009);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),18010);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),18011);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),18012);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),18013);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),18014);
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),18015);


--
-- Since: 7107
--

use `asterisk`;

--
-- Neues Module queues
--

INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'user_gui' LIMIT 1),4004);


--
-- Tabelle dial_log für type=queue umbauen
--

ALTER TABLE `dial_log` CHANGE `type` `type` ENUM( 'in', 'out', 'missed', 'queue' ) CHARACTER SET ascii COLLATE ascii_general_ci NOT NULL DEFAULT 'out';

-- 
-- Since: master-20100408-6cf8831
--

--
-- ast_queue_members für statische Agenten erweitern
--
ALTER TABLE `ast_queue_members` ADD column `static` boolean default '0' after `penalty`;


--
-- Since: ?
--

--
-- "PCI-Karten" und "ISDN-Ports" aus GUI entfernt. 
--
DELETE FROM `group_members` WHERE `group` = (SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1) AND `member` = 18009;
DELETE FROM `group_members` WHERE `group` = (SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1) AND `member` = 18010;
DELETE FROM `group_members` WHERE `group` = (SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1) AND `member` = 18011;


--
-- since rev. ?
--

USE `asterisk`;


--
-- Add new column `_sysrec_id` in table `ast_queues`:
--

ALTER TABLE `ast_queues` ADD column `_sysrec_id` int(10) unsigned NOT NULL default '0' AFTER `musicclass`;

--
-- Create new table `systemrecordings`:
--

CREATE TABLE IF NOT EXISTS `systemrecordings` (
  `id` int(10) unsigned NOT NULL auto_increment,
  `date` timestamp NOT NULL default CURRENT_TIMESTAMP,
  `md5hashname` char(32) collate utf8_unicode_ci NOT NULL,
  `description` varchar(150) collate utf8_unicode_ci NOT NULL,
  `length` int(10) unsigned NOT NULL,
  PRIMARY KEY  (`id`),
  KEY `md5hashname` (`md5hashname`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;


--
-- since rev. ?
--

USE `asterisk`;

--
-- Add member 'IAX-Gateways' to group 'admin_gui':
--

INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),17009);


--
-- since rev. ?
--

USE `asterisk`;

--
-- Add permission 'pickup' and 'secretary' for group users on group users:
--

INSERT INTO `group_permissions` VALUES ('pickup',(SELECT `id` FROM `groups` WHERE `name` = 'users' LIMIT 1),(SELECT `id` FROM `groups` WHERE `name` = 'users' LIMIT 1));
INSERT INTO `group_permissions` VALUES ('secretary',(SELECT `id` FROM `groups` WHERE `name` = 'users' LIMIT 1),(SELECT `id` FROM `groups` WHERE `name` = 'users' LIMIT 1));



-- Since: Asterisk 1.6
--

alter table `ast_sipfriends`, add column `accountcode` varchar(20) NULL default NULL;
alter table `ast_sipfriends`, add column `allowtransfer` varchar(20) NULL default NULL;
alter table `ast_sipfriends`, add column `allow` varchar(20) NULL default NULL;
alter table `ast_sipfriends`, add column `amaflags` varchar(20) NULL default NULL;
alter table `ast_sipfriends`, add column `auth` varchar(10) NULL default NULL;
alter table `ast_sipfriends`, add column `autoframing` varchar(10) NULL default NULL;
alter table `ast_sipfriends`, add column `callingpres` varchar(20) NULL default NULL;
alter table `ast_sipfriends`, add column `cid_number` varchar(40) NULL default NULL;
alter table `ast_sipfriends`, add column `defaultuser` varchar(40) NULL default NULL;
alter table `ast_sipfriends`, add column `disallow` varchar(20) NULL default NULL;
alter table `ast_sipfriends`, add column `fromdomain` varchar(40) NULL default NULL;
alter table `ast_sipfriends`, add column `fromuser` varchar(40) NULL default NULL;
alter table `ast_sipfriends`, add column `incominglimit` varchar(10) NULL default NULL;
alter table `ast_sipfriends`, add column `insecure` varchar(20) NULL default NULL;
alter table `ast_sipfriends`, add column `language` varchar(10) NULL default NULL;
alter table `ast_sipfriends`, add column `lastms` int(11) NOT NULL default -1;
alter table `ast_sipfriends`, add column `maxcallbitrate` varchar(15) NULL default NULL;
alter table `ast_sipfriends`, add column `md5secret` varchar(40) NULL default NULL;
alter table `ast_sipfriends`, add column `mohsuggest` varchar(20) NULL default NULL;
alter table `ast_sipfriends`, add column `musicclass` varchar(20) NULL default NULL;
alter table `ast_sipfriends`, add column `outboundproxy` varchar(40) NULL default NULL;
alter table `ast_sipfriends`, add column `qualify` varchar(15) NULL default NULL;
alter table `ast_sipfriends`, add column `regexten` varchar(20) NULL default NULL;
alter table `ast_sipfriends`, add column `rtpholdtimeout` varchar(15) NULL default NULL;
alter table `ast_sipfriends`, add column `rtpkeepalive` varchar(15) NULL default NULL;
alter table `ast_sipfriends`, add column `rtptimeout` varchar(15) NULL default NULL;
alter table `ast_sipfriends`, add column `subscribemwi` varchar(10) NULL default NULL;
alter table `ast_sipfriends`, add column `usereqphone` varchar(10) NULL default NULL;
alter table `ast_sipfriends`, add column `vmexten` varchar(20) NULL default NULL;
alter table `ast_sipfriends`, add column `useragent` varchar(20) collate latin1_general_ci default NULL;
alter table `ast_sipfriends`, change `regseconds` `regseconds` bigint  NOT NULL;

alter table `ast_queue_members`, drop PRIMARY KEY;
alter table `ast_queue_members`, add column `uniqueid` int(100) unsigned NOT NULL auto_increment, ADD PRIMARY KEY (uniqueid);
alter table `ast_queue_members`, add   UNIQUE KEY `queue_name_interface` (`queue_name`,`interface`);
alter table `ast_queue_members` add column `paused` int(1) default NULL;

alter table `ast_voicemail` add column `uniqueid` varchar(11) collate latin1_general_ci default NULL;

drop VIEW `ast_sipfriends_gs`;
CREATE ALGORITHM=MERGE DEFINER=`root`@`localhost` SQL SECURITY INVOKER VIEW `ast_sipfriends_gs` AS (select `s`.`_user_id` AS `_user_id`, `s`.`name` AS `name`,`s`.`secret` AS `secret`,`s`.`type` AS `type`,`s`.`host` AS `host`,`s`.`defaultip` AS `defaultip`,`s`.`context` AS `context`,`s`.`callerid` AS `callerid`,`s`.`mailbox` AS `mailbox`,`s`.`callgroup` AS `callgroup`,`s`.`pickupgroup` AS `pickupgroup`,`s`.`setvar` AS `setvar`,`s`.`call-limit` AS `call-limit`,`s`.`subscribecontext` AS `subscribecontext`,`s`.`regcontext` AS `regcontext`,`s`.`ipaddr` AS `ipaddr`,`s`.`port` AS `port`,`s`.`regseconds` AS `regseconds`,`s`.`username` AS `username`,`s`.`regserver` AS `regserver`,`s`.`fullcontact` AS `fullcontact`,`s`.`accountcode` AS `accountcode`,`s`.`allowtransfer` AS `allowtransfer`,`s`.`allow` AS `allow`,`s`.`amaflags` AS `amaflags`,`s`.`auth` AS `auth`,`s`.`autoframing` AS `autoframing`,`s`.`callingpres` AS `callingpres`,`s`.`cid_number` AS `cid_number`,`s`.`defaultuser` AS `defaultuser`,`s`.`fromdomain` AS `fromdomain`,`s`.`fromuser` AS `fromuser`,`s`.`incominglimit` AS `incominglimit`,`s`.`insecure` AS `insecure`,`s`.`language` AS `language`,`s`.`lastms` AS `lastms`,`s`.`maxcallbitrate` AS `maxcallbitrate`,`s`.`md5secret` AS `md5secret`,`s`.`mohsuggest` AS `mohsuggest`,`s`.`musicclass` AS `musicclass`,`s`.`outboundproxy` AS `outboundproxy`,`s`.`qualify` AS `qualify`,`s`.`regexten` AS `regexten`,`s`.`rtpholdtimeout` AS `rtpholdtimeout`,`s`.`rtpkeepalive` AS `rtpkeepalive`,`s`.`rtptimeout` AS `rtptimeout`,`s`.`subscribemwi` AS `subscribemwi`,`s`.`usereqphone` AS `usereqphone`,`s`.`vmexten` AS `vmexten`,`s`.`disallow` AS `disallow`, `s`.`useragent` AS `useragent` from ((`ast_sipfriends` `s` join `users` `u` on((`u`.`id` = `s`.`_user_id`))) join `hosts` `h` on((`h`.`id` = `u`.`host_id`))) where (`h`.`is_foreign` = 0)) WITH CASCADED CHECK OPTION

CREATE TABLE IF NOT EXISTS `ivrs` (
  `id` int(11) NOT NULL auto_increment,
  `name` varchar(20) collate utf8_unicode_ci NOT NULL,
  `host_id` mediumint(8) unsigned NOT NULL default '1',
  `title` varchar(255) collate utf8_unicode_ci NOT NULL,
  `announcement` varchar(255) collate utf8_unicode_ci NOT NULL,
  `timeout` tinyint(3) collate utf8_unicode_ci NOT NULL,
  `retry` tinyint (3) collate utf8_unicode_ci NOT NULL,
  `key_0_type` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_0_value` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_1_type` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_1_value` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_2_type` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_2_value` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_3_type` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_3_value` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_4_type` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_4_value` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_5_type` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_5_value` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_6_type` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_6_value` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_7_type` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_7_value` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_8_type` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_8_value` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_9_type` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_9_value` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_star_type` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_star_value` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_pound_type` varchar(20) collate utf8_unicode_ci NOT NULL,
  `key_pound_value` varchar(20) collate utf8_unicode_ci NOT NULL,
  `t_action_type` varchar(20) collate utf8_unicode_ci NOT NULL,
  `t_action_value` varchar(20) collate utf8_unicode_ci NOT NULL,
  `i_action_type` varchar(20) collate utf8_unicode_ci NOT NULL,
  `i_action_value` varchar(20) collate utf8_unicode_ci NOT NULL,
  PRIMARY KEY  (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci ;

--
-- Since: Penalties 
--
alter table `ast_queue_members`, change `penalty` `penalty` tinyint(3) unsigned NOT NULL default '5';

 CREATE TABLE `penalties` (
  `_queue_id` int(10) unsigned NOT NULL,
  `_user_id` int(10) unsigned NOT NULL,
  `_host_id` mediumint(8) unsigned NOT NULL,
  `penalty` int(1) NOT NULL,
  PRIMARY KEY  (`_queue_id`,`_user_id`,`_host_id`),
  KEY `penaltys_ibfk_2` (`_user_id`),
  KEY `penaltys_ibfk_3` (`_host_id`),
  CONSTRAINT `penalties_ibfk_1` FOREIGN KEY (`_queue_id`) REFERENCES `ast_queues` (`_id`) ON DELETE CASCADE,
  CONSTRAINT `penalties_ibfk_2` FOREIGN KEY (`_user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `penalties_ibfk_3` FOREIGN KEY (`_host_id`) REFERENCES `hosts` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_general_ci


--
-- After: 0027f06a5f07c37b4cf4
-- 

INSERT INTO `group_permissions` VALUES ('login_queues',(SELECT `id` FROM `groups` WHERE `name` = 'users' LIMIT 1),(SELECT `id` FROM `groups` WHERE `name` = 'queues' LIMIT 1));
INSERT INTO `group_members` VALUES ((SELECT `id` FROM `groups` WHERE `name` = 'admin_gui' LIMIT 1),6004);


--
-- Minimum Anzahl Agents/Queue 2d47e80..d2716d5
--

alter table ast_queues add `_min_agents` int(10) NOT NULL default 0;

--
-- After: Wakeup Calls 
--
 CREATE TABLE IF NOT EXISTS `wakeup_calls` (
 `target` VARCHAR( 16 ) CHARACTER SET ascii COLLATE ascii_general_ci NOT NULL ,
 `hour` TINYINT( 2 ) UNSIGNED NOT NULL ,
 `minute` TINYINT( 2 ) UNSIGNED NOT NULL ,
 PRIMARY KEY ( `target` )
 ) ENGINE = MYISAM


--
-- After: 0819b3d3ce9e37e3f026
--

UPDATE `group_permissions` SET `type`='secretary_call' WHERE `type`='secretary';
UPDATE `group_permissions` SET `type`='intercom_call' WHERE `type`='intercom';

--
-- After: Realtime Monitor 
--
DROP TABLE IF EXISTS `monitor`;
SET character_set_client = utf8;
CREATE TABLE `monitor` (
  `user_id` int(10) unsigned NOT NULL,
  `type` tinyint(2) unsigned NOT NULL default '1',
  `display_x` smallint(4) unsigned NOT NULL default '0',
  `display_y` smallint(4) unsigned NOT NULL default '0',
  `columns` tinyint(2) unsigned NOT NULL default '2',
  `update` smallint(4) unsigned NOT NULL default '2',
  `reload` smallint(4) unsigned NOT NULL default '2',
  PRIMARY KEY  (`user_id`, `type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8  COLLATE=utf8_unicode_ci;

DROP TABLE IF EXISTS `monitor_colors`;
SET character_set_client = utf8;
CREATE TABLE `monitor_colors` (
  `user_id` int(10) unsigned NOT NULL,
  `type` tinyint(2) unsigned NOT NULL default '1',
  `status` tinyint(3) unsigned NOT NULL default '2',
  `color` varchar(20) collate utf8_unicode_ci NOT NULL default '#fff',
  PRIMARY KEY  (`user_id`, `type`, `status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8  COLLATE=utf8_unicode_ci;

DROP TABLE IF EXISTS `monitor_queues`;
SET character_set_client = utf8;
CREATE TABLE `monitor_queues` (
  `user_id` int(10) unsigned NOT NULL,
  `queue_id` int(10) unsigned NOT NULL,
  `active` tinyint(1) unsigned NOT NULL default '1',
  `display_columns` tinyint(2) unsigned NOT NULL default '2',
  `display_width` smallint(4) unsigned NOT NULL default '500',
  `display_height` smallint(4) unsigned NOT NULL default '150',
  `display_calls` smallint(5) unsigned NOT NULL default '15',
  `display_answered` smallint(5) unsigned NOT NULL default '15',
  `display_abandoned` smallint(5) unsigned NOT NULL default '15',
  `display_timeout` smallint(5) unsigned NOT NULL default '15',
  `display_wait_max` smallint(5) unsigned NOT NULL default '15',
  `display_wait_min` smallint(5) unsigned NOT NULL default '15',
  `display_wait_avg` smallint(5) unsigned NOT NULL default '15',
  `display_call_max` smallint(5) unsigned NOT NULL default '15',
  `display_call_min` smallint(5) unsigned NOT NULL default '15',
  `display_call_avg` smallint(5) unsigned NOT NULL default '15',
  `display_extension` smallint(5) unsigned NOT NULL default '0',
  `display_name` smallint(5) unsigned NOT NULL default '4',			       
  PRIMARY KEY  (`user_id`, `queue_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8  COLLATE=utf8_unicode_ci;

DROP TABLE IF EXISTS `monitor_groups`;
CREATE TABLE `monitor_groups` (
  `user_id` int(10) unsigned NOT NULL,
  `group_id` int(10) unsigned NOT NULL,
  `active` tinyint(1) unsigned NOT NULL default '1',
  `display_columns` tinyint(2) unsigned NOT NULL default '2',
  `display_width` smallint(4) unsigned NOT NULL default '500',
  `display_height` smallint(4) unsigned NOT NULL default '150',
  `display_extension` smallint(5) unsigned NOT NULL default '2',
  `display_name` smallint(5) unsigned NOT NULL default '4',
  `display_forw` smallint(5) unsigned NOT NULL default '3',
  `display_comment` smallint(5) unsigned NOT NULL default '0',
  PRIMARY KEY  (`user_id`, `group_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8  COLLATE=utf8_unicode_ci;


--
-- After: 0abbe0e728149d5d8343c761f15be21d66b2ef42 (private_call)
--

INSERT INTO `group_permissions` VALUES ('private_call',(SELECT `id` FROM `groups` WHERE `name` = 'users' LIMIT 1),(SELECT `id` FROM `groups` WHERE `name` = 'users' LIMIT 1));


--
-- After: b80bd254fd443778893dc725120db981252298a8 (new group nobody_users)
--

INSERT INTO `groups` VALUES (NULL,'nobody_users','All Nobody Users','user');
INSERT INTO `group_connections` VALUES ('mysql',(SELECT `id` FROM `groups` WHERE `name` = 'nobody_users' LIMIT 1),'id','SELECT `id` FROM `users` WHERE `nobody_index` IS NOT NULL');
INSERT INTO `group_permissions` VALUES ('phonebook_user',(SELECT `id` FROM `groups` WHERE `name` = 'nobody_users' LIMIT 1),(SELECT `id` FROM `groups` WHERE `name` = 'users' LIMIT 1));

--
-- After: 1a47844d99b09ad5f9c2c4bf65deb3caddac98af
--

ALTER TABLE `group_permissions` CHANGE `type` `type` VARCHAR( 25 ) CHARACTER SET ascii COLLATE ascii_general_ci NOT NULL 
UPDATE `group_permissions` SET `type`='override_callforward_call' WHERE `type`='secretary_call';
